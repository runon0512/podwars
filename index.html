<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>2D Scroll Battle</title>
    <style>
        body { margin: 0; overflow: hidden; background: #1a1a1a; touch-action: none; user-select: none; }
        canvas { display: block; }
        #nameInput { user-select: text; pointer-events: auto; }
    </style>
</head>
<body>
<canvas id="gameCanvas"></canvas>
<div id="editorUI" style="display:none; position:absolute; top:10px; left:10px; background:rgba(0,0,0,0.6); padding:10px; color:white; border-radius:8px; pointer-events:auto;">
    <div>Tool: <span id="toolName">Block</span></div>
    <div style="margin:5px 0;">Color: <input type="color" id="colorPicker" value="#8d4433" onchange="setColor(this.value)"></div>
    <button onclick="setTool(0)">Block</button> <button onclick="setTool(1)">Platform</button>
    <button onclick="setTool(2)">Fence</button> <button onclick="setTool(-1)">Erase</button>
    <br><span style="font-size:12px">Spawn:</span>
    <button onclick="setTool(10)">1</button> <button onclick="setTool(11)">2</button> <button onclick="setTool(12)">3</button> <button onclick="setTool(13)">4</button>
    <hr style="margin:5px 0; border-color:#555;">
    <button onclick="saveMap()">Save Code</button> <button onclick="loadMap()">Load Code</button><br>
    <textarea id="mapOutput" style="width:200px; height:40px; margin-top:5px; background:#333; color:#fff; border:1px solid #555;"></textarea>
</div>
<button id="modeBtn" style="position:absolute; top:10px; right:10px; padding:10px; background:#333; color:#fff; border:1px solid #fff; border-radius:4px;" onclick="toggleMode()">Edit Mode</button>

<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');

canvas.width = window.innerWidth;
canvas.height = window.innerHeight;

// --- Ë®≠ÂÆö ---
const GRAVITY = 0.5;
const JUMP_FORCE = -12;
const SPEED = 5;
const BULLET_SPEED = 7.5;
const WORLD_WIDTH = 2000; // „Éû„ÉÉ„Éó„ÅÆÊ®™ÂπÖ
const WORLD_HEIGHT = 1000; // „Éû„ÉÉ„Éó„ÅÆÁ∏¶ÂπÖ
const TILE_SIZE = 50;

// --- Âú∞ÂΩ¢„Éá„Éº„Çø ---
// type: 0=„Éñ„É≠„ÉÉ„ÇØ, 1=Âè∞(‰∏ã„Åã„ÇâÈÄö„Çå„Çã), 2=Êüµ(Âºæ„ÅåÈÄö„Çã)
let platforms = [];
let gamePlatforms = [];
let loadingPlatforms = [];
let simPlatforms = [];
function initMap() {
    const baseMap = [{"x":50,"y":800,"w":50,"h":50,"type":0,"color":"#828282"},{"x":100,"y":800,"w":50,"h":50,"type":0,"color":"#828282"},{"x":150,"y":800,"w":50,"h":50,"type":0,"color":"#828282"},{"x":200,"y":800,"w":50,"h":50,"type":0,"color":"#828282"},{"x":250,"y":800,"w":50,"h":50,"type":0,"color":"#828282"},{"x":300,"y":800,"w":50,"h":50,"type":0,"color":"#828282"},{"x":350,"y":800,"w":50,"h":50,"type":2,"color":"#ffffff"},{"x":500,"y":800,"w":50,"h":50,"type":2,"color":"#ffffff"},{"x":550,"y":800,"w":50,"h":50,"type":0,"color":"#828282"},{"x":600,"y":800,"w":50,"h":50,"type":0,"color":"#828282"},{"x":650,"y":800,"w":50,"h":50,"type":0,"color":"#828282"},{"x":700,"y":800,"w":50,"h":50,"type":0,"color":"#828282"},{"x":750,"y":800,"w":50,"h":50,"type":0,"color":"#828282"},{"x":800,"y":800,"w":50,"h":50,"type":0,"color":"#828282"},{"x":850,"y":800,"w":50,"h":50,"type":0,"color":"#828282"},{"x":0,"y":800,"w":50,"h":50,"type":0,"color":"#828282"},{"x":0,"y":850,"w":50,"h":50,"type":0,"color":"#828282"},{"x":50,"y":850,"w":50,"h":50,"type":0,"color":"#828282"},{"x":100,"y":850,"w":50,"h":50,"type":0,"color":"#828282"},{"x":150,"y":850,"w":50,"h":50,"type":0,"color":"#828282"},{"x":200,"y":850,"w":50,"h":50,"type":0,"color":"#828282"},{"x":250,"y":850,"w":50,"h":50,"type":0,"color":"#828282"},{"x":300,"y":850,"w":50,"h":50,"type":0,"color":"#828282"},{"x":350,"y":850,"w":50,"h":50,"type":0,"color":"#828282"},{"x":400,"y":850,"w":50,"h":50,"type":2,"color":"#ffffff"},{"x":450,"y":850,"w":50,"h":50,"type":2,"color":"#ffffff"},{"x":500,"y":850,"w":50,"h":50,"type":0,"color":"#828282"},{"x":550,"y":850,"w":50,"h":50,"type":0,"color":"#828282"},{"x":600,"y":850,"w":50,"h":50,"type":0,"color":"#828282"},{"x":650,"y":850,"w":50,"h":50,"type":0,"color":"#828282"},{"x":700,"y":850,"w":50,"h":50,"type":0,"color":"#828282"},{"x":750,"y":850,"w":50,"h":50,"type":0,"color":"#828282"},{"x":800,"y":850,"w":50,"h":50,"type":0,"color":"#828282"},{"x":850,"y":850,"w":50,"h":50,"type":0,"color":"#828282"},{"x":400,"y":800,"w":50,"h":50,"type":2,"color":"#ffffff"},{"x":450,"y":800,"w":50,"h":50,"type":2,"color":"#ffffff"},{"x":850,"y":750,"w":50,"h":50,"type":2,"color":"#ffffff"},{"x":850,"y":700,"w":50,"h":50,"type":2,"color":"#ffffff"},{"x":850,"y":650,"w":50,"h":50,"type":2,"color":"#ffffff"},{"x":850,"y":600,"w":50,"h":50,"type":2,"color":"#ffffff"},{"x":850,"y":550,"w":50,"h":50,"type":2,"color":"#ffffff"},{"x":850,"y":500,"w":50,"h":50,"type":2,"color":"#ffffff"},{"x":0,"y":750,"w":50,"h":50,"type":2,"color":"#ffffff"},{"x":0,"y":700,"w":50,"h":50,"type":2,"color":"#ffffff"},{"x":0,"y":650,"w":50,"h":50,"type":2,"color":"#ffffff"},{"x":0,"y":600,"w":50,"h":50,"type":2,"color":"#ffffff"},{"x":0,"y":550,"w":50,"h":50,"type":2,"color":"#ffffff"},{"x":0,"y":500,"w":50,"h":50,"type":2,"color":"#ffffff"},{"x":800,"y":650,"w":50,"h":50,"type":1,"color":"#d1ca00"},{"x":700,"y":650,"w":50,"h":50,"type":1,"color":"#d1ca00"},{"x":100,"y":650,"w":50,"h":50,"type":1,"color":"#d1ca00"},{"x":50,"y":650,"w":50,"h":50,"type":1,"color":"#0d0d0d"},{"x":150,"y":650,"w":50,"h":50,"type":1,"color":"#0d0d0d"},{"x":750,"y":650,"w":50,"h":50,"type":1,"color":"#0d0d0d"},{"x":800,"y":500,"w":50,"h":50,"type":1,"color":"#0d0d0d"},{"x":700,"y":500,"w":50,"h":50,"type":1,"color":"#0d0d0d"},{"x":100,"y":500,"w":50,"h":50,"type":1,"color":"#0d0d0d"},{"x":150,"y":500,"w":50,"h":50,"type":1,"color":"#d1ca00"},{"x":50,"y":500,"w":50,"h":50,"type":1,"color":"#d1ca00"},{"x":750,"y":500,"w":50,"h":50,"type":1,"color":"#d1ca00"},{"x":850,"y":450,"w":50,"h":50,"type":2,"color":"#ffffff"},{"x":850,"y":400,"w":50,"h":50,"type":2,"color":"#ffffff"},{"x":0,"y":450,"w":50,"h":50,"type":2,"color":"#ffffff"},{"x":0,"y":400,"w":50,"h":50,"type":2,"color":"#ffffff"},{"x":0,"y":350,"w":50,"h":50,"type":2,"color":"#ffffff"},{"x":0,"y":300,"w":50,"h":50,"type":2,"color":"#ffffff"},{"x":850,"y":350,"w":50,"h":50,"type":2,"color":"#ffffff"},{"x":850,"y":300,"w":50,"h":50,"type":2,"color":"#ffffff"},{"x":850,"y":250,"w":50,"h":50,"type":2,"color":"#ffffff"},{"x":0,"y":250,"w":50,"h":50,"type":2,"color":"#ffffff"},{"x":350,"y":750,"w":50,"h":50,"type":0,"color":"#ffffff"},{"x":400,"y":750,"w":50,"h":50,"type":0,"color":"#ffffff"},{"x":450,"y":750,"w":50,"h":50,"type":0,"color":"#ffffff"},{"x":500,"y":750,"w":50,"h":50,"type":0,"color":"#c9c9c9"},{"x":750,"y":450,"w":50,"h":50,"type":11,"color":"#c9c9c9"},{"x":100,"y":450,"w":50,"h":50,"type":10,"color":"#c9c9c9"},{"x":100,"y":600,"w":50,"h":50,"type":12,"color":"#c9c9c9"},{"x":750,"y":600,"w":50,"h":50,"type":13,"color":"#c9c9c9"},{"x":0,"y":200,"w":50,"h":50,"type":0,"color":"#8d4433"},{"x":0,"y":150,"w":50,"h":50,"type":0,"color":"#8d4433"},{"x":0,"y":100,"w":50,"h":50,"type":0,"color":"#8d4433"},{"x":0,"y":50,"w":50,"h":50,"type":0,"color":"#8d4433"},{"x":50,"y":50,"w":50,"h":50,"type":0,"color":"#8d4433"},{"x":100,"y":50,"w":50,"h":50,"type":0,"color":"#8d4433"},{"x":150,"y":50,"w":50,"h":50,"type":0,"color":"#8d4433"},{"x":200,"y":50,"w":50,"h":50,"type":0,"color":"#8d4433"},{"x":600,"y":50,"w":50,"h":50,"type":0,"color":"#8d4433"},{"x":550,"y":50,"w":50,"h":50,"type":0,"color":"#8d4433"},{"x":500,"y":50,"w":50,"h":50,"type":0,"color":"#8d4433"},{"x":450,"y":50,"w":50,"h":50,"type":0,"color":"#8d4433"},{"x":400,"y":50,"w":50,"h":50,"type":0,"color":"#8d4433"},{"x":350,"y":50,"w":50,"h":50,"type":0,"color":"#8d4433"},{"x":300,"y":50,"w":50,"h":50,"type":0,"color":"#8d4433"},{"x":250,"y":50,"w":50,"h":50,"type":0,"color":"#8d4433"},{"x":650,"y":50,"w":50,"h":50,"type":0,"color":"#8d4433"},{"x":700,"y":50,"w":50,"h":50,"type":0,"color":"#8d4433"},{"x":750,"y":50,"w":50,"h":50,"type":0,"color":"#8d4433"},{"x":800,"y":50,"w":50,"h":50,"type":0,"color":"#8d4433"},{"x":850,"y":50,"w":50,"h":50,"type":0,"color":"#8d4433"},{"x":850,"y":100,"w":50,"h":50,"type":0,"color":"#8d4433"},{"x":850,"y":150,"w":50,"h":50,"type":0,"color":"#8d4433"},{"x":850,"y":200,"w":50,"h":50,"type":0,"color":"#8d4433"},{"x":50,"y":300,"w":50,"h":50,"type":1,"color":"#ffffff"},{"x":100,"y":300,"w":50,"h":50,"type":1,"color":"#ffffff"},{"x":800,"y":300,"w":50,"h":50,"type":1,"color":"#ffffff"},{"x":750,"y":300,"w":50,"h":50,"type":1,"color":"#ffffff"},{"x":450,"y":700,"w":50,"h":50,"type":2,"color":"#c9c9c9"},{"x":400,"y":650,"w":50,"h":50,"type":2,"color":"#c9c9c9"},{"x":400,"y":700,"w":50,"h":50,"type":2,"color":"#ffffff"},{"x":450,"y":650,"w":50,"h":50,"type":2,"color":"#ffffff"},{"x":350,"y":650,"w":50,"h":50,"type":1,"color":"#ffffff"},{"x":500,"y":650,"w":50,"h":50,"type":1,"color":"#ffffff"}];
    gamePlatforms = JSON.parse(JSON.stringify(baseMap));
    simPlatforms = JSON.parse(JSON.stringify(baseMap)).map(p => {
        p.x += 10000;
        if (p.type === 0) p.color = '#555566';
        else if (p.type === 1) p.color = '#448844';
        else if (p.type === 2) p.color = '#888899';
        return p;
    });
    loadingPlatforms = JSON.parse(JSON.stringify(baseMap)).map(p => {
        p.x += 20000;
        if (p.type === 0) p.color = '#555566';
        else if (p.type === 1) p.color = '#448844';
        else if (p.type === 2) p.color = '#888899';
        return p;
    });
    platforms = gamePlatforms;
}
initMap();

const characterStats = {
    julie: {
        name: '„Ç∏„É•„É™„Éº',
        hp: 260,
        speed: 5,
        energy: 3,
        description: '4ÁÇπ„Éê„Éº„Çπ„Éà„É©„Ç§„Éï„É´„ÅßÁ≤æÂØÜ„Å™ÊîªÊíÉ„ÇíÂæóÊÑè„Å®„Åô„Çã„ÄÇ„Éê„É©„É≥„Çπ„ÅÆÂèñ„Çå„Åü„Ç™„Éº„É´„É©„Ç¶„É≥„ÉÄ„Éº„ÄÇ',
    },
    jack: {
        name: '„Ç∏„É£„ÉÉ„ÇØ',
        hp: 160,
        speed: 6,
        energy: 2,
        description: 'È´òÂ®ÅÂäõ„ÅÆ„Ç∑„Éß„ÉÉ„Éà„Ç¨„É≥„ÅßËøëË∑ùÈõ¢„ÇíÂà∂Âúß„Åô„Çã„ÄÇÊ©üÂãïÂäõ„ÅØÈ´ò„ÅÑ„ÄÇ',
    },
    sky: {
        name: '„Çπ„Ç´„Ç§',
        hp: 200,
        speed: 4,
        energy: 2,
        description: '2ÈÄ£„Éó„É©„Ç∫„ÉûÈäÉ„ÅßÁû¨ÈñìÁÅ´Âäõ„ÇíÂá∫„Åô„ÄÇ‰ΩìÂäõ„ÅØ‰Ωé„ÅÑ„Åå„ÄÅÂà∂ÂúßÂäõ„ÅØÈ´ò„ÅÑ„ÄÇ',
    }
};
let selectedCharInUI = 'julie'; // „Ç≠„É£„É©ÈÅ∏ÊäûÁîªÈù¢„ÅßÈÅ∏Êäû‰∏≠„ÅÆ„Ç≠„É£„É©

const player = {
    x: 100, y: 800, radius: 40, vx: 0, vy: 0,
    onGround: false, color: '#00d2ff', energy: 3, maxEnergy: 3, facing: 1, jumpCount: 0, maxJumps: 2, hp: 200, maxHp: 200, baseMaxHp: 200, kills: 0, damageTimer: 0, name: 'Player', lastShotTime: 0, rate: 1500, charType: 'julie', speed: 5
};
let enemies = [];
let killLogs = [];
let bullets = [];
let particles = [];
let confetti = [];
let pendingEnemies = [];
let joinedEnemies = [];
let rankings = []; // Ê≠ª‰∫°È†Ü„É™„Çπ„Éà (ÊúÄÂæå„Åå1‰Ωç)
let showResultButton = false;
let gameResult = ''; // 'win' or 'lose'
let homeParticles = []; // For home screen background
let circleStartTime = 0;
let circleRadius = 0;
let circleCenterX = 0;
let circleCenterY = 0;
const CIRCLE_DAMAGE_PER_SECOND = 5;
let lastLoginTime = Date.now();
let offlineSimQueue = [];
let offlineSimTotalMatches = 0;
let offlineSimCurrentMatch = 0;
let aiRates = {}; // { nameID: rate }
let rankingScrollY = 0;
let rankingTouchStartY = 0;
let rankingData = [];
let backgroundStartTime = 0;
let currentOnlineCount = 0;
let lastOnlineUpdate = 0;
let matchEnded = false;
let bgmVolume = 0.5;
let isDraggingVolumeSlider = false;

function setPlayerCharacter(charType) {
    player.charType = charType;
    if (charType === 'jack') {
        player.speed = 6;
        player.baseMaxHp = 160;
        player.maxEnergy = 2;
    } else if (charType === 'sky') {
        player.speed = 4;
        player.baseMaxHp = 200;
        player.maxEnergy = 2;
    } else { // julie
        player.speed = 5;
        player.baseMaxHp = 260;
        player.maxEnergy = 3;
    }
    player.maxHp = player.baseMaxHp;
    player.hp = player.maxHp;
    player.energy = player.maxEnergy;
}

function loadPlayerData() {
    const saved = localStorage.getItem('sb_playerData');
    if (saved) {
        const data = JSON.parse(saved);
        player.name = data.name || `Player${Math.floor(1000 + Math.random() * 9000)}`;
        player.rate = (data.rate !== undefined && !isNaN(data.rate)) ? data.rate : 1500;
        player.rateHistory = data.rateHistory || [1500];
        lastLoginTime = data.lastLogin || Date.now();
        bgmVolume = data.bgmVolume !== undefined ? data.bgmVolume : 0.5;
        setPlayerCharacter(data.charType || 'julie');
    } else {
        // First time setup
        player.name = `Player${Math.floor(1000 + Math.random() * 9000)}`;
        player.rate = 1500;
        player.rateHistory = [1500];
        bgmVolume = 0.5;
        lastLoginTime = Date.now();
        setPlayerCharacter('julie');
        savePlayerData(); // Save the new default data
    }
    // Apply volume
    bgmHome.volume = bgmVolume;
    bgmMatch.volume = bgmVolume;
}

function savePlayerData() {
    localStorage.setItem('sb_playerData', JSON.stringify({
        name: player.name,
        rate: player.rate,
        rateHistory: player.rateHistory,
        lastLogin: Date.now(),
        bgmVolume: bgmVolume,
        charType: player.charType
    }));
}

function loadAIRates() {
    const saved = localStorage.getItem('sb_aiRates');
    if (saved) {
        aiRates = JSON.parse(saved);
        // Êñ∞Ë¶èAIÂØæÂøú
        aiSamples.forEach(ai => {
            if (aiRates[ai.nameID] === undefined) aiRates[ai.nameID] = 1500;
        });
    } else {
        // ÂàùÂõû„Ç∑„Éü„É•„É¨„Éº„Ç∑„Éß„É≥
        aiSamples.forEach(ai => aiRates[ai.nameID] = 1500);
        simulateInitialMatches();
        saveAIRates();
    }
}

function saveAIRates() {
    localStorage.setItem('sb_aiRates', JSON.stringify(aiRates));
}

function startLoadingMode() {
    gameState = 'loading';
    platforms = loadingPlatforms;
    player.x = 20100; player.y = 800;
    player.vx = 0; player.vy = 0;
}

function simulateInitialMatches() {
    const matches = [];
    // 200Âõû„Ç∑„Éü„É•„É¨„Éº„Ç∑„Éß„É≥Áî®„Éá„Éº„Çø‰ΩúÊàê
    for (let i = 0; i < 2000; i++) {
        // 4‰Ωì„É©„É≥„ÉÄ„É†ÈÅ∏Âá∫
        const shuffled = [...aiSamples].sort(() => 0.5 - Math.random());
        matches.push(shuffled.slice(0, 4));
    }
    offlineSimQueue = offlineSimQueue.concat(matches);
    offlineSimTotalMatches += matches.length;
    if (offlineSimQueue.length > 0) startLoadingMode();
}

function simulateRankedMatch(participants, map) {
    const originalPlatforms = platforms;
    platforms = map;

    try {
    // ÂÆüÈöõ„ÅÆ„Ç∑„Éü„É•„É¨„Éº„Ç∑„Éß„É≥ (200ÂÄçÈÄüÁõ∏ÂΩì = ÊºîÁÆó„ÅÆ„ÅøÈ´òÈÄüÂÆüË°å)
    // Áí∞Â¢ÉÊßãÁØâ
    const simEnemies = participants.map((p, i) => {
        // „Çπ„Éù„Éº„É≥‰ΩçÁΩÆ (Á∞°ÊòìÁöÑ„Å´ÂàÜÊï£„Åï„Åõ„Çã)
        const spawnX = 10000 + 100 + (i * 400) % (WORLD_WIDTH - 200);
        const spawnY = 200;
        
        // „Ç≠„É£„É©„ÇØ„Çø„ÉºÈÅ∏Êäû
        let charType = 'julie';
        if (p.Pick) {
            const pickRoll = Math.random() * 100;
            const julieThreshold = p.Pick.julie;
            const jackThreshold = julieThreshold + (p.Pick.jack || 0);
            
            if (pickRoll > julieThreshold) {
                if (pickRoll > jackThreshold) {
                    charType = 'sky';
                } else {
                    charType = 'jack';
                }
            }
        }

        let hp = 260, maxEnergy = 3, speed = 5;
        if (charType === 'jack') { hp = 160; maxEnergy = 2; speed = 6; } else if (charType === 'sky') { hp = 200; maxEnergy = 2; speed = 4;
        }
        
        return {
            x: spawnX, y: spawnY, radius: 40, vx: 0, vy: 0,
            onGround: false, energy: 3, maxEnergy: 3, facing: 1, jumpCount: 0, maxJumps: 2,
            hp: hp, maxHp: hp, baseMaxHp: hp, kills: 0, damageTimer: 0,
            name: p.name, nameID: p.nameID,
            rate: aiRates[p.nameID] || 1500,
            personality: p.personality,
            sightRangeBlocks: p.sightRangeBlocks,
            aimAccuracy: (100 - p.aimRate) * 0.005,
            aimRate: p.aimRate,
            aggressiveness: p.aggroRate / 100,
            linearApproachChance: p.linearRate / 100,
            state: 'hide', timer: 0,
            shootCooldown: 0, attackCooldown: 0,
            burstRemaining: 0, burstTimer: 0, 
            charType: charType,
            speed: speed,
            ai: p // ÂÖÉ„Éá„Éº„ÇøÂèÇÁÖßÁî®
        };
    });

    let simBullets = [];
    const maxFrames = 900; // ÊúÄÂ§ß15Áßí (Ë∂ÖÈ´òÈÄüÂåñ)
    
    // È´òÈÄü„É´„Éº„Éó
    for (let t = 0; t < maxFrames; t++) {
        // AIÊõ¥Êñ∞ (8„Éï„É¨„Éº„É†„Å´1Âõû„Å´ÈñìÂºï„ÅÑ„Å¶È´òÈÄüÂåñ)
        const isAIUpdateFrame = (t % 8 === 0);
        
        simEnemies.forEach(e => {
            if (e.hp <= 0) return;
            if (isAIUpdateFrame) updateAI(e, simEnemies, simBullets);
            processBurst(e);
            applyPhysics(e);
            
            // ËêΩ‰∏ãÂà§ÂÆö
            if (e.y > WORLD_HEIGHT + 100) e.hp = 0;
        });

        // ÂºæÊõ¥Êñ∞
        for (let i = simBullets.length - 1; i >= 0; i--) {
            const b = simBullets[i];
            b.x += b.vx; b.y += b.vy;
            
            // Â£ÅÂà§ÂÆö
            let hitWall = false;
            platforms.forEach(p => {
                const hitH = p.type === 1 ? p.h / 2 : p.h;
                if (p.type < 10 && (p.type === 0 || p.type === 1) && b.x > p.x && b.x < p.x + p.w && b.y > p.y && b.y < p.y + hitH) {
                    hitWall = true;
                }
            });

            // „Éí„ÉÉ„ÉàÂà§ÂÆö
            if (!hitWall) {
                simEnemies.forEach(target => {
                    if (target === b.owner || target.hp <= 0) return;
                    if (Math.hypot(b.x - target.x, b.y - target.y) < target.radius) {
                        target.hp -= 10; // „ÉÄ„É°„Éº„Ç∏
                        hitWall = true; // Ê∂àÊªÖ
                    }
                });
            }

            if (hitWall || b.x < 10000 || b.x > 10000 + WORLD_WIDTH || b.y < 0 || b.y > WORLD_HEIGHT) {
                simBullets.splice(i, 1);
            }
        }

        // Ê±∫ÁùÄÂà§ÂÆö
        if (simEnemies.filter(e => e.hp > 0).length <= 1) break;
    }
    
    // ÁµêÊûúÈõÜË®à (HPÈ†Ü -> Ê≠ª‰∫°È†Ü„ÅÆÈÄÜ)
    simEnemies.sort((a, b) => b.hp - a.hp);
    const rankedAIs = simEnemies.map(e => e.ai);
    
    // „É¨„Éº„ÉàÊõ¥Êñ∞
    updateEloRates(rankedAIs);
    } finally {
        platforms = originalPlatforms;
    }
}

function simulateBackgroundMatches(count) {
    if (count <= 0) return;
    
    // ‰ªäÂõû„ÅÆ„Éû„ÉÉ„ÉÅÂèÇÂä†ËÄÖID
    const currentMatchIDs = new Set(joinedEnemies.map(e => e.nameID).filter(id => id));
    
    // ÂÄôË£ú„Å®„Å™„ÇãAI„É™„Çπ„Éà (‰ªäÂõû„ÅÆ„Éû„ÉÉ„ÉÅ„Å´ÂèÇÂä†„Åó„Å¶„ÅÑ„Å™„ÅÑAI)
    const candidates = aiSamples.filter(ai => !currentMatchIDs.has(ai.nameID));
    
    // „Ç∑„É£„ÉÉ„Éï„É´
    for (let i = candidates.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [candidates[i], candidates[j]] = [candidates[j], candidates[i]];
    }

    let processedCount = 0;
    let candidateIndex = 0;

    while (processedCount < count && candidateIndex + 4 <= candidates.length) {
        const participants = candidates.slice(candidateIndex, candidateIndex + 4);
        simulateRankedMatch(participants, simPlatforms);
        candidateIndex += 4;
        processedCount++;
    }
}

function getRate(entity) {
    if (entity === player) return player.rate;
    // entity„ÅåAIÂÆöÁæ©„ÅÆÂ†¥Âêà„Å®„ÄÅ„Ç≤„Éº„É†ÂÜÖ„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„ÅÆÂ†¥Âêà„Åå„ÅÇ„Çã
    const id = entity.nameID || (entity.ai ? entity.ai.nameID : null);
    if (id && aiRates[id] !== undefined) return aiRates[id];
    // „Ç≤„Éº„É†ÂÜÖ„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„ÅßnameID„Åå„Å™„ÅÑÂ†¥Âêà„ÅØ‰∏ÄÊôÇÁöÑ„Å™„É¨„Éº„Éà
    if (entity.rate !== undefined) return entity.rate;
    return 1500;
}

function getDailySchedule(aiList) {
    const today = new Date().toISOString().split('T')[0];
    const key = 'sb_schedule_' + today;
    let schedule = localStorage.getItem(key);

    if (!schedule) {
        // Êñ∞„Åó„ÅÑÊó•„ÅÆ„Çπ„Ç±„Ç∏„É•„Éº„É´ÁîüÊàê
        schedule = {};
        aiList.forEach(ai => {
            schedule[ai.nameID] = [];
            for (let h = 0; h < 24; h++) {
                // Âá∫ÁèæÁéá(%)„Å´Âü∫„Å•„ÅÑ„Å¶Âà§ÂÆö
                const rateForHour = (ai.appearanceRates && ai.appearanceRates[h]) ? ai.appearanceRates[h] : 20; // ÊôÇÈñìÂ∏Ø„Åî„Å®„ÅÆ„É¨„Éº„Éà„ÄÅ„Å™„Åë„Çå„Å∞„Éá„Éï„Ç©„É´„Éà20%
                schedule[ai.nameID].push(Math.random() * 100 < rateForHour);
            }
        });
        localStorage.setItem(key, JSON.stringify(schedule));
        
        // Âè§„ÅÑ„Çπ„Ç±„Ç∏„É•„Éº„É´„ÅÆÂâäÈô§ (Á∞°ÊòìÁöÑ)
        for (let k in localStorage) {
            if (k.startsWith('sb_schedule_') && k !== key) {
                localStorage.removeItem(k);
            }
        }
    } else {
        schedule = JSON.parse(schedule);
    }
    return schedule;
}

function processOfflineMatches() {
    const now = Date.now();
    const diffMs = now - lastLoginTime;
    const oneMinuteMs = 60 * 1000;
    let minutesPassed = Math.floor(diffMs / oneMinuteMs);
    if (minutesPassed > 2000) minutesPassed = 2000;

    if (minutesPassed <= 0) {
        savePlayerData(); // ÊôÇÈñìÊõ¥Êñ∞„ÅÆ„Åø
        return;
    }

    let matchQueue = [];

    // ÈÅéÂéª„ÅÆÊôÇÈñìÂ∏Ø„Çí„Ç∑„Éü„É•„É¨„Éº„Éà
    let checkTime = lastLoginTime;
    for (let i = 0; i < minutesPassed; i++) {
        // 4‰Ωì„É©„É≥„ÉÄ„É†ÈÅ∏Âá∫
        const shuffled = [...aiSamples].sort(() => 0.5 - Math.random());
        const participants = shuffled.slice(0, 4);
        
        // 4‰Ωì„ÅÑ„Çå„Å∞Ë©¶ÂêàÊàêÁ´ã
        if (participants.length === 4) {
            matchQueue.push(participants);
        }
    }

    if (matchQueue.length > 0) {
        startLoadingMode();
        offlineSimQueue = offlineSimQueue.concat(matchQueue);
        offlineSimTotalMatches += matchQueue.length;
    } else {
        if (gameState !== 'loading') savePlayerData(); // ÊôÇÈñìÊõ¥Êñ∞„ÅÆ„Åø
    }
}

document.addEventListener('visibilitychange', () => {
    if (document.hidden) {
        backgroundStartTime = Date.now();
    } else {
        if (backgroundStartTime > 0) {
            const duration = Date.now() - backgroundStartTime;
            if (duration > 10000) { // 10Áßí‰ª•‰∏ä„Ç™„Éï„Çø„Éñ
                handleLongOffline(backgroundStartTime);
            }
            backgroundStartTime = 0;
        }
    }
});

function handleLongOffline(startTime) {
    // „Éû„ÉÉ„ÉÅ‰∏≠Ôºà„Éó„É¨„Ç§‰∏≠„ÄÅ„Ç´„Ç¶„É≥„Éà„ÉÄ„Ç¶„É≥„ÄÅË¶≥Êà¶‰∏≠Ôºâ„Å™„ÇâÊïóÂåóÊâ±„ÅÑ
    if (gameState === 'playing' || gameState === 'countdown' || gameState === 'spectating') {
        // „Åæ„Å†Ê±∫ÁùÄ„Åå„Å§„ÅÑ„Å¶„ÅÑ„Å™„ÅÑÂ†¥Âêà„ÅÆ„Åø„Éö„Éä„É´„ÉÜ„Ç£
        if (gameResult === '') {
             // Êïµ„Çí‰∏ä‰Ωç„ÄÅ„Éó„É¨„Ç§„É§„Éº„ÇíÊúÄ‰∏ã‰Ωç„Å®„Åó„Å¶„É¨„Éº„ÉàË®àÁÆó
             if (enemies.length > 0) {
                 updateEloRates([...enemies, player]);
             } else {
                 // Êïµ„Åå„ÅÑ„Å™„ÅÑÂ†¥Âêà„Åß„ÇÇ„Éö„Éä„É´„ÉÜ„Ç£Áî®„ÉÄ„Éü„Éº„Å®Ë®àÁÆó
                 updateEloRates([{ rate: 1500, nameID: 'dummy' }, player]);
             }
        }
    }
    
    // Áä∂ÊÖã„É™„Çª„ÉÉ„Éà
    gameState = 'home';
    platforms = gamePlatforms;
    gameResult = '';
    
    // „Ç™„Éï„É©„Ç§„É≥ÊúüÈñì„ÅÆ„Ç∑„Éü„É•„É¨„Éº„Ç∑„Éß„É≥Ë®≠ÂÆö
    lastLoginTime = startTime;
    savePlayerData(); // lastLoginTime„Çí‰øùÂ≠ò
    
    // „Ç∑„Éü„É•„É¨„Éº„Ç∑„Éß„É≥ÈñãÂßã
    processOfflineMatches();
}

function startSession(enemiesList) {
    matchEnded = false;
    platforms = gamePlatforms;
    // ÂàùÊúü„Çπ„Éù„Éº„É≥Âú∞ÁÇπ„ÅÆ„É©„É≥„ÉÄ„É†ÈÅ∏Êäû
    const spawns = platforms.filter(p => p.type >= 10 && p.type <= 13);
    // „Ç∑„É£„ÉÉ„Éï„É´
    for (let i = spawns.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [spawns[i], spawns[j]] = [spawns[j], spawns[i]];
    }

    if (spawns.length > 0) {
        const s = spawns[0];
        player.x = s.x + s.w / 2;
        player.y = s.y + s.h / 2;
    } else {
        player.x = 100; player.y = 800;
    }
    player.vx = 0; player.vy = 0;
    player.maxHp = player.baseMaxHp; player.hp = player.maxHp; player.kills = 0;
    player.energy = player.maxEnergy;
    player.damageDealt = 0;
    player.healedAmount = 0;
    
    circleStartTime = 60;
    circleRadius = Math.hypot(WORLD_WIDTH, WORLD_HEIGHT);
    circleCenterX = WORLD_WIDTH / 2;
    circleCenterY = WORLD_HEIGHT / 2;

    enemies = [];
    bullets = [];
    particles = [];
    killLogs = [];
    rankings = [];
    confetti = [];
    showResultButton = false;
    gameResult = '';

    // Êïµ„ÅÆÁîüÊàê
    const spawnCount = Math.min(spawns.length - 1, enemiesList.length);
    for (let i = 0; i < spawnCount; i++) {
        const s = spawns[i + 1];
        const sample = enemiesList[i];
        
        // „Ç≠„É£„É©„ÇØ„Çø„ÉºÈÅ∏Êäû
        let charType = 'julie';
        if (sample.Pick) {
            const pickRoll = Math.random() * 100;
            const julieThreshold = sample.Pick.julie;
            const jackThreshold = julieThreshold + (sample.Pick.jack || 0);
            
            if (pickRoll > julieThreshold) {
                if (pickRoll > jackThreshold) {
                    charType = 'sky';
                } else {
                    charType = 'jack';
                }
            }
        }

        let hp = 260, maxEnergy = 3, speed = 5;
        if (charType === 'jack') { hp = 160; maxEnergy = 2; speed = 6; } else if (charType === 'sky') { hp = 200; maxEnergy = 2; speed = 4;
        }

        // BOTÂà§ÂÆö
        const isBot = sample.isBot;
        const finalHp = isBot ? 30 : hp;
        const aimRate = isBot ? 30 : sample.aimRate;
        const aggroRate = isBot ? 30 : sample.aggroRate;

        enemies.push({
            x: s.x + s.w/2, y: s.y + s.h/2, radius: 40, vx: 0, vy: 0,
            onGround: false, color: sample.color, 
            energy: maxEnergy, maxEnergy: maxEnergy, 
            facing: 1, jumpCount: 0, maxJumps: 2, 
            hp: finalHp, maxHp: finalHp, baseMaxHp: finalHp, 
            kills: 0, damageTimer: 0,
            name: sample.name,
            nameID: sample.nameID,
            charType: charType,
            speed: speed,
            rate: aiRates[sample.nameID] || 1500,
            personality: sample.personality,
            sightRangeBlocks: sample.sightRangeBlocks,
            aimAccuracy: (100 - aimRate) * 0.005,
            aimRate: aimRate,
            aggressiveness: aggroRate / 100,
            linearApproachChance: sample.linearRate / 100,
            lastShotTime: 0,
            attackCooldown: 0,
            state: 'hide', // hide, peek, attack
            timer: 0,
            target: null,
            lastTargetVisible: false,
            revengeTimer: 0,
            shootCooldown: 0,
            chaseTimer: 0,
            chaseTarget: null,
            initialMoveDist: (2.5 + Math.random() * 2.5) * TILE_SIZE,
            traveledDist: 0,
            initialDir: Math.random() < 0.5 ? 1 : -1,
            forcedMoveSteps: 0,
            forcedMoveDir: 0,
            moveLockTimer: 0,
            lockedVx: 0,
            doubleJumpChecked: false
        });
    }
}

// AIÂÆöÁæ© (appearanceRate: 60ÂàÜ„Åî„Å®„ÅÆÂá∫ÁèæÁ¢∫Áéá%)
const aiSamples = [ // appearanceRates: ÂêÑÊôÇÈñìÂ∏Ø(0-23ÊôÇ)„ÅÆÂá∫ÁèæÁ¢∫Áéá%
    { nameID: "ai_01", name: "Áæé‰æëch‚ô•", personality: "defender", aimRate: 96, aggroRate: 60, sightRangeBlocks: 25, color: "#555555", linearRate: 5, appearanceRates: {"18":80,"19":90,"20":95,"21":95,"22":90,"23":80}, Pick: { julie: 70, jack: 15, sky: 15 } },
    { nameID: "ai_02", name: "‚Ä†Â†ïÂ§©‰Ωø‚Ä†", personality: "aggressor", aimRate: 50, aggroRate: 95, sightRangeBlocks: 12, color: "#ff0000", linearRate: 95, appearanceRates: {"0":90,"1":90,"2":80,"19":90,"20":95,"21":95,"22":90,"23":90}, Pick: { julie: 20, jack: 70, sky: 10 } },
    { nameID: "ai_03", name: "„Åø„Åã„ÇìÁÆ±", personality: "defender", aimRate: 80, aggroRate: 20, sightRangeBlocks: 20, color: "#228822", linearRate: 2, appearanceRates: {"7":50,"8":60,"9":60,"10":50}, Pick: { julie: 80, jack: 10, sky: 10 } },
    { nameID: "ai_04", name: "„Åó„ÇÉ„Éº„Å∑„ÅÉ„Å¶„Çì", personality: "duelist", aimRate: 93, aggroRate: 60, sightRangeBlocks: 15, color: "#880088", linearRate: 60, appearanceRates: {"12":70,"13":70,"14":70,"20":80,"21":80}, Pick: { julie: 40, jack: 40, sky: 20 } },
    { nameID: "ai_05", name: "YAMADA", personality: "aggressor", aimRate: 70, aggroRate: 50, sightRangeBlocks: 14, color: "#cc4444", linearRate: 70, appearanceRates: {"0":60,"1":60,"2":60,"3":60,"4":60,"5":60,"6":60,"7":60,"8":60,"9":60,"10":60,"11":60,"12":60,"13":60,"14":60,"15":60,"16":60,"17":60,"18":60,"19":60,"20":60,"21":60,"22":60,"23":60}, Pick: { julie: 50, jack: 35, sky: 15 } },
    { nameID: "ai_06", name: "‰ΩêËó§„Åï„Çì", personality: "defender", aimRate: 70, aggroRate: 30, sightRangeBlocks: 14, color: "#44cc44", linearRate: 10, appearanceRates: {"15":40,"16":50,"17":50,"18":40}, Pick: { julie: 60, jack: 25, sky: 15 } },
    { nameID: "ai_07", name: "„Å≤„Å™„Å¥„Çà", personality: "duelist", aimRate: 70, aggroRate: 50, sightRangeBlocks: 14, color: "#4444cc", linearRate: 50, appearanceRates: {"16":85,"17":85,"18":85,"19":85,"20":85}, Pick: { julie: 40, jack: 40, sky: 20 } },
    { nameID: "ai_08", name: "RenRen", personality: "aggressor", aimRate: 20, aggroRate: 80, sightRangeBlocks: 10, color: "#ffffff", linearRate: 80, appearanceRates: {"0":95,"1":95,"2":95,"3":95,"4":95,"5":95,"6":95,"7":95,"8":95,"9":95,"10":95,"11":95,"12":95,"13":95,"14":95,"15":95,"16":95,"17":95,"18":95,"19":95,"20":95,"21":95,"22":95,"23":95}, Pick: { julie: 10, jack: 80, sky: 10 } },
    { nameID: "ai_09", name: "üå∏„Åï„Åè„Çâüå∏", personality: "defender", aimRate: 98, aggroRate: 50, sightRangeBlocks: 22, color: "#aa00aa", linearRate: 5, appearanceRates: {"22":30,"23":40,"0":40,"1":30}, Pick: { julie: 85, jack: 5, sky: 10 } },
    { nameID: "ai_10", name: "Yuki_Snow", personality: "aggressor", aimRate: 40, aggroRate: 90, sightRangeBlocks: 10, color: "#ff8800", linearRate: 90, appearanceRates: {"19":75,"20":80,"21":80,"22":75}, Pick: { julie: 30, jack: 50, sky: 20 } },
    { nameID: "ai_11", name: "ÂêçÁÑ°„Åó„Åï„ÇìÔº†", personality: "duelist", aimRate: 84, aggroRate: 40, sightRangeBlocks: 18, color: "#00aaaa", linearRate: 40, appearanceRates: {"10":60,"11":60,"12":60,"13":60,"14":60}, Pick: { julie: 50, jack: 30, sky: 20 } },
    { nameID: "ai_12", name: "ÂàùÂøÉËÄÖüî∞", personality: "defender", aimRate: 80, aggroRate: 10, sightRangeBlocks: 16, color: "#004400", linearRate: 10, appearanceRates: {"8":20,"9":20,"10":20,"11":20,"12":20,"13":20,"14":20,"15":20,"16":20,"17":20}, Pick: { julie: 90, jack: 0, sky: 10 } },
    { nameID: "ai_13", name: "ÂçØÊúà„Åì„Çà„Çä@ÈÖç‰ø°", personality: "aggressor", aimRate: 60, aggroRate: 100, sightRangeBlocks: 12, color: "#880000", linearRate: 100, appearanceRates: {"21":50,"22":60,"23":60,"0":50}, Pick: { julie: 0, jack: 80, sky: 20 } },
    { nameID: "ai_14", name: "„É©„Éº„É°„É≥‰∫åÈÉé", personality: "duelist", aimRate: 90, aggroRate: 70, sightRangeBlocks: 14, color: "#111111", linearRate: 70, appearanceRates: {"2":40,"3":50,"4":50,"5":40}, Pick: { julie: 40, jack: 40, sky: 20 } },
    { nameID: "ai_15", name: "ÂØù‰∏çË∂≥„Éû„É≥", personality: "aggressor", aimRate: 30, aggroRate: 40, sightRangeBlocks: 10, color: "#aaaaaa", linearRate: 60, appearanceRates: {"13":90,"14":90,"15":90,"16":90,"17":90,"18":90,"19":90,"20":90}, Pick: { julie: 40, jack: 40, sky: 20 } },
    { nameID: "ai_16", name: "KENJI_JP", personality: "defender", aimRate: 88, aggroRate: 30, sightRangeBlocks: 18, color: "#555500", linearRate: 20, appearanceRates: {"23":10,"0":20,"1":20,"2":10}, Pick: { julie: 70, jack: 20, sky: 10 } },
    { nameID: "ai_17", name: "„ÅÇ„ÇÑ„Åã", personality: "duelist", aimRate: 94, aggroRate: 80, sightRangeBlocks: 16, color: "#ffd700", linearRate: 50, appearanceRates: {"19":65,"20":70,"21":70,"22":65}, Pick: { julie: 50, jack: 30, sky: 20 } },
    { nameID: "ai_18", name: "HIRO", personality: "defender", aimRate: 92, aggroRate: 20, sightRangeBlocks: 20, color: "#eeeeee", linearRate: 10, appearanceRates: {"20":55,"21":60,"22":60,"23":55}, Pick: { julie: 65, jack: 25, sky: 10 } },
    { nameID: "ai_19", name: "„Å™„Å™„Åø„Çì", personality: "aggressor", aimRate: 60, aggroRate: 60, sightRangeBlocks: 12, color: "#000088", linearRate: 80, appearanceRates: {"9":45,"10":50,"11":50,"12":45}, Pick: { julie: 30, jack: 50, sky: 20 } },
    { nameID: "ai_20", name: "DAIKI", personality: "defender", aimRate: 40, aggroRate: 5, sightRangeBlocks: 15, color: "#ffff00", linearRate: 0, appearanceRates: {"6":35,"7":40,"8":40,"9":35}, Pick: { julie: 80, jack: 10, sky: 10 } },
    { nameID: "ai_21", name: "„ÅΩ„Å°„Åü", personality: "defender", aimRate: 95, aggroRate: 30, sightRangeBlocks: 25, color: "#2c3e50", linearRate: 10, appearanceRates: {"20":80,"21":90,"22":90}, Pick: { julie: 70, jack: 20, sky: 10 } },
    { nameID: "ai_22", name: "„Åü„Åæ„Åî", personality: "aggressor", aimRate: 60, aggroRate: 90, sightRangeBlocks: 12, color: "#e74c3c", linearRate: 80, appearanceRates: {"18":70,"19":80,"20":80}, Pick: { julie: 20, jack: 60, sky: 20 } },
    { nameID: "ai_23", name: "momoüçë", personality: "duelist", aimRate: 85, aggroRate: 60, sightRangeBlocks: 18, color: "#34495e", linearRate: 40, appearanceRates: {"0":50,"1":60,"2":60}, Pick: { julie: 40, jack: 40, sky: 20 } },
    { nameID: "ai_24", name: "Á©∫", personality: "aggressor", aimRate: 50, aggroRate: 50, sightRangeBlocks: 14, color: "#95a5a6", linearRate: 50, appearanceRates: {"12":60,"13":60,"14":60}, Pick: { julie: 40, jack: 40, sky: 20 } },
    { nameID: "ai_25", name: "„Ç´„Éà„É™„Éà", personality: "duelist", aimRate: 40, aggroRate: 70, sightRangeBlocks: 15, color: "#f1c40f", linearRate: 90, appearanceRates: {"10":50,"11":50,"12":50}, Pick: { julie: 20, jack: 70, sky: 10 } },
    { nameID: "ai_26", name: "ÈùûË™≤ÈáëGAMES", personality: "defender", aimRate: 70, aggroRate: 20, sightRangeBlocks: 16, color: "#d35400", linearRate: 5, appearanceRates: {"8":40,"9":50,"10":50}, Pick: { julie: 60, jack: 30, sky: 10 } },
    { nameID: "ai_27", name: "„Çå„Åò„Åá„Åè„Çì(„Åª„Çì„ÇÇ„ÅÆ)", personality: "defender", aimRate: 10, aggroRate: 10, sightRangeBlocks: 10, color: "#bdc3c7", linearRate: 0, appearanceRates: {"0":90,"1":90,"2":90,"3":90}, Pick: { julie: 90, jack: 0, sky: 10 } },
    { nameID: "ai_28", name: "Êñ∞„Ç≠„É£„É©Êù•„ÅÑ„ÇàÔºÅ", personality: "duelist", aimRate: 98, aggroRate: 80, sightRangeBlocks: 20, color: "#8e44ad", linearRate: 60, appearanceRates: {"21":90,"22":95,"23":95}, Pick: { julie: 0, jack: 0, sky: 100 } },
    { nameID: "ai_29", name: "Èõ∂ÂÖé|Reito", personality: "aggressor", aimRate: 95, aggroRate: 95, sightRangeBlocks: 18, color: "#2980b9", linearRate: 80, appearanceRates: {"21":90,"22":95,"23":95}, Pick: { julie: 40, jack: 40, sky: 20 } },
    { nameID: "ai_30", name: "Êµ∑„Éë„É≥„É≤„Çø„ÇØ", personality: "defender", aimRate: 80, aggroRate: 40, sightRangeBlocks: 15, color: "#1abc9c", linearRate: 20, appearanceRates: {"0":80,"1":85,"2":90,"3":90,"4":80}, Pick: { julie: 50, jack: 30, sky: 20 } },
    { nameID: "ai_31", name: "„ÄêÁí∞Â¢ÉÁ†¥Â£ä„Äë„Éá„Éá„Éá", personality: "aggressor", aimRate: 75, aggroRate: 60, sightRangeBlocks: 14, color: "#2ecc71", linearRate: 60, appearanceRates: {"5":80,"6":90,"7":90,"8":80}, Pick: { julie: 30, jack: 50, sky: 20 } },
    { nameID: "ai_32", name: "È≠Ö„Åõ„Éó„Åó„Åü„ÅÑ", personality: "duelist", aimRate: 60, aggroRate: 50, sightRangeBlocks: 14, color: "#e67e22", linearRate: 40, appearanceRates: {"11":80,"12":95,"13":80}, Pick: { julie: 40, jack: 40, sky: 20 } },
    { nameID: "ai_33", name: "Ê±ö„ÅçËã±ÈõÑ", personality: "defender", aimRate: 70, aggroRate: 30, sightRangeBlocks: 16, color: "#ff9ff3", linearRate: 10, appearanceRates: {"15":80,"16":90,"17":90}, Pick: { julie: 60, jack: 20, sky: 20 } },
    { nameID: "ai_34", name: "Êæ™Ê®ô", personality: "aggressor", aimRate: 65, aggroRate: 50, sightRangeBlocks: 14, color: "#341f97", linearRate: 50, appearanceRates: {"19":80,"20":90,"21":80}, Pick: { julie: 40, jack: 40, sky: 20 } },
    { nameID: "ai_35", name: "„ÅÇ„Åí„Å±„Çì", personality: "defender", aimRate: 90, aggroRate: 10, sightRangeBlocks: 20, color: "#5f27cd", linearRate: 5, appearanceRates: {"0":50,"6":50,"12":50,"18":50}, Pick: { julie: 80, jack: 10, sky: 10 } },
    { nameID: "ai_36", name: "Â§è„ÅÆÊ∞∑ÁÇπ‰∏ã", personality: "aggressor", aimRate: 40, aggroRate: 80, sightRangeBlocks: 12, color: "#c8d6e5", linearRate: 70, appearanceRates: {"0":30,"12":30}, Pick: { julie: 20, jack: 60, sky: 20 } },
    { nameID: "ai_37", name: "„Çπ„Éº„Éë„Éº„Éè„É§„Éà", personality: "defender", aimRate: 50, aggroRate: 40, sightRangeBlocks: 14, color: "#8395a7", linearRate: 20, appearanceRates: {"0":30,"12":30}, Pick: { julie: 50, jack: 30, sky: 20 } },
    { nameID: "ai_38", name: "„Éù„Ç±„É¢„É≥", personality: "duelist", aimRate: 45, aggroRate: 60, sightRangeBlocks: 13, color: "#576574", linearRate: 40, appearanceRates: {"0":30,"12":30}, Pick: { julie: 40, jack: 40, sky: 20 } },
    { nameID: "ai_39", name: "„Éá„Éà„É≠„Ç§„Éà", personality: "aggressor", aimRate: 55, aggroRate: 70, sightRangeBlocks: 12, color: "#222f3e", linearRate: 60, appearanceRates: {"0":30,"12":30}, Pick: { julie: 30, jack: 50, sky: 20 } },
    { nameID: "ai_40", name: "Roberts", personality: "duelist", aimRate: 99, aggroRate: 70, sightRangeBlocks: 22, color: "#10ac84", linearRate: 50, appearanceRates: {"22":50,"23":50}, Pick: { julie: 40, jack: 40, sky: 20 } },
    { nameID: "ai_41", name: "„Éë„ÉØ„Éè„É©‰∏äÂè∏", personality: "aggressor", aimRate: 30, aggroRate: 60, sightRangeBlocks: 12, color: "#01a3a4", linearRate: 60, appearanceRates: {"16":60,"17":60}, Pick: { julie: 20, jack: 70, sky: 10 } },
    { nameID: "ai_42", name: "Êûú„Å¶„Çπ„Ç´", personality: "defender", aimRate: 20, aggroRate: 0, sightRangeBlocks: 10, color: "#ff9f43", linearRate: 0, appearanceRates: {"10":40,"14":40}, Pick: { julie: 80, jack: 0, sky: 20 } },
    { nameID: "ai_43", name: "„Ç¥„Éü„Ç®„Ç§„É†", personality: "aggressor", aimRate: 40, aggroRate: 100, sightRangeBlocks: 15, color: "#ee5253", linearRate: 100, appearanceRates: {"23":60,"0":60}, Pick: { julie: 10, jack: 80, sky: 10 } },
    { nameID: "ai_44", name: "BOT94", personality: "duelist", aimRate: 88, aggroRate: 60, sightRangeBlocks: 16, color: "#2e86de", linearRate: 80, appearanceRates: {"2":50,"3":50}, Pick: { julie: 40, jack: 40, sky: 20 } },
    { nameID: "ai_45", name: "Èô∞„Ç≠„É£w?", personality: "duelist", aimRate: 90, aggroRate: 50, sightRangeBlocks: 18, color: "#54a0ff", linearRate: 30, appearanceRates: {"19":50,"20":50}, Pick: { julie: 50, jack: 30, sky: 20 } },
    { nameID: "ai_46", name: "„É™„Ç¢ÂÖÖÁàÜÊï£„Åó„Çç", personality: "aggressor", aimRate: 70, aggroRate: 40, sightRangeBlocks: 14, color: "#5f27cd", linearRate: 40, appearanceRates: {"21":50,"22":50}, Pick: { julie: 40, jack: 40, sky: 20 } },
    { nameID: "ai_47", name: "Ë≤†„Åë„Å¶„ÅäÈ°ò„ÅÑ", personality: "defender", aimRate: 60, aggroRate: 20, sightRangeBlocks: 15, color: "#00d2d3", linearRate: 10, appearanceRates: {"12":50,"13":50}, Pick: { julie: 70, jack: 20, sky: 10 } },
    { nameID: "ai_48", name: "riki@r", personality: "defender", aimRate: 50, aggroRate: 30, sightRangeBlocks: 12, color: "#1dd1a1", linearRate: 20, appearanceRates: {"18":50,"19":50}, Pick: { julie: 60, jack: 30, sky: 10 } },
    { nameID: "ai_49", name: "„Ç´„Ç∫„É§Ê≠ª„Å≠", personality: "duelist", aimRate: 92, aggroRate: 80, sightRangeBlocks: 14, color: "#ff6b6b", linearRate: 70, appearanceRates: {"1":50,"2":50}, Pick: { julie: 40, jack: 40, sky: 20 } },
    { nameID: "ai_50", name: "ÈáéËèú„ÅÆÁ•û", personality: "duelist", aimRate: 95, aggroRate: 90, sightRangeBlocks: 25, color: "#000000", linearRate: 50, appearanceRates: {"23":10,"0":10}, Pick: { julie: 40, jack: 40, sky: 20 } },
    { nameID: "ai_51", name: "„Çã„ÅÆ„Çì", personality: "duelist", aimRate: 100, aggroRate: 20, sightRangeBlocks: 30, color: "#ff00ff", linearRate: 10, appearanceRates: {"18":90,"19":95,"20":100,"21":100,"22":100,"23":90}, Pick: { julie: 80, jack: 10, sky: 10 } },
    { nameID: "ai_52", name: "ÁÑº„ÅçÈ≥•", personality: "aggressor", aimRate: 60, aggroRate: 70, sightRangeBlocks: 14, color: "#e67e22", linearRate: 60, appearanceRates: {"17":50,"18":60}, Pick: { julie: 30, jack: 50, sky: 20 } },
    { nameID: "ai_53", name: "Áù°Áú†‰∏çË∂≥", personality: "defender", aimRate: 40, aggroRate: 20, sightRangeBlocks: 12, color: "#34495e", linearRate: 10, appearanceRates: {"2":80,"3":90,"4":90}, Pick: { julie: 70, jack: 20, sky: 10 } },
    { nameID: "ai_54", name: "„Ç®„Éä„Éâ„É™‰∏≠ÊØí", personality: "aggressor", aimRate: 85, aggroRate: 90, sightRangeBlocks: 16, color: "#f1c40f", linearRate: 90, appearanceRates: {"22":70,"23":80,"0":80}, Pick: { julie: 10, jack: 80, sky: 10 } },
    { nameID: "ai_55", name: "ÈÄ±Êú´„ÅÆÊà¶Â£´", personality: "duelist", aimRate: 75, aggroRate: 60, sightRangeBlocks: 15, color: "#2ecc71", linearRate: 50, appearanceRates: {"20":60,"21":60}, Pick: { julie: 40, jack: 40, sky: 20 } },
    { nameID: "ai_56", name: "Player6309", personality: "duelist", aimRate: 95, aggroRate: 80, sightRangeBlocks: 20, color: "#e74c3c", linearRate: 70, appearanceRates: {"21":80,"22":80}, Pick: { julie: 40, jack: 40, sky: 20 } },
    { nameID: "ai_57", name: "Â§©Êâç„Éï„Ç£„ÉÉ„Ç∑„É•", personality: "defender", aimRate: 50, aggroRate: 30, sightRangeBlocks: 14, color: "#1abc9c", linearRate: 20, appearanceRates: {"19":50,"20":50}, Pick: { julie: 60, jack: 30, sky: 10 } },
    { nameID: "ai_58", name: "„É©„Ç∞‰Ωø„ÅÑ", personality: "aggressor", aimRate: 65, aggroRate: 50, sightRangeBlocks: 12, color: "#9b59b6", linearRate: 40, appearanceRates: {"15":40,"16":40}, Pick: { julie: 40, jack: 40, sky: 20 } },
    { nameID: "ai_59", name: "Player9239", personality: "defender", aimRate: 99, aggroRate: 10, sightRangeBlocks: 25, color: "#3498db", linearRate: 5, appearanceRates: {"12":10,"13":10}, Pick: { julie: 85, jack: 5, sky: 10 } },
    { nameID: "ai_60", name: "Player5762", personality: "defender", aimRate: 10, aggroRate: 0, sightRangeBlocks: 10, color: "#95a5a6", linearRate: 0, appearanceRates: {"10":90,"11":90}, Pick: { julie: 90, jack: 0, sky: 10 } },
    { nameID: "ai_61", name: "Ëø∑Â≠ê", personality: "defender", aimRate: 30, aggroRate: 10, sightRangeBlocks: 10, color: "#d35400", linearRate: 80, appearanceRates: {"14":50,"15":50}, Pick: { julie: 70, jack: 20, sky: 10 } },
    { nameID: "ai_62", name: "„Çπ„Éä„Ç§„Éë„Éº", personality: "duelist", aimRate: 98, aggroRate: 40, sightRangeBlocks: 28, color: "#2c3e50", linearRate: 10, appearanceRates: {"20":60,"21":60}, Pick: { julie: 60, jack: 30, sky: 10 } },
    { nameID: "ai_63", name: "ÁâπÊîªÈöäÈï∑", personality: "aggressor", aimRate: 50, aggroRate: 100, sightRangeBlocks: 15, color: "#c0392b", linearRate: 100, appearanceRates: {"18":70,"19":70}, Pick: { julie: 0, jack: 80, sky: 20 } },
    { nameID: "ai_64", name: "„Éí„Éº„É©„Éº", personality: "defender", aimRate: 60, aggroRate: 20, sightRangeBlocks: 14, color: "#27ae60", linearRate: 20, appearanceRates: {"12":40,"13":40}, Pick: { julie: 80, jack: 10, sky: 10 } },
    { nameID: "ai_65", name: "ÂÅΩÂ£Å", personality: "defender", aimRate: 20, aggroRate: 5, sightRangeBlocks: 10, color: "#7f8c8d", linearRate: 0, appearanceRates: {"0":50,"1":50}, Pick: { julie: 90, jack: 0, sky: 10 } },
    { nameID: "ai_66", name: "Ëçâ", personality: "defender", aimRate: 40, aggroRate: 10, sightRangeBlocks: 12, color: "#2ecc71", linearRate: 10, appearanceRates: {"10":30,"11":30}, Pick: { julie: 70, jack: 20, sky: 10 } },
    { nameID: "ai_67", name: "ÁÖΩ„ÇäËÄêÊÄß0", personality: "aggressor", aimRate: 70, aggroRate: 95, sightRangeBlocks: 16, color: "#e67e22", linearRate: 80, appearanceRates: {"21":70,"22":70}, Pick: { julie: 20, jack: 70, sky: 10 } },
    { nameID: "ai_68", name: "ÂÖ®‰∏Ä", personality: "duelist", aimRate: 97, aggroRate: 85, sightRangeBlocks: 22, color: "#f39c12", linearRate: 60, appearanceRates: {"22":80,"23":80}, Pick: { julie: 40, jack: 40, sky: 20 } },
    { nameID: "ai_69", name: "ÈôêÁïå„Ç™„Çø„ÇØ", personality: "aggressor", aimRate: 80, aggroRate: 70, sightRangeBlocks: 15, color: "#8e44ad", linearRate: 50, appearanceRates: {"0":90,"1":90}, Pick: { julie: 30, jack: 50, sky: 20 } },
    { nameID: "ai_70", name: "„Åù„Éº„Åæ„Çì", personality: "defender", aimRate: 50, aggroRate: 50, sightRangeBlocks: 15, color: "#2c3e50", linearRate: 30, appearanceRates: {"23":50,"0":50}, Pick: { julie: 50, jack: 30, sky: 20 } },
];

const camera = { x: 0, y: 0 };
const sticks = {
    left:  { active: false, startX: 0, startY: 0, currX: 0, currY: 0, angle: 0, dist: 0, id: -1 },
    right: { active: false, startX: 0, startY: 0, currX: 0, currY: 0, angle: 0, dist: 0, id: -1 }
};
const jumpBtn = { right: 80, bottom: 80, radius: 40 };
const charImages = { julie: new Image(), jack: new Image(), sky: new Image() };
charImages.julie.src = '„Ç∏„É•„É™„Éº.svg';
charImages.jack.src = '„Ç∏„É£„ÉÉ„ÇØ.svg';
charImages.sky.src = '„Çπ„Ç´„Ç§.svg';
const gunImages = { julie: new Image(), jack: new Image(), sky: new Image() };
gunImages.julie.src = '„Ç∏„É•„É™„ÉºÈäÉ.svg';
gunImages.jack.src = '„Ç∏„É£„ÉÉ„ÇØÈäÉ.svg';
gunImages.sky.src = '„Çπ„Ç´„Ç§ÈäÉ.svg';
const bgmHome = new Audio('„Éõ„Éº„É†.mp3');
bgmHome.loop = true;
const bgmMatch = new Audio('Ë©¶Âêà‰∏≠.mp3');
bgmMatch.loop = true;
const seAttack = new Audio('„Ç∏„É•„É™„ÉºÊîªÊíÉ.mp3');
const seHit = new Audio('Ë¢´Âºæ.mp3');
let currentBgm = null;

function updateBgmState() {
    let targetBgm = null;
    if (['home', 'ranking', 'loading', 'charSelect'].includes(gameState)) {
        targetBgm = bgmHome;
    } else if (['matching', 'countdown', 'playing', 'spectating', 'result'].includes(gameState)) {
        targetBgm = bgmMatch;
    }

    if (currentBgm !== targetBgm) {
        if (currentBgm) {
            currentBgm.pause();
            currentBgm.currentTime = 0;
        }
        currentBgm = targetBgm;
        if (currentBgm) {
            currentBgm.volume = bgmVolume;
            currentBgm.play().catch(() => {});
        }
    }
}

function playSound(audio) {
    const sound = audio.cloneNode();
    sound.volume = bgmVolume;
    sound.play().catch(() => {});
}

let isEditor = false;
let gameState = 'home'; // home, matching, countdown, playing, spectating, result, loading, ranking, charSelect
let matchingTime = 0;
let countdownTime = 3;
let editorTool = 0; // 0:Block, 1:Platform, 2:Fence, -1:Erase
let editorColor = '#8d4433';
const keys = {};
let isMouseDown = false;

loadPlayerData();
loadAIRates();
processOfflineMatches(); // „Ç™„Éï„É©„Ç§„É≥ÈÄ≤Ë°å„ÉÅ„Çß„ÉÉ„ÇØ
startSession([]); // ÂàùÂõû„ÅØÁ©∫„ÅßÈñãÂßãÔºà„Éõ„Éº„É†ÁîªÈù¢Áî®Ôºâ

// --- „Ç®„Éá„Ç£„ÇøÊ©üËÉΩ ---
function toggleMode() {
    isEditor = !isEditor;
    document.getElementById('editorUI').style.display = isEditor ? 'block' : 'none';
    document.getElementById('modeBtn').innerText = isEditor ? 'Play Mode' : 'Edit Mode';
    player.vx = 0; player.vy = 0; // Âàá„ÇäÊõø„ÅàÊôÇ„Å´ÂÅúÊ≠¢
    sticks.left.active = false; sticks.right.active = false;
}
function setColor(c) { editorColor = c; }
function setTool(t) {
    editorTool = t;
    const names = {0:'Block', 1:'Platform', 2:'Fence', '-1':'Erase', 10:'Spawn 1', 11:'Spawn 2', 12:'Spawn 3', 13:'Spawn 4'};
    document.getElementById('toolName').innerText = names[t] || 'Unknown';
}
function saveMap() {
    document.getElementById('mapOutput').value = JSON.stringify(platforms);
}
function loadMap() {
    try {
        const data = JSON.parse(document.getElementById('mapOutput').value);
        if (Array.isArray(data)) { platforms = data; alert('Map Loaded!'); }
    } catch(e) { alert('Invalid Code'); }
}
function handleEditorInput(x, y) {
    const wx = x + camera.x;
    const wy = y + camera.y;
    const gx = Math.floor(wx / TILE_SIZE) * TILE_SIZE;
    const gy = Math.floor(wy / TILE_SIZE) * TILE_SIZE;

    // Êó¢Â≠ò„ÅÆ„Éñ„É≠„ÉÉ„ÇØ„ÇíÊé¢„Åô
    const existingIdx = platforms.findIndex(p => 
        p.x === gx && p.y === gy && p.w === TILE_SIZE && p.h === TILE_SIZE
    );

    // „Çπ„Éù„Éº„É≥Âú∞ÁÇπ„ÅÆÈÖçÁΩÆ (ÈáçË§áÂâäÈô§)
    if (editorTool >= 10) {
        const idx = platforms.findIndex(p => p.type === editorTool);
        if (idx !== -1) platforms.splice(idx, 1);
        platforms.push({ x: gx, y: gy, w: TILE_SIZE, h: TILE_SIZE, type: editorTool, color: editorColor });
        return;
    }

    if (editorTool === -1) {
        // ÂâäÈô§ (Èáç„Å™„Å£„Å¶„ÅÑ„Çã„ÇÇ„ÅÆ„ÇíÂâäÈô§)
        for (let i = platforms.length - 1; i >= 0; i--) {
            const p = platforms[i];
            if (wx >= p.x && wx < p.x + p.w && wy >= p.y && wy < p.y + p.h) platforms.splice(i, 1);
        }
    } else {
        // ÈÖçÁΩÆ (Âêå„ÅòÂ†¥ÊâÄ„Å´Âêå„Åò„Çø„Ç§„Éó„Åå„ÅÇ„Çå„Å∞‰Ωï„ÇÇ„Åó„Å™„ÅÑ)
        if (existingIdx === -1) {
            platforms.push({ x: gx, y: gy, w: TILE_SIZE, h: TILE_SIZE, type: editorTool, color: editorColor });
        } else {
            platforms[existingIdx].type = editorTool;
            platforms[existingIdx].color = editorColor;
        }
    }
}

function updateEloRates(rankedEntities, isSimulation = false) {
    const n = rankedEntities.length;
    if (n < 2) return;

    // K„Éï„Ç°„ÇØ„Çø„Éº (1Ë©¶Âêà„ÅÇ„Åü„Çä„ÅÆÂ§âÂãïÂπÖ‰øÇÊï∞)
    // 3Ë©¶ÂêàÂàÜÂêàË®à„Åï„Çå„Çã„ÅÆ„Åß„ÄÅÈÄöÂ∏∏„ÅÆElo„Çà„ÇäÂ∞è„Åï„ÇÅ„Å´Ë®≠ÂÆö
    const K = 16; 

    // È†Ü‰ΩçË£úÊ≠£ (ÂèÇÂä†Ë≤ª„É¢„Éá„É´)
    // ÂÖ®Âì°„Åã„Çâ entryCost „ÇíÂºï„Åç„ÄÅ1‰Ωç„Å´ (n * entryCost) „ÇíÂä†ÁÆó„Åô„Çã
    // „Åì„Çå„Å´„Çà„Çä„ÄÅÂêåÊ†ºÁõ∏Êâã„ÅÆÂ†¥Âêà„ÄÅ2‰Ωç‰ª•‰∏ã„Åå„Éû„Ç§„Éä„Çπ„Å´„Å™„Çã„Çà„ÅÜ„Å´Ë™øÊï¥
    // K=16„ÅÆÂ†¥Âêà„ÄÅÂêåÊ†º2‰Ωç„ÅÆEloÁç≤ÂæóÂàÜ„ÅØ +8 „Å™„ÅÆ„Åß„ÄÅentryCost„Çí20„Å´„Åô„Çå„Å∞ 8-20=-12 „Å®„Å™„Çã
    const entryCost = 20;

    // 1. Elo„Å´„Çà„ÇãÁ∑èÂΩì„Åü„ÇäÂ§âÂãïË®àÁÆó
    const eloChanges = new Array(n).fill(0);
    
    for (let i = 0; i < n; i++) {
        for (let j = i + 1; j < n; j++) {
            const winner = rankedEntities[i];
            const loser = rankedEntities[j];
            
            const rateA = getRate(winner);
            const rateB = getRate(loser);
            
            // ÂãùÁéáÊúüÂæÖÂÄ§
            const expectedA = 1 / (1 + Math.pow(10, (rateB - rateA) / 400));
            const expectedB = 1 / (1 + Math.pow(10, (rateA - rateB) / 400));
            
            // Â§âÂãïË®àÁÆó
            const deltaA = K * (1 - expectedA);
            const deltaB = K * (0 - expectedB);
            
            eloChanges[i] += deltaA;
            eloChanges[j] += deltaB;
        }
    }

    // 2. È†Ü‰ΩçË£úÊ≠£„Å®ÈÅ©Áî®
    rankedEntities.forEach((entity, i) => {
        let change = eloChanges[i];
        
        // ÂèÇÂä†Ë≤ªÂæ¥Âèé
        change -= entryCost;
        
        // 1‰Ωç„Éú„Éº„Éä„Çπ (Á∑èÂèñ„Çä)
        if (i === 0) {
            change += entryCost * n;
        }

        change = Math.round(change);

        if (entity === player) {
            player.rate = Math.round(player.rate + change);
            if (!player.rateHistory) player.rateHistory = [1500];
            player.rateHistory.push(player.rate);
            if (player.rateHistory.length > 50) player.rateHistory.shift();
            savePlayerData(); // „É¨„Éº„ÉàÂ§âÂãïÊôÇ„Å´Âç≥‰øùÂ≠ò
        }
        else {
            const id = entity.nameID || (entity.ai ? entity.ai.nameID : null);
            if (id && aiRates[id] !== undefined) aiRates[id] = Math.round(aiRates[id] + change);
        }
    });
}

// --- „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº ---
canvas.addEventListener('touchstart', e => {
    e.preventDefault();
    if (currentBgm && currentBgm.paused) {
        currentBgm.play().catch(() => {});
    }
    if (gameState === 'home') {
        const t = e.changedTouches[0], x = t.clientX, y = t.clientY;

        // Volume Slider
        const slider = { x: canvas.width - 160, y: canvas.height - 50, w: 150, h: 40 };
        if (x > slider.x && x < slider.x + slider.w && y > slider.y && y < slider.y + slider.h) {
            isDraggingVolumeSlider = true;
            const newVolume = (x - slider.x) / slider.w;
            bgmVolume = Math.max(0, Math.min(1, newVolume));
            if (bgmHome) bgmHome.volume = bgmVolume;
            if (bgmMatch) bgmMatch.volume = bgmVolume;
            return;
        }

        // Top-left name click area
        if (x > 10 && x < 250 && y > 10 && y < 80) {
            const newName = prompt('Enter new name (max 10 chars):', player.name);
            if (newName && newName.trim() !== '') {
                player.name = newName.trim().substring(0, 10);
                savePlayerData();
            }
            return;
        }
        
        // Export Button
        const exportBtn = { x: 10, y: canvas.height - 150, w: 150, h: 40 };
        if (x > exportBtn.x && x < exportBtn.x + exportBtn.w && y > exportBtn.y && y < exportBtn.y + exportBtn.h) {
            const backup = {
                player: JSON.parse(localStorage.getItem('sb_playerData') || '{}'),
                ai: JSON.parse(localStorage.getItem('sb_aiRates') || '{}')
            };
            const code = JSON.stringify(backup);
            prompt("‰ª•‰∏ã„ÅÆ„Ç≥„Éº„Éâ„Çí„Ç≥„Éî„Éº„Åó„Å¶‰øùÂ≠ò„Åó„Å¶„Åè„Å†„Åï„ÅÑ (Save Code):", code);
            return;
        }

        // Import Button
        const importBtn = { x: 10, y: canvas.height - 100, w: 150, h: 40 };
        if (x > importBtn.x && x < importBtn.x + importBtn.w && y > importBtn.y && y < importBtn.y + importBtn.h) {
            const code = prompt("‰øùÂ≠ò„Åó„Åü„Ç≥„Éº„Éâ„ÇíË≤º„Çä‰ªò„Åë„Å¶„Åè„Å†„Åï„ÅÑ (Paste Code):");
            if (code) {
                try {
                    const data = JSON.parse(code);
                    if (data.player) localStorage.setItem('sb_playerData', JSON.stringify(data.player));
                    if (data.ai) localStorage.setItem('sb_aiRates', JSON.stringify(data.ai));
                    loadPlayerData();
                    loadAIRates();
                    alert("„Éá„Éº„Çø„ÇíÂæ©ÂÖÉ„Åó„Åæ„Åó„ÅüÔºÅ");
                } catch(e) { alert("„Ç≥„Éº„Éâ„ÅåÊ≠£„Åó„Åè„ÅÇ„Çä„Åæ„Åõ„Çì"); }
            }
            return;
        }

        // Data Reset Button
        const resetBtn = { x: 10, y: canvas.height - 50, w: 150, h: 40 };
        if (x > resetBtn.x && x < resetBtn.x + resetBtn.w && y > resetBtn.y && y < resetBtn.y + resetBtn.h) {
            if (confirm('Êú¨ÂΩì„Å´„Åô„Åπ„Å¶„ÅÆ„Éá„Éº„ÇøÔºàÂêçÂâçÔºâ„Çí„É™„Çª„ÉÉ„Éà„Åó„Åæ„Åô„ÅãÔºü„Åì„ÅÆÊìç‰Ωú„ÅØÂÖÉ„Å´Êàª„Åõ„Åæ„Åõ„Çì„ÄÇ')) {
                localStorage.removeItem('sb_playerData');
                loadPlayerData();
            }
            return;
        }

        // Ranking Button
        const rankBtn = { x: canvas.width - 160, y: 10, w: 150, h: 40 };
        if (x > rankBtn.x && x < rankBtn.x + rankBtn.w && y > rankBtn.y && y < rankBtn.y + rankBtn.h) {
            gameState = 'ranking';
            rankingScrollY = 0;
            rankingData = aiSamples.map(ai => ({ name: ai.name, rate: aiRates[ai.nameID] || 1500, isPlayer: false }));
            rankingData.push({ name: player.name, rate: player.rate, isPlayer: true });
            rankingData.sort((a, b) => b.rate - a.rate);
            return;
        }
        
        // Play Button
        const playBtn = { x: canvas.width / 2 - 100, y: canvas.height - 120, w: 200, h: 50 };
        if (x > playBtn.x && x < playBtn.x + playBtn.w && y > playBtn.y && y < playBtn.y + playBtn.h) {
            homeParticles = [];
            gameState = 'matching';
            matchingTime = 20; // 20ÁßíÂæÖÊ©ü
            platforms = loadingPlatforms;
            player.x = 20100; player.y = 800;
            player.vx = 0; player.vy = 0;
            
            // „Éû„ÉÉ„ÉÅ„É≥„Ç∞ÂàùÊúüÂåñ
            const currentHour = new Date().getHours();
            const schedule = getDailySchedule(aiSamples);
            
            // ÁèæÂú®„ÅÆÊôÇÈñìÂ∏Ø„Åß„Ç™„É≥„É©„Ç§„É≥„ÅÆAI„ÇíÊäΩÂá∫
            const onlineAIs = aiSamples.filter(ai => schedule[ai.nameID] && schedule[ai.nameID][currentHour]);
            
            // „É©„É≥„ÉÄ„É†„Å´3‰ΩìÈÅ∏Âá∫
            pendingEnemies = [];
            joinedEnemies = [];
            for (let i = onlineAIs.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [onlineAIs[i], onlineAIs[j]] = [onlineAIs[j], onlineAIs[i]];
            }
            const candidates = onlineAIs.slice(0, 3);
            
            candidates.forEach(ai => {
                // „Éû„ÉÉ„ÉÅ„É≥„Ç∞ÊôÇ„Å´„É¨„Éô„É´„Çí„É©„É≥„ÉÄ„É†Ë®≠ÂÆö (1~50)
                const aiLevel = Math.floor(Math.random() * 50) + 1;
                // 20Áßí‰ª•ÂÜÖ„Å´„É©„É≥„ÉÄ„É†„Å™„Çø„Ç§„Éü„É≥„Ç∞„ÅßÂÖ•ÂÆ§ (ÊÆã„ÇäÊôÇÈñì 18s ~ 2s „ÅÆÈñì)
                // AI„Çµ„É≥„Éó„É´„Çí„Ç≥„Éî„Éº„Åó„Å¶„É¨„Éô„É´ÊÉÖÂ†±„Çí‰ªò‰∏é
                pendingEnemies.push({ ai: { ...ai, level: aiLevel }, joinTime: 18 - Math.random() * 16 });
            });
        }
        // Character Select Button
        const charBtn = { x: canvas.width / 2 - 100, y: canvas.height - 60, w: 200, h: 40 };
        if (x > charBtn.x && x < charBtn.x + charBtn.w && y > charBtn.y && y < charBtn.y + charBtn.h) {
            gameState = 'charSelect';
            selectedCharInUI = player.charType;
            return;
        }
        return;
    }
    if (gameState === 'ranking') {
        // Close Button
        rankingTouchStartY = e.changedTouches[0].clientY;
        const closeBtn = { x: canvas.width/2 - 50, y: canvas.height - 80, w: 100, h: 40 };
        if (e.changedTouches[0].clientX > closeBtn.x && e.changedTouches[0].clientX < closeBtn.x + closeBtn.w && e.changedTouches[0].clientY > closeBtn.y && e.changedTouches[0].clientY < closeBtn.y + closeBtn.h) {
            gameState = 'home';
        }
        return;
    }
    if (gameState === 'charSelect') {
        const t = e.changedTouches[0], x = t.clientX, y = t.clientY;
        const charList = Object.keys(characterStats);
        const currentIndex = charList.indexOf(selectedCharInUI);

        // Left Arrow
        if (x > 20 && x < 140 && y > canvas.height/2 - 50 && y < canvas.height/2 + 50) {
            const newIndex = (currentIndex - 1 + charList.length) % charList.length;
            selectedCharInUI = charList[newIndex];
            return;
        }
        // Right Arrow
        if (x > canvas.width - 140 && x < canvas.width - 20 && y > canvas.height/2 - 50 && y < canvas.height/2 + 50) {
            const newIndex = (currentIndex + 1) % charList.length;
            selectedCharInUI = charList[newIndex];
            return;
        }

        // Select Button
        const selectBtn = { x: canvas.width / 2 - 100, y: canvas.height - 60, w: 200, h: 40 };
        if (x > selectBtn.x && x < selectBtn.x + selectBtn.w && y > selectBtn.y && y < selectBtn.y + selectBtn.h) {
            setPlayerCharacter(selectedCharInUI);
            gameState = 'home';
            return;
        }

        // Back Button
        const backBtn = { x: 20, y: 20, w: 100, h: 40 };
        if (x > backBtn.x && x < backBtn.x + backBtn.w && y > backBtn.y && y < backBtn.y + backBtn.h) {
            gameState = 'home';
            return;
        }
        return;
    }
    if (gameState === 'spectating' && showResultButton) {
        const t = e.changedTouches[0];
        const cx = canvas.width / 2;
        const cy = canvas.height / 2;
        if (Math.abs(t.clientX - cx) < 100 && Math.abs(t.clientY - (cy + 100)) < 25) {
            gameState = 'result';
        }
        return;
    }
    if (gameState === 'result') {
        const t = e.changedTouches[0];
        const cx = canvas.width / 2;
        const cy = canvas.height / 2;
        if (Math.abs(t.clientX - cx) < 100 && Math.abs(t.clientY - (cy + 150)) < 25) {
            gameState = 'home';
            homeParticles = [];
            loadPlayerData();
            loadAIRates();
            processOfflineMatches();
            startSession([]);
            lastOnlineUpdate = 0;
        }
        return;
    }
    if (isEditor) {
        for (let t of e.changedTouches) {
            // UI„Ç®„É™„Ç¢„ÅÆÁ∞°ÊòìÂà§ÂÆö (Â∑¶‰∏ä„ÅØÈô§Â§ñ„Åó„Åü„ÅÑ„Åå„ÄÅcanvasÂÖ®‰Ωì„ÅßÂèñ„Çã)
            if (t.clientY < 150 && t.clientX < 250) continue; // UI‰ªòËøë„ÅØÁÑ°Ë¶ñ
            
            // Â∑¶‰∏ã‰ªòËøë„ÅØ„Ç´„É°„É©ÁßªÂãïÁî®„Çπ„ÉÜ„Ç£„ÉÉ„ÇØ„Å®„Åø„Å™„Åô
            if (t.clientX < canvas.width / 2 && t.clientY > canvas.height / 2) {
                initStick(sticks.left, t);
            } else {
                handleEditorInput(t.clientX, t.clientY);
            }
        }
        return;
    }

    for (let t of e.changedTouches) {
        // „Ç∏„É£„É≥„Éó„Éú„Çø„É≥Âà§ÂÆö
        let jbx = canvas.width - jumpBtn.right, jby = canvas.height - jumpBtn.bottom;
        if (Math.hypot(t.clientX - jbx, t.clientY - jby) < jumpBtn.radius) {
            if (player.jumpCount < player.maxJumps) { player.vy = JUMP_FORCE; player.onGround = false; player.jumpCount++; }
            // „Ç∏„É£„É≥„Éó„Ç®„Éï„Çß„ÇØ„Éà
            for(let i=0; i<10; i++) {
                particles.push({
                    x: player.x + (Math.random()-0.5)*40, y: player.y + player.radius,
                    vx: (Math.random()-0.5)*3, vy: Math.random()*2, life: 20, maxLife: 20, color: '#fff', size: Math.random()*5+2
                });
            }
            continue;
        }

        if (t.clientX < canvas.width / 2) initStick(sticks.left, t);
        else initStick(sticks.right, t);
    }
}, {passive: false});

canvas.addEventListener('touchmove', e => {
    if (isDraggingVolumeSlider) {
        const t = e.changedTouches[0], x = t.clientX;
        const slider = { x: canvas.width - 160, y: canvas.height - 50, w: 150, h: 40 };
        const newVolume = (x - slider.x) / slider.w;
        bgmVolume = Math.max(0, Math.min(1, newVolume));
        if (bgmHome) bgmHome.volume = bgmVolume;
        if (bgmMatch) bgmMatch.volume = bgmVolume;
        return;
    }

    if (isEditor) {
        for (let t of e.changedTouches) {
            if (sticks.left.id === t.identifier) {
                updateStick(sticks.left, t);
            } else if (t.clientY >= 150 || t.clientX >= 250) { // UI„Ç®„É™„Ç¢Â§ñ
                handleEditorInput(t.clientX, t.clientY);
            }
        }
        return;
    }
    for (let t of e.changedTouches) {
        if (sticks.left.id === t.identifier) {
            updateStick(sticks.left, t);
        } else if (sticks.right.id === t.identifier) updateStick(sticks.right, t);
    }
}, {passive: false});

canvas.addEventListener('touchend', e => {
    if (isDraggingVolumeSlider) {
        isDraggingVolumeSlider = false;
        savePlayerData();
    }
    for (let t of e.changedTouches) {
        if (sticks.left.id === t.identifier) { sticks.left.active = false; sticks.left.id = -1; player.vx = 0; }
        if (sticks.right.id === t.identifier) {
            if (sticks.right.dist > 15) tryShoot();
            sticks.right.active = false; sticks.right.id = -1;
        }
    }
});

window.addEventListener('touchend', e => {
    // ... (existing code handles this via changedTouches loop above, but let's ensure consistency if needed)
});

window.addEventListener('keydown', e => keys[e.code] = true);
window.addEventListener('keyup', e => keys[e.code] = false);

window.addEventListener('mousedown', e => {
    if (currentBgm && currentBgm.paused) {
        currentBgm.play().catch(() => {});
    }
    if (gameState === 'home') {
        const x = e.clientX, y = e.clientY;

        // Volume Slider
        const slider = { x: canvas.width - 160, y: canvas.height - 50, w: 150, h: 40 };
        if (x > slider.x && x < slider.x + slider.w && y > slider.y && y < slider.y + slider.h) {
            isDraggingVolumeSlider = true;
            const newVolume = (x - slider.x) / slider.w;
            bgmVolume = Math.max(0, Math.min(1, newVolume));
            if (bgmHome) bgmHome.volume = bgmVolume;
            if (bgmMatch) bgmMatch.volume = bgmVolume;
            return;
        }

        // Top-left name click area
        if (x > 10 && x < 250 && y > 10 && y < 80) {
            const newName = prompt('Enter new name (max 10 chars):', player.name);
            if (newName && newName.trim() !== '') {
                player.name = newName.trim().substring(0, 10);
                savePlayerData();
            }
            return;
        }
        
        // Export Button
        const exportBtn = { x: 10, y: canvas.height - 150, w: 150, h: 40 };
        if (x > exportBtn.x && x < exportBtn.x + exportBtn.w && y > exportBtn.y && y < exportBtn.y + exportBtn.h) {
            const backup = {
                player: JSON.parse(localStorage.getItem('sb_playerData') || '{}'),
                ai: JSON.parse(localStorage.getItem('sb_aiRates') || '{}')
            };
            const code = JSON.stringify(backup);
            prompt("‰ª•‰∏ã„ÅÆ„Ç≥„Éº„Éâ„Çí„Ç≥„Éî„Éº„Åó„Å¶‰øùÂ≠ò„Åó„Å¶„Åè„Å†„Åï„ÅÑ (Save Code):", code);
            return;
        }

        // Import Button
        const importBtn = { x: 10, y: canvas.height - 100, w: 150, h: 40 };
        if (x > importBtn.x && x < importBtn.x + importBtn.w && y > importBtn.y && y < importBtn.y + importBtn.h) {
            const code = prompt("‰øùÂ≠ò„Åó„Åü„Ç≥„Éº„Éâ„ÇíË≤º„Çä‰ªò„Åë„Å¶„Åè„Å†„Åï„ÅÑ (Paste Code):");
            if (code) {
                try {
                    const data = JSON.parse(code);
                    if (data.player) localStorage.setItem('sb_playerData', JSON.stringify(data.player));
                    if (data.ai) localStorage.setItem('sb_aiRates', JSON.stringify(data.ai));
                    loadPlayerData();
                    loadAIRates();
                    alert("„Éá„Éº„Çø„ÇíÂæ©ÂÖÉ„Åó„Åæ„Åó„ÅüÔºÅ");
                } catch(e) { alert("„Ç≥„Éº„Éâ„ÅåÊ≠£„Åó„Åè„ÅÇ„Çä„Åæ„Åõ„Çì"); }
            }
            return;
        }

        // Data Reset Button
        const resetBtn = { x: 10, y: canvas.height - 50, w: 150, h: 40 };
        if (x > resetBtn.x && x < resetBtn.x + resetBtn.w && y > resetBtn.y && y < resetBtn.y + resetBtn.h) {
            if (confirm('Êú¨ÂΩì„Å´„Åô„Åπ„Å¶„ÅÆ„Éá„Éº„ÇøÔºàÂêçÂâçÔºâ„Çí„É™„Çª„ÉÉ„Éà„Åó„Åæ„Åô„ÅãÔºü„Åì„ÅÆÊìç‰Ωú„ÅØÂÖÉ„Å´Êàª„Åõ„Åæ„Åõ„Çì„ÄÇ')) {
                localStorage.removeItem('sb_playerData');
                loadPlayerData();
            }
            return;
        }

        // Ranking Button
        const rankBtn = { x: canvas.width - 160, y: 10, w: 150, h: 40 };
        if (x > rankBtn.x && x < rankBtn.x + rankBtn.w && y > rankBtn.y && y < rankBtn.y + rankBtn.h) {
            gameState = 'ranking';
            rankingScrollY = 0;
            rankingData = aiSamples.map(ai => ({ name: ai.name, rate: aiRates[ai.nameID] || 1500, isPlayer: false }));
            rankingData.push({ name: player.name, rate: player.rate, isPlayer: true });
            rankingData.sort((a, b) => b.rate - a.rate);
            return;
        }
        
        // Play Button
        const playBtn = { x: canvas.width / 2 - 100, y: canvas.height - 120, w: 200, h: 50 };
        if (x > playBtn.x && x < playBtn.x + playBtn.w && y > playBtn.y && y < playBtn.y + playBtn.h) {
            homeParticles = [];
            gameState = 'matching';
            matchingTime = 20;
            platforms = loadingPlatforms;
            player.x = 20100; player.y = 800;
            player.vx = 0; player.vy = 0;
            
            const currentHour = new Date().getHours();
            const schedule = getDailySchedule(aiSamples);
            const onlineAIs = aiSamples.filter(ai => schedule[ai.nameID] && schedule[ai.nameID][currentHour]);
            
            pendingEnemies = [];
            joinedEnemies = [];
            for (let i = onlineAIs.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [onlineAIs[i], onlineAIs[j]] = [onlineAIs[j], onlineAIs[i]];
            }
            const candidates = onlineAIs.slice(0, 3);
            
            candidates.forEach(ai => {
                // AI„Çµ„É≥„Éó„É´„Çí„Ç≥„Éî„Éº
                pendingEnemies.push({ ai: { ...ai }, joinTime: 18 - Math.random() * 16 });
            });
        }
        // Character Select Button
        const charBtn = { x: canvas.width / 2 - 100, y: canvas.height - 60, w: 200, h: 40 };
        if (x > charBtn.x && x < charBtn.x + charBtn.w && y > charBtn.y && y < charBtn.y + charBtn.h) {
            gameState = 'charSelect';
            selectedCharInUI = player.charType;
            return;
        }
        return;
    }
    if (gameState === 'ranking') {
        // Close Button
        const closeBtn = { x: canvas.width/2 - 50, y: canvas.height - 80, w: 100, h: 40 };
        if (e.clientX > closeBtn.x && e.clientX < closeBtn.x + closeBtn.w && e.clientY > closeBtn.y && e.clientY < closeBtn.y + closeBtn.h) {
            gameState = 'home';
        }
        return;
    }
    if (gameState === 'charSelect') {
        const x = e.clientX, y = e.clientY;
        const charList = Object.keys(characterStats);
        const currentIndex = charList.indexOf(selectedCharInUI);

        // Left Arrow
        if (x > 20 && x < 140 && y > canvas.height/2 - 50 && y < canvas.height/2 + 50) {
            const newIndex = (currentIndex - 1 + charList.length) % charList.length;
            selectedCharInUI = charList[newIndex];
            return;
        }
        // Right Arrow
        if (x > canvas.width - 140 && x < canvas.width - 20 && y > canvas.height/2 - 50 && y < canvas.height/2 + 50) {
            const newIndex = (currentIndex + 1) % charList.length;
            selectedCharInUI = charList[newIndex];
            return;
        }

        // Select Button
        const selectBtn = { x: canvas.width / 2 - 100, y: canvas.height - 60, w: 200, h: 40 };
        if (x > selectBtn.x && x < selectBtn.x + selectBtn.w && y > selectBtn.y && y < selectBtn.y + selectBtn.h) {
            setPlayerCharacter(selectedCharInUI);
            gameState = 'home';
            return;
        }

        // Back Button
        const backBtn = { x: 20, y: 20, w: 100, h: 40 };
        if (x > backBtn.x && x < backBtn.x + backBtn.w && y > backBtn.y && y < backBtn.y + backBtn.h) {
            gameState = 'home';
            return;
        }
        return;
    }
    if (gameState === 'ranking') {
        const deltaY = rankingTouchStartY - e.changedTouches[0].clientY;
        rankingScrollY += deltaY;
        rankingTouchStartY = e.changedTouches[0].clientY;
        return;
    }
    if (gameState === 'spectating' && showResultButton) {
        const cx = canvas.width / 2;
        const cy = canvas.height / 2;
        if (Math.abs(e.clientX - cx) < 100 && Math.abs(e.clientY - (cy + 100)) < 25) {
            gameState = 'result';
        }
        return;
    }
    if (gameState === 'result') {
        const cx = canvas.width / 2;
        const cy = canvas.height / 2;
        if (Math.abs(e.clientX - cx) < 100 && Math.abs(e.clientY - (cy + 150)) < 25) {
            gameState = 'home';
            homeParticles = [];
            loadPlayerData();
            loadAIRates();
            processOfflineMatches();
            startSession([]);
            lastOnlineUpdate = 0;
        }
        return;
    }
    if (!isEditor) return;
    if (e.target !== canvas) return;
    isMouseDown = true;
    handleEditorInput(e.clientX, e.clientY);
});
window.addEventListener('mousemove', e => {
    if (isDraggingVolumeSlider) {
        const x = e.clientX;
        const slider = { x: canvas.width - 160, y: canvas.height - 50, w: 150, h: 40 };
        const newVolume = (x - slider.x) / slider.w;
        bgmVolume = Math.max(0, Math.min(1, newVolume));
        if (bgmHome) bgmHome.volume = bgmVolume;
        if (bgmMatch) bgmMatch.volume = bgmVolume;
        return;
    }
    if (!isEditor || !isMouseDown) return;
    handleEditorInput(e.clientX, e.clientY);
});
window.addEventListener('mouseup', () => {
    if (isDraggingVolumeSlider) {
        isDraggingVolumeSlider = false;
        savePlayerData();
    }
    isMouseDown = false;
});

function initStick(s, t) { s.active = true; s.id = t.identifier; s.startX = t.clientX; s.startY = t.clientY; s.currX = t.clientX; s.currY = t.clientY; s.dist = 0; }
function updateStick(s, t) { s.currX = t.clientX; s.currY = (s === sticks.left) ? s.startY : t.clientY; let dx = s.currX - s.startX, dy = s.currY - s.startY; s.dist = Math.min(Math.sqrt(dx*dx+dy*dy), 50); s.angle = Math.atan2(dy, dx); }

function tryShoot() { // Player shoot
    triggerShoot(player, sticks.right.angle);
}

function triggerShoot(shooter, angle, bulletList = null) {
    if (shooter.attackCooldown > 0) return;
    if (shooter.energy >= 1) {
        if (!bulletList) playSound(seAttack);
        shooter.energy -= 1;
        
        if (shooter.charType === 'jack') {
            shooter.attackCooldown = 30;
            // „Ç∑„Éß„ÉÉ„Éà„Ç¨„É≥ (12Áô∫Êï£Âºæ)
            for (let i = 0; i < 12; i++) {
                spawnBullet(shooter, angle, bulletList, 3.33, 0.4); // „ÉÄ„É°„Éº„Ç∏1/3, Êã°Êï£Â§ß
            }
        } else if (shooter.charType === 'sky') {
            shooter.attackCooldown = 30; // „Ç∏„É•„É™„Éº„ÅÆ1.8ÂÄçÈÄü
            spawnBullet(shooter, angle, bulletList, 35, 0.04, 10, 2); // 5ÂÄç„ÉÄ„É°„Éº„Ç∏, ÂºæÈÄü2ÂÄç
            spawnBullet(shooter, angle, bulletList, 35, 0.04, -10, 2); // 2Âàó1ÊÆµ
        } else {
            shooter.attackCooldown = 30;
            // „Ç∏„É•„É™„Éº („Éê„Éº„Çπ„Éà)
            shooter.burstRemaining = 4;
            shooter.burstAngle = angle;
            shooter.burstTimer = 0;
            shooter.targetBulletList = bulletList;
        }
    }
}

function processBurst(shooter) {
    if (shooter.attackCooldown > 0) shooter.attackCooldown--;
    if (shooter.burstRemaining > 0) {
        shooter.burstTimer--;
        if (shooter.burstTimer <= 0) {
            spawnBullet(shooter, shooter.burstAngle, shooter.targetBulletList, 10, 0.08); // ÈÄöÂ∏∏„ÉÄ„É°„Éº„Ç∏
            shooter.burstRemaining--;
            shooter.burstTimer = 5; // ~80ms
        }
    }
}

function spawnBullet(shooter, angle, bulletList, damage = 10, spreadFactor = 0.08, offset = 0, speedMult = 1) {
    // spreadFactor: 0.08 is approx 5 degrees, 0.4 is approx 23 degrees
    const spread = (Math.random() - 0.5) * spreadFactor;
    const finalAngle = angle + spread;

    const floatY = bulletList ? 0 : Math.sin(Date.now() / 500) * 10; // „Ç∑„Éü„É•„É¨„Éº„Ç∑„Éß„É≥ÊôÇ„ÅØÊè∫„Çå„Å™„Åó
    const dist = 118;
    let bx = shooter.x + Math.cos(finalAngle) * dist;
    let by = shooter.y + floatY + Math.sin(finalAngle) * dist;

    if (offset !== 0) {
        const perpAngle = finalAngle + Math.PI / 2;
        bx += Math.cos(perpAngle) * offset;
        by += Math.sin(perpAngle) * offset;
    }
    
    // ‰∏≠ÂøÉ„Åã„ÇâÈäÉÂè£„Åæ„Åß„ÅÆÂΩì„Åü„ÇäÂà§ÂÆö
    let hit = false;
    let hx = shooter.x, hy = shooter.y + floatY;
    const checkSteps = 24;
    const dx = (bx - hx) / checkSteps;
    const dy = (by - hy) / checkSteps;
    
    for(let k=0; k<checkSteps; k++) {
        hx += dx; hy += dy;
        if (platforms.some(p => {
            const hitH = p.type === 1 ? p.h / 2 : p.h;
            return p.type < 10 && (p.type === 0 || p.type === 1) && hx > p.x && hx < p.x + p.w && hy > p.y && hy < p.y + hitH;
        })) {
            hit = true;
            break;
        }
    }
    
    if (hit) {
        if (!bulletList) for(let j=0; j<5; j++) particles.push({ x: hx, y: hy, vx: (Math.random()-0.5)*5, vy: (Math.random()-0.5)*5, life: 15, maxLife: 15, color: '#e0ffff', size: Math.random()*3+1 });
    } else {
        const speed = BULLET_SPEED * speedMult;
        const b = { 
            x: bx, y: by, vx: Math.cos(finalAngle) * speed, vy: Math.sin(finalAngle) * speed,
            owner: shooter,
            damage: damage,
            charType: shooter.charType || 'julie'
        };
        if (bulletList) bulletList.push(b);
        else {
            bullets.push(b);
            const effectColor = shooter.charType === 'jack' ? '#ff4040' : (shooter.charType === 'sky' ? '#fffacd' : '#00d2ff');
            for(let i=0; i<8; i++) particles.push({ x: bx, y: by, vx: Math.cos(finalAngle)*5 + (Math.random()-0.5)*5, vy: Math.sin(finalAngle)*5 + (Math.random()-0.5)*5, life: 10, maxLife: 10, color: effectColor, size: Math.random()*4+2 });
        }
    }
}

function spawnHealEffect(x, y) {
    for(let i=0; i<8; i++) {
        particles.push({
            x: x + (Math.random()-0.5)*40, y: y + (Math.random()-0.5)*40,
            vx: (Math.random()-0.5)*1, vy: -Math.random()*2 - 1,
            life: 30, maxLife: 30, color: '#00ff00', size: Math.random()*4+2
        });
    }
}

function spawnHomeParticle() {
    if (homeParticles.length > 50) return;
    homeParticles.push({
        x: Math.random() * canvas.width,
        y: Math.random() * canvas.height,
        vx: (Math.random() - 0.5) * 0.2,
        vy: (Math.random() - 0.5) * 0.2,
        radius: Math.random() * 2 + 1,
        alpha: 0,
        maxAlpha: Math.random() * 0.4 + 0.1,
        life: 0,
        maxLife: 300 + Math.random() * 300
    });
}

function getKillStats(kills) {
    if (kills >= 3) return { atk: 1.8, hp: 1.8, color: '#ffd700', label: '3', border: '#b8860b' }; // Gold
    if (kills === 2) return { atk: 1.5, hp: 1.5, color: '#c0c0c0', label: '2', border: '#7f8c8d' }; // Silver
    if (kills === 1) return { atk: 1.3, hp: 1.3, color: '#cd7f32', label: '1', border: '#8d4433' }; // Bronze
    return { atk: 1.0, hp: 1.0, color: null, label: '', border: null };
}

// Áâ©ÁêÜÊºîÁÆó„Å®Ë°ùÁ™ÅÂà§ÂÆö„ÅÆÂÖ±ÈÄöÂåñ
function applyPhysics(entity) {
    entity.vy += GRAVITY;
    
    // XËª∏ÁßªÂãï
    entity.x += entity.vx;
    platforms.forEach(p => {
        if (p.type >= 10 || p.type === 1) return; 
        if (entity.x + entity.radius > p.x && entity.x - entity.radius < p.x + p.w &&
            entity.y + entity.radius > p.y && entity.y - entity.radius < p.y + p.h) {
            if (p.type === 0 || p.type === 2) {
                if (entity.vx > 0) entity.x = p.x - entity.radius;
                else if (entity.vx < 0) entity.x = p.x + p.w + entity.radius;
                entity.vx = 0;
            }
        }
    });

    // YËª∏ÁßªÂãï
    entity.y += entity.vy;
    entity.onGround = false;
    platforms.forEach(p => {
        if (p.type >= 10) return;
        const hitH = p.type === 1 ? p.h / 2 : p.h;
        if (entity.x + entity.radius > p.x && entity.x - entity.radius < p.x + p.w &&
            entity.y + entity.radius > p.y && entity.y - entity.radius < p.y + hitH) {
            if (p.type === 0 || p.type === 2) {
                if (entity.vy > 0) {
                    entity.y = p.y - entity.radius; entity.vy = 0; entity.onGround = true; entity.jumpCount = 0;
                } else if (entity.vy < 0) {
                    entity.y = p.y + p.h + entity.radius; entity.vy = 0;
                }
            } else if (p.type === 1) {
                if (entity.vy > 0 && entity.y + entity.radius > p.y && entity.y + entity.radius < p.y + 20) {
                    entity.y = p.y - entity.radius; entity.vy = 0; entity.onGround = true; entity.jumpCount = 0;
                }
            }
        }
    });
}

// Ë¶ñÁ∑ö„ÉÅ„Çß„ÉÉ„ÇØ (Raycast)
function checkLineOfSight(e1, e2) {
    const steps = 20;
    const dx = (e2.x - e1.x) / steps;
    const dy = (e2.y - e1.y) / steps;
    let cx = e1.x, cy = e1.y;
    for(let i=0; i<steps; i++) {
        cx += dx; cy += dy;
        // „Éñ„É≠„ÉÉ„ÇØ„ÅÆ„ÅøË¶ñÁ∑ö„ÇíÈÅÆ„Çã
        if (platforms.some(p => p.type === 0 && cx > p.x && cx < p.x + p.w && cy > p.y && cy < p.y + p.h)) {
            return false;
        }
    }
    return true;
}

// Â∞ÑÁ∑ö„ÉÅ„Çß„ÉÉ„ÇØ (ÈäÉÂè£„Åã„Çâ„ÅÆÂà§ÂÆöÔºöÂÆüÈöõ„Å´ÂΩì„Åü„Çã„Åã)
function checkFireLine(shooter, target) {
    const angle = Math.atan2(target.y - shooter.y, target.x - shooter.x);
    
    // ÈäÉÂè£‰ΩçÁΩÆ„ÅÆË®àÁÆó (fireBullet„Å®ÂêåÊúü)
    const floatY = 0; // Âà§ÂÆöÁî®„ÅØÂõ∫ÂÆö„Åó„Å¶ÂÆâÂÆö„Åï„Åõ„Çã
    const distMuzzle = 118; 
    const bx = shooter.x + Math.cos(angle) * distMuzzle;
    const by = shooter.y + floatY + Math.sin(angle) * distMuzzle;

    // 1. ÈäÉËá™‰Ωì„ÅåÂ£Å„Å´Âüã„Åæ„Å£„Å¶„ÅÑ„Å™„ÅÑ„Åã„ÉÅ„Çß„ÉÉ„ÇØ (‰∏≠ÂøÉ -> ÈäÉÂè£)
    let hx = shooter.x, hy = shooter.y + floatY;
    const checkStepsGun = 12;
    const dxGun = (bx - hx) / checkStepsGun;
    const dyGun = (by - hy) / checkStepsGun;
    
    for(let k=0; k<checkStepsGun; k++) {
        hx += dxGun; hy += dyGun;
        if (platforms.some(p => {
            const hitH = p.type === 1 ? p.h / 2 : p.h;
            return (p.type === 0 || p.type === 1) && hx > p.x && hx < p.x + p.w && hy > p.y && hy < p.y + hitH;
        })) {
            return false; // ÈäÉ„ÅåÂ£Å„Å´ÂΩì„Åü„Å£„Å¶„ÅÑ„Çã
        }
    }

    // 2. ÈäÉÂè£„Åã„Çâ„Çø„Éº„Ç≤„ÉÉ„Éà„Åæ„Åß„ÅÆÂ∞ÑÁ∑ö„ÉÅ„Çß„ÉÉ„ÇØ
    const distToTarget = Math.hypot(target.x - bx, target.y - by);
    const steps = Math.ceil(distToTarget / 20);
    const dx = (target.x - bx) / steps;
    const dy = (target.y - by) / steps;
    let cx = bx, cy = by;
    
    for(let i=0; i<steps; i++) {
        cx += dx; cy += dy;
        if (platforms.some(p => {
            const hitH = p.type === 1 ? p.h / 2 : p.h;
            return (p.type === 0 || p.type === 1) && cx > p.x && cx < p.x + p.w && cy > p.y && cy < p.y + hitH;
        })) {
            // Â£Å„Å´ÂΩì„Åü„Å£„ÅüÂ†¥ÊâÄ„Åå„Çø„Éº„Ç≤„ÉÉ„Éà„Å´ÈùûÂ∏∏„Å´Ëøë„ÅÑÂ†¥Âêà„ÅØ„ÄåÂΩì„Åü„Å£„Åü„Äç„Å®„Åø„Å™„Åô
            if (Math.hypot(target.x - cx, target.y - cy) > target.radius) return false;
        }
    }
    return true;
}

// ËêΩ‰∏ã‰∫àÊ∏¨ (20„Éñ„É≠„ÉÉ„ÇØ‰ª•‰∏äËêΩ„Å°„Çã„Å™„Çâtrue)
function isDeepFall(x, y) {
    let groundY = Infinity;
    const feetY = y + 40; // Ë∂≥ÂÖÉ
    for (let p of platforms) {
        if (p.type >= 10) continue;
        if (x > p.x && x < p.x + p.w) {
            if (p.y >= feetY - 5) { // Â∞ë„Åó‰ΩôË£ï„ÇíÊåÅ„Åü„Åõ„Çã
                if (p.y < groundY) groundY = p.y;
            }
        }
    }
    return (groundY - feetY) > (20 * TILE_SIZE);
}

function updateAI(ai, targetsOverride = null, bulletsOverride = null) {
    // --- „ÇØ„Éº„É´„ÉÄ„Ç¶„É≥Êõ¥Êñ∞ ---
    if (ai.shootCooldown > 0) ai.shootCooldown--;
    if (ai.chaseTimer > 0) ai.chaseTimer--;

    // --- „É™„Éô„É≥„Ç∏„Çø„Ç§„Éû„ÉºÊõ¥Êñ∞ ---
    if (ai.revengeTimer > 0) ai.revengeTimer--;
    if (ai.lastAttacker && ai.lastAttacker.hp <= 0) ai.lastAttacker = null;

    // --- „Çø„Éº„Ç≤„ÉÉ„ÉàÈÅ∏Êäû„É≠„Ç∏„ÉÉ„ÇØ ---
    let allTargets = targetsOverride || [player, ...enemies];
    allTargets = allTargets.filter(e => e !== ai && e.hp > 0);

    // Ë¶ñÁïåÁØÑÂõ≤„Éï„Ç£„É´„Çø
    const maxDist = ai.sightRangeBlocks * TILE_SIZE;
    allTargets = allTargets.filter(t => Math.hypot(t.x - ai.x, t.y - ai.y) <= maxDist);
    
    // Ë∑ùÈõ¢È†Ü„ÇΩ„Éº„Éà
    allTargets.sort((a, b) => Math.hypot(a.x - ai.x, a.y - ai.y) - Math.hypot(b.x - ai.x, b.y - ai.y));

    const visibleTargets = allTargets.filter(t => checkFireLine(ai, t));
    const hiddenTargets = allTargets.filter(t => !checkFireLine(ai, t));

    // ÂÑ™ÂÖàÈ†Ü‰Ωç: Ë¶ñÁ∑ö„ÅåÈÄö„ÇãÊïµ > „É™„Éô„É≥„Ç∏ÂØæË±° > Èö†„Çå„Å¶„ÅÑ„ÇãÊïµ
    if (visibleTargets.length > 0) {
        ai.target = visibleTargets[0];
        ai.lastTargetVisible = true;

        // ÊºÅÂ§´„ÅÆÂà© (Third Party): 2‰∫∫‰ª•‰∏ä„ÅÆÊïµ„ÅåË¶ã„Åà„Å¶„ÅÑ„Å¶„ÄÅÊà¶Èóò‰∏≠(Áô∫Á†≤„Åó„Å¶„ÅÑ„Çã)„Å™„Çâ‰æø‰πó„Åô„Çã
        if (visibleTargets.length >= 2) {
            const isFighting = visibleTargets.some(t => t.attackCooldown > 0); // Á∞°ÊòìÂà§ÂÆö
            if (isFighting) {
                // Èö†„Çå„Å¶„ÅÑ„Å¶„ÇÇÁ¢∫Áéá„ÅßÊîªÊíÉ„Å´ÂèÇÂä†„Åô„Çã
                if (ai.state === 'hide' && Math.random() < 0.05) {
                    ai.state = 'peek';
                    ai.timer = 60 + Math.random() * 60;
                }
                // Âº±„Å£„Å¶„ÅÑ„ÇãÊïµ„ÇíÂÑ™ÂÖàÁöÑ„Å´Áãô„ÅÜ (Á¢∫Áéá„Åß„Çø„Éº„Ç≤„ÉÉ„ÉàÂ§âÊõ¥)
                if (Math.random() < 0.1) {
                    ai.target = visibleTargets.reduce((p, c) => p.hp < c.hp ? p : c);
                }
            }
        }
    } else if (ai.lastAttacker && ai.revengeTimer > 0 && ai.lastAttacker.hp > 0) {
        ai.target = ai.lastAttacker;
        ai.lastTargetVisible = checkFireLine(ai, ai.target);
    } else {
        if (ai.lastTargetVisible) {
            // „É≠„Çπ„Éà„Åó„ÅüÁû¨Èñì: 2Êäû (ËøΩ„ÅÑ„Åã„Åë„Çã or „Çø„Éº„Ç≤„ÉÉ„ÉàÂ§âÊõ¥)
            if (Math.random() < 0.5 && hiddenTargets.length > 0) {
                // „Çø„Éº„Ç≤„ÉÉ„ÉàÂ§âÊõ¥ („É©„É≥„ÉÄ„É†„Å™Èö†„Çå„ÅüÊïµ)
                ai.target = hiddenTargets[Math.floor(Math.random() * hiddenTargets.length)];
            } else if (hiddenTargets.length > 0) {
                // ËøΩ„ÅÑ„Åã„Åë„Çã (‰∏ÄÁï™Ëøë„ÅÑÈö†„Çå„ÅüÊïµ = ÂÖÉ„ÅÆ„Çø„Éº„Ç≤„ÉÉ„Éà„ÅÆÂèØËÉΩÊÄßÈ´ò)
                ai.target = hiddenTargets[0];
            }
            ai.lastTargetVisible = false;
        } else {
            // Á∂ôÁ∂ö„Åó„Å¶Ë¶ã„Åà„Å™„ÅÑÁä∂ÊÖã
            if (!ai.target || ai.target.hp <= 0) {
                ai.target = hiddenTargets[0] || null;
            }
        }
    }

    const target = ai.target;

    // Duelist: Ë§áÊï∞„ÅÆÊïµ„Åã„ÇâÂ∞ÑÁ∑ö„ÅåÈÄö„Å£„Å¶„ÅÑ„Çã„Åã„ÉÅ„Çß„ÉÉ„ÇØ
    let exposedCount = 0;
    if (ai.personality === 'duelist') {
        exposedCount = allTargets.filter(e => checkLineOfSight(e, ai)).length;
    }

    const distToTarget = target ? Math.hypot(target.x - ai.x, target.y - ai.y) : Infinity;
    const hasLOS = target ? checkLineOfSight(ai, target) : false;
    
    // --- ÂÅúÊªûÈò≤Ê≠¢ (Anti-Camping) ---
    if (Math.abs(ai.x - (ai.lastX || ai.x)) < 2) {
        ai.stuckTimer = (ai.stuckTimer || 0) + 1;
    } else {
        ai.stuckTimer = 0;
    }
    ai.lastX = ai.x;

    // --- Âº∑Âà∂ÁßªÂãï (Forced Move) ---
    let isForcedMoving = false;
    if (ai.forcedMoveSteps > 0) {
        ai.vx = ai.forcedMoveDir * 3;
        ai.forcedMoveSteps--;
        if (ai.onGround && Math.random() < 0.05) ai.vy = JUMP_FORCE;
        isForcedMoving = true;
    } else if (ai.stuckTimer > 120) { // 2ÁßíÈñìÂãï„Åã„Å™„ÅÑÂ†¥Âêà
        ai.stuckTimer = 0;
        const dist = (1.4 + Math.random() * 1.8) * TILE_SIZE; // 1.4 ~ 3.2„Éñ„É≠„ÉÉ„ÇØ
        ai.forcedMoveSteps = Math.ceil(dist / 3);
        ai.forcedMoveDir = Math.random() < 0.5 ? 1 : -1;
        isForcedMoving = true;
        ai.moveLockTimer = 0; // Âº∑Âà∂ÁßªÂãï‰∏≠„ÅØ„É≠„ÉÉ„ÇØ„ÇíËß£Èô§
    }

    // --- ÂàùÊúüÁßªÂãï („Çπ„Éù„Éº„É≥Áõ¥Âæå„ÅÆ„É©„É≥„ÉÄ„É†ÁßªÂãï) ---
    let isInitialMoving = false;
    if (ai.traveledDist < ai.initialMoveDist) {
        isInitialMoving = true;
        ai.vx = ai.initialDir * 2;
        
        // Â£Å„ÉªËêΩ‰∏ã„ÉÅ„Çß„ÉÉ„ÇØ„ÅßÂèçËª¢
        const checkX = ai.x + (ai.vx > 0 ? 40 : -40);
        if (platforms.some(p => (p.type === 0 || p.type === 2) && checkX > p.x && checkX < p.x + p.w && ai.y > p.y && ai.y < p.y + p.h)) {
            ai.initialDir *= -1;
        } else if (ai.onGround && isDeepFall(checkX, ai.y)) {
            ai.initialDir *= -1;
        }
        
        ai.traveledDist += Math.abs(ai.vx);
    }

    if (!isInitialMoving && !isForcedMoving) {
    const isLowHp = ai.hp <= 2;
    // „Éá„Ç£„Éï„Çß„É≥„ÉÄ„Éº„ÅÆ„Åø‰ΩìÂäõ„Åå‰Ωé„ÅÑ„Å®ÈÄÉ„Åí„Çã
    const shouldFlee = isLowHp && ai.personality === 'defender' && target;
    const isChasing = ai.chaseTimer > 0 && ai.chaseTarget && ai.chaseTarget.hp > 0;
    const isRevenge = !shouldFlee && ai.revengeTimer > 0 && target;

    if (shouldFlee) {
        // --- ÈÄÉËµ∞„É¢„Éº„Éâ ---
        ai.state = 'flee';
        
        if (hasLOS) {
            // Â∞ÑÁ∑ö„ÅåÈÄö„Å£„Å¶„ÅÑ„Çã„Å™„Çâ„ÄÅÂ∞ÑÁ∑ö„ÇíÂàá„Çã„Åü„ÇÅ„Å´ÂÖ®Âäõ„ÅßÈõ¢„Çå„Çã
            ai.vx = (target.x > ai.x ? -1 : 1) * 5;
            // „Ç∏„É£„É≥„Éó„ÅßÂõûÈÅø„ÉªÊÆµÂ∑ÆË∂ä„Åà
            if (ai.onGround && Math.random() < 0.1) ai.vy = JUMP_FORCE;
        } else {
            // Â∞ÑÁ∑ö„ÅåÂàá„Çå„Å¶„ÅÑ„ÇãÊôÇ
            if (distToTarget < 400) {
                // Ëøë„Åô„Åé„Çã„Å™„Çâ„Åæ„Å†Èõ¢„Çå„Çã
                ai.vx = (target.x > ai.x ? -1 : 1) * 4;
            } else {
                // ÂÆâÂÖ®Âúè„Å™„ÇâÊ≠¢„Åæ„Å£„Å¶ÊßòÂ≠êË¶ã
                ai.vx = ai.facing * 3; // Ê≠¢„Åæ„Çâ„Åö„Å´Âãï„ÅçÁ∂ö„Åë„Çã
            }
        }

    } else if (isChasing) {
        // --- ËøΩÊíÉ„É¢„Éº„Éâ (ÊîªÊíÉ„Éí„ÉÉ„ÉàÊôÇ) ---
        ai.state = 'chase';
        // „Çø„Éº„Ç≤„ÉÉ„Éà„Å´Ë©∞„ÇÅÂØÑ„Çã
    ai.vx = (ai.chaseTarget.x > ai.x ? 1 : -1) * ai.speed;
        if (ai.onGround && Math.random() < 0.05) ai.vy = JUMP_FORCE;

    } else if (isRevenge) {
        // --- „É™„Éô„É≥„Ç∏„É¢„Éº„Éâ (ÂèçÊíÉ) ---
        ai.state = 'revenge';
        if (hasLOS) {
            // Ë¶ã„Åà„Å¶„ÅÑ„Çã„Å™„ÇâÊîªÊíÉ
            ai.vx *= 0.8;
        if (Math.abs(ai.vx) < 0.5) ai.vx = (Math.random() < 0.5 ? 1 : -1) * (ai.speed - 3); // Ê≠¢„Åæ„Çâ„Åö„Å´Âãï„Åè
        } else {
            // Ë¶ã„Åà„Å™„ÅÑ„Å™„ÇâËøΩ„ÅÑ„Åã„Åë„Çã
        ai.vx = (target.x > ai.x ? 1 : -1) * (ai.speed - 0.5);
        }
    } else {
        // --- ÈÄöÂ∏∏AI„É≠„Ç∏„ÉÉ„ÇØ ---

    ai.timer--;
    if (ai.timer <= 0) {
        // Áä∂ÊÖãÈÅ∑Áßª
        if (ai.state === 'hide') {
            // Èö†„ÇåÁä∂ÊÖã„Åã„Çâ„ÄÅÁ¢∫Áéá„ÅßÊîªÊíÉ(Peek)„Å∏
            let peekChance = ai.aggressiveness;
            if (ai.personality === 'duelist' && exposedCount > 1) peekChance = 0.1; // Âõ≤„Åæ„Çå„Å¶„Åü„ÇâÂá∫„Å™„ÅÑ

            if (Math.random() < peekChance) {
                ai.state = 'peek';
                // ÊîªÊíÉÊôÇÈñì„ÅÆÊ±∫ÂÆö
                if (ai.personality === 'aggressor') ai.timer = 100 + Math.random() * 60;
                else if (ai.personality === 'defender') ai.timer = 30 + Math.random() * 30;
                else ai.timer = 60 + Math.random() * 60;
            } else {
                // Èö†„Çå„ÇãÊôÇÈñì„ÅÆÊ±∫ÂÆö
                if (ai.personality === 'aggressor') ai.timer = 20 + Math.random() * 20;
                else if (ai.personality === 'defender') ai.timer = 60 + Math.random() * 60;
                else ai.timer = 30 + Math.random() * 30;

                // Èö†„Çå„Å¶„ÅÑ„ÇãÈñì„ÇÇ„Åü„Åæ„Å´‰ΩçÁΩÆ„ÇíÂ§â„Åà„Çã
                if (Math.random() < 0.3) ai.vx = (Math.random() - 0.5) * (ai.speed - 1);
            }
        } else if (ai.state === 'peek') {
            // ÊîªÊíÉÁµÇ‰∫Ü„ÄÅÈö†„Çå„Çã
            ai.state = 'hide';
            ai.timer = 60 + Math.random() * 100;
        }
    }

    if (!target) {
        // „Çø„Éº„Ç≤„ÉÉ„Éà„Åå„ÅÑ„Å™„ÅÑ/ÁØÑÂõ≤Â§ñ„Å™„Çâ„É©„É≥„ÉÄ„É†ÁßªÂãï
        if (ai.timer % 60 === 0) ai.vx = (Math.random() - 0.5) * (ai.speed - 1);
    } else 
    if (ai.state === 'hide') {
        if (hasLOS) {
            // Ë¶ñÁ∑ö„ÅåÈÄö„Å£„Å¶„ÅÑ„Çã„Å™„ÇâÈö†„Çå„ÇãÂ†¥ÊâÄ„ÇíÊé¢„ÅôÔºà„Éó„É¨„Ç§„É§„Éº„Åã„ÇâÈõ¢„Çå„Çã„ÄÅ„Åæ„Åü„ÅØÂ£Å„Å´Âêë„Åã„ÅÜÔºâ
            ai.vx = (target.x > ai.x ? -1 : 1) * (ai.speed - 2);
        } else {
            // Èö†„Çå„Å¶„ÅÑ„ÇãÊôÇ„ÅÆË°åÂãï
            if (ai.personality === 'aggressor' && distToTarget > 300) {
                // „Ç¢„Ç∞„É¨„ÉÉ„Çµ„Éº„ÅØÈö†„Çå„Å™„Åå„Çâ„ÇÇËøë„Å•„Åè
                ai.vx = (target.x > ai.x ? 1 : -1) * (ai.speed - 3);
            } else {
                if (Math.abs(ai.vx) > 0.1) ai.vx *= 0.9;
                else ai.vx = ai.facing * (ai.speed - 3); // Ê≠¢„Åæ„Çâ„Åö„Å´Â∑°Âõû
            }
        }
    } else if (ai.state === 'peek') {
        if (ai.personality === 'duelist' && exposedCount > 1) {
            // 1vs1„Éû„É≥„ÅåË§áÊï∞„Å´Ë¶ã„Çâ„Çå„Åü„ÇâÈÄÉ„Åí„Çã
            ai.state = 'hide';
            ai.timer = 60;
            ai.vx = (target.x > ai.x ? -1 : 1) * (ai.speed - 1);
        } else if (!hasLOS) {
            // Ë¶ñÁ∑ö„ÇíÈÄö„Åô„Åü„ÇÅ„Å´ÁßªÂãïÔºà„Éó„É¨„Ç§„É§„Éº„Å´Âêë„Åã„ÅÜÔºâ
            ai.vx = (target.x > ai.x ? 1 : -1) * (ai.speed - 2);
        } else {
            // Ë¶ñÁ∑ö„ÅåÈÄö„Å£„Åü„ÇâÂÅúÊ≠¢„Åó„Å¶Â∞ÑÊíÉ
            
            const selfDisadvantage = ai.energy < 1.5 || (ai.hp / ai.maxHp) < 0.3;
            const targetDisadvantage = target.energy < 1.5 || (target.hp / target.maxHp) < 0.3;

            // Ë∑ùÈõ¢Ë™øÊï¥
            const minGunDist = 200; // ÈäÉ„ÅÆË∑ùÈõ¢ÂàÜ (ÊúÄ‰ΩéÁ¢∫‰øùË∑ùÈõ¢)
            const safeDist = 350; // ÁêÜÊÉ≥Ë∑ùÈõ¢
            
            if (distToTarget < minGunDist) {
                // ÊúÄ‰ΩéË∑ùÈõ¢Á¢∫‰øù (ÊúÄÂÑ™ÂÖà)
                ai.vx = (target.x > ai.x ? -1 : 1) * (ai.speed - 1);
            } else if (selfDisadvantage) {
                // Ëá™ÂàÜ„Åå‰∏çÂà©: Ë∑ùÈõ¢„ÇíË©∞„ÇÅ„Å™„ÅÑ (Èõ¢„Çå„Çã)
                if (distToTarget < 400) ai.vx = (target.x > ai.x ? -1 : 1) * (ai.speed - 2);
                else ai.vx = (Math.random() < 0.5 ? 1 : -1) * (ai.speed - 3); // Ë∑ùÈõ¢„Åå„ÅÇ„Çå„Å∞Â∑¶Âè≥„Å´Êè∫„Åï„Å∂„Çã
            } else if (targetDisadvantage) {
                // Áõ∏Êâã„Åå‰∏çÂà©: Ë∑ùÈõ¢„ÇíË©∞„ÇÅ„Çã
                ai.vx = (target.x > ai.x ? 1 : -1) * (ai.speed - 1);
            } else if (distToTarget < safeDist) {
                ai.vx = (target.x > ai.x ? -1 : 1) * (ai.speed - 2); // Ëøë„Åô„Åé„Çã„ÅÆ„ÅßÈõ¢„Çå„Çã
            } else if (Math.random() < ai.linearApproachChance) {
                ai.vx = (target.x > ai.x ? 1 : -1) * (ai.speed - 2); // Á¢∫Áéá„ÅßÁõ¥Á∑öÁöÑ„Å´Êé•Ëøë
            } else {
                // Áõ¥Á∑öÁöÑ„Å´ÈÄ≤„Åæ„Å™„ÅÑÂ†¥ÂêàÔºöÈÅì„ÇíÂ§â„Åà„Å™„Åå„Çâ(Â∞ÑÁ∑ö„ÇíÂàá„Çä„Å™„Åå„Çâ)ÈÄ≤„ÇÄ
                const dir = target.x > ai.x ? 1 : -1;
                // 70%„ÅßÊé•Ëøë„ÄÅ30%„ÅßÂõûÈÅøË°åÂãï(„Ç∏„Ç∞„Ç∂„Ç∞)
                if (Math.random() < 0.7) ai.vx = dir * (ai.speed - 2.5);
                else ai.vx = -dir * (ai.speed - 2.5);

                // „Ç∏„É£„É≥„Éó„ÅßÂ∞ÑÁ∑ö„ÇíÂàá„Çã/ÈÅì„ÇíÂ§â„Åà„Çã
                if (ai.onGround && Math.random() < 0.03) ai.vy = JUMP_FORCE;
            }
        }
    }
    }

    // --- ÁßªÂãï„É≠„ÉÉ„ÇØ (ÊúÄ‰Ωé3„Éñ„É≠„ÉÉ„ÇØÂàÜ„ÅØÂãï„ÅçÁ∂ö„Åë„Çã) ---
    if (ai.moveLockTimer > 0) {
        // ÈÄ≤Ë°åÊñπÂêë„ÅÆÂÆâÂÖ®Á¢∫Ë™ç (speed„ÅåÂèØÂ§â„Å´„Å™„Å£„Åü„ÅÆ„Åß„ÄÅvx„ÇíÁõ¥Êé•‰Ωø„ÅÜ)
        const checkX = ai.x + (ai.lockedVx > 0 ? 40 : -40);
        const hitWall = platforms.some(p => (p.type === 0 || p.type === 2) && checkX > p.x && checkX < p.x + p.w && ai.y > p.y && ai.y < p.y + p.h);
        const aboutToFall = ai.onGround && isDeepFall(checkX, ai.y);

        if (hitWall || aboutToFall) {
            ai.moveLockTimer = 0; // Â£Å„ÇÑÂ¥ñ„Å™„Çâ„É≠„ÉÉ„ÇØËß£Èô§„Åó„Å¶Âç≥Â∫ß„Å´ÂèçËª¢„Å™„Å©„ÇíË®±ÂèØ
            ai.vx = -ai.lockedVx; // ÂèçËª¢
            ai.lockedVx = ai.vx;
            ai.moveLockTimer = 45;
        } else {
            ai.vx = ai.lockedVx; // „É≠„ÉÉ„ÇØ‰∏≠„ÅØÊñπÂêë„ÇíÁ∂≠ÊåÅ
            ai.moveLockTimer--;
        }
    } else {
        // „É≠„ÉÉ„ÇØ„Å™„ÅóÔºöÁèæÂú®„ÅÆÊ±∫ÂÆö„ÇíÊé°Áî®„Åó„ÄÅ„É≠„ÉÉ„ÇØ„ÇíÈñãÂßã
        if (Math.abs(ai.vx) < 0.5) ai.vx = (Math.random() < 0.5 ? 1 : -1) * (ai.speed - 3); // ÂÅúÊ≠¢ÂõûÈÅø
        ai.lockedVx = ai.vx;
        ai.moveLockTimer = 45; // Á¥Ñ3„Éñ„É≠„ÉÉ„ÇØÂàÜ (Speed ~3.5 * 45f ‚âà 150px)
    }
    }

    // --- ÂÖ±ÈÄöÂ∞ÑÊíÉ„É≠„Ç∏„ÉÉ„ÇØ (Â∞ÑÁ∑ö„ÅåÈÄö„Å£„Å¶„ÅÑ„Çå„Å∞ÊíÉ„Å§) ---
    if (target && checkFireLine(ai, target)) {
        if (ai.energy >= 1 && ai.shootCooldown <= 0 && ai.attackCooldown <= 0) {
            let aimX = target.x;
            let aimY = target.y;

            const angle = Math.atan2(aimY - ai.y, aimX - ai.x);
            const error = (Math.random() - 0.5) * ai.aimAccuracy;
            triggerShoot(ai, angle + error, bulletsOverride);
            // „ÇØ„Éº„É´„ÉÄ„Ç¶„É≥ (30~42„Éï„É¨„Éº„É†: 0.5~0.7Áßí)
            ai.shootCooldown = 30 + Math.random() * 12;
        }
    }

    // --- „Ç∏„É£„É≥„ÉóÂà∂Âæ° ---
    let shouldJump = false;

    // 1. ÊÆµÂ∑ÆË∂ä„Åà
    if (Math.abs(ai.vx) > 1 && ai.onGround) {
        // ÈÄ≤Ë°åÊñπÂêë„Å´„Éñ„É≠„ÉÉ„ÇØ„Åå„ÅÇ„Çã„Åã„ÉÅ„Çß„ÉÉ„ÇØ
        const checkX = ai.x + (ai.vx > 0 ? 60 : -60);
        if (platforms.some(p => (p.type === 0 || p.type === 2) && checkX > p.x && checkX < p.x + p.w && ai.y > p.y && ai.y < p.y + p.h)) {
            shouldJump = true;
        }
    }

    // 2. ÂõûÈÅø„Ç∏„É£„É≥„Éó (Ë¶ñÁ∑ö„ÅåÈÄö„Å£„Å¶„ÅÑ„Çã„Å®„Åç„É©„É≥„ÉÄ„É†„Å´)
    if (hasLOS && ai.onGround && Math.random() < 0.015) {
        shouldJump = true;
    }

    if (shouldJump && ai.jumpCount < ai.maxJumps) {
        // 3. Â§©‰∫ï„ÉÅ„Çß„ÉÉ„ÇØ (È†≠‰∏ä„Å´„Éñ„É≠„ÉÉ„ÇØ„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅØ„Ç∏„É£„É≥„Éó„Åó„Å™„ÅÑ)
        const hasCeiling = platforms.some(p => 
            (p.type === 0 || p.type === 2) &&
            ai.x + 20 > p.x && ai.x - 20 < p.x + p.w && // XËª∏„ÅÆÈáç„Å™„Çä
            p.y + p.h < ai.y && p.y + p.h > ai.y - 160 // YËª∏: È†≠‰∏ä„Åô„Åê(Á¥Ñ160px‰ª•ÂÜÖ)„Å´„Éñ„É≠„ÉÉ„ÇØ„ÅÆÂ∫ï„Åå„ÅÇ„Çã„Åã
        );

        if (!hasCeiling) {
            ai.vy = JUMP_FORCE;
            ai.onGround = false;
            ai.jumpCount++;
        } else {
            // Â§©‰∫ï„Åå‰Ωé„Åè„Å¶„Ç∏„É£„É≥„Éó„Åß„Åç„Å™„ÅÑÂ†¥Âêà„ÅØÈÅø„Åë„ÇãÔºàÂèçËª¢Ôºâ
            ai.vx *= -1;
            ai.lockedVx = ai.vx;
            ai.moveLockTimer = 30;
        }
    }

    // --- AI Double Jump (1/2 chance at peak) ---
    if (!ai.onGround && ai.jumpCount < ai.maxJumps && ai.vy > -2 && !ai.doubleJumpChecked) {
        ai.doubleJumpChecked = true;
        if (Math.random() < 0.5) {
            ai.vy = JUMP_FORCE;
            ai.jumpCount++;
            if (!targetsOverride) {
                for(let i=0; i<5; i++) particles.push({x: ai.x, y: ai.y+20, vx:(Math.random()-0.5)*2, vy:Math.random()*2, life:15, maxLife:15, color:'#fff', size:3});
            }
        }
    }
    if (ai.onGround) ai.doubleJumpChecked = false;

    // --- Â§©‰∫ïÂõûÈÅø (Low Ceiling Avoidance) ---
    if (ai.onGround && ai.vx !== 0) {
        const lookAhead = ai.vx > 0 ? 60 : -60;
        const checkX = ai.x + lookAhead;
        const isLowCeiling = (x, y) => platforms.some(p => 
            (p.type === 0 || p.type === 2) &&
            x > p.x && x < p.x + p.w &&
            p.y + p.h < y && p.y + p.h > y - 160
        );

        if (isLowCeiling(checkX, ai.y) && !isLowCeiling(ai.x, ai.y)) {
            ai.vx *= -1;
            ai.lockedVx = ai.vx;
            ai.moveLockTimer = 30;
        }
    }

    // --- ËêΩ‰∏ãÈò≤Ê≠¢ (20„Éñ„É≠„ÉÉ„ÇØ‰ª•‰∏ä) ---
    if (ai.onGround && ai.vx !== 0) {
        const lookAhead = ai.vx > 0 ? 60 : -60;
        if (isDeepFall(ai.x + lookAhead, ai.y)) {
            ai.vx = 0; // Âç±Èô∫„Å™„ÅÆ„ÅßÂÅúÊ≠¢
            ai.state = 'hide'; // Èö†„Çå„Çã„É¢„Éº„Éâ„Å∏ÁßªË°å„Åó„Å¶ÊßòÂ≠êË¶ã
        }
    }

    // --- Â£Å„ÅßÂÅúÊ≠¢ (Wall Stop) ---
    if (ai.onGround && ai.vx !== 0 && ai.vy >= 0) {
        const checkDist = ai.radius + 5;
        const checkX = ai.x + (ai.vx > 0 ? checkDist : -checkDist);
        const wallAhead = platforms.some(p => 
            (p.type === 0 || p.type === 2) && 
            checkX > p.x && checkX < p.x + p.w && 
            ai.y + ai.radius > p.y && ai.y - ai.radius < p.y + p.h
        );
        if (wallAhead) {
            ai.vx = 0;
        }
    }

    // Âêë„Åç„ÅÆÂà∂Âæ°
    if (ai.state === 'peek' && hasLOS) ai.facing = target.x > ai.x ? 1 : -1; // ÊîªÊíÉ‰∏≠„ÅØ„Çø„Éº„Ç≤„ÉÉ„Éà„ÇíË¶ã„Çã
    else if (ai.vx !== 0) ai.facing = ai.vx > 0 ? 1 : -1; // ÁßªÂãï‰∏≠„ÅØÈÄ≤Ë°åÊñπÂêë
    else if (hasLOS) ai.facing = target.x > ai.x ? 1 : -1; // ÂæÖÊ©ü‰∏≠„ÅØ„Çø„Éº„Ç≤„ÉÉ„Éà„ÇíË¶ã„Çã

    // Ëá™ÂãïÂõûÂæ©
    ai.damageTimer++;
    if (ai.damageTimer > 900 && ai.hp < ai.maxHp) { // 15Áßí (60fps * 15)
        const heal = ai.maxHp / 12 / 60; // ÊØéÁßí1/12ÂõûÂæ©
        ai.hp += heal;
        if (ai.hp > ai.maxHp) ai.hp = ai.maxHp;
        if (!targetsOverride && Math.random() < 0.1) spawnHealEffect(ai.x, ai.y);
    }
    
    if (ai.energy < ai.maxEnergy) ai.energy += 0.01;
}

function update() {
    updateBgmState();
    if (isEditor) {
        // „Ç®„Éá„Ç£„Çø„É¢„Éº„ÉâÔºöÂ∑¶„Çπ„ÉÜ„Ç£„ÉÉ„ÇØ„Åß„Ç´„É°„É©ÁßªÂãï
        if (keys['ArrowLeft']) camera.x -= 15;
        if (keys['ArrowRight']) camera.x += 15;
        if (keys['ArrowUp']) camera.y -= 15;
        if (keys['ArrowDown']) camera.y += 15;
        draw();
        requestAnimationFrame(update);
        return;
    }

    if (gameState === 'loading') {
        const startTime = performance.now();
        // 1„Éï„É¨„Éº„É†„ÅÆ‰∫àÁÆó„Çí„Åï„Çâ„Å´Â¢ó„ÇÑ„Åó„Å¶„Çπ„É´„Éº„Éó„ÉÉ„Éà„ÇíÊúÄÂ§ßÂåñ
        while (performance.now() - startTime < 100) {
            if (offlineSimQueue.length > 0) {
                simulateRankedMatch(offlineSimQueue.shift(), simPlatforms);
                offlineSimCurrentMatch++;
            } else {
                gameState = 'home';
                platforms = gamePlatforms;
                savePlayerData();
                saveAIRates();
                offlineSimTotalMatches = 0;
                offlineSimCurrentMatch = 0;
                break;
            }
        }

        // --- „Ç≠„É£„É©„Ç≥„É≥Á∑¥Áøí ---
        if (sticks.left.active) player.vx = Math.cos(sticks.left.angle) * (sticks.left.dist/50) * (player.speed || SPEED);
        
        if (sticks.right.active) {
            player.facing = Math.cos(sticks.right.angle) >= 0 ? 1 : -1;
        } else if (Math.abs(player.vx) > 0.1) {
            player.facing = player.vx > 0 ? 1 : -1;
        }
        applyPhysics(player);
        processBurst(player);

        // ËêΩ‰∏ãÊ≠ªÈò≤Ê≠¢
        player.hp = player.maxHp;
        const limitY = WORLD_HEIGHT + 100;
        if (player.y > limitY) {
            player.x = 20100; player.y = 700; player.vx = 0; player.vy = 0;
        }

        // ÂºæÊõ¥Êñ∞ (Á∞°ÊòìÁâà)
        for (let i = bullets.length - 1; i >= 0; i--) {
            const b = bullets[i];
            b.x += b.vx; b.y += b.vy;
            let removed = false;
            platforms.forEach(p => {
                const hitH = p.type === 1 ? p.h / 2 : p.h;
                if (p.type < 10 && (p.type === 0 || p.type === 1) && b.x > p.x && b.x < p.x + p.w && b.y > p.y && b.y < p.y + hitH) {
                    removed = true;
                }
            });
            if (removed || b.x < 20000 || b.x > 20000 + WORLD_WIDTH || b.y < 0 || b.y > WORLD_HEIGHT) {
                bullets.splice(i, 1);
            }
        }

        // „Éë„Éº„ÉÜ„Ç£„ÇØ„É´Êõ¥Êñ∞
        for (let i = particles.length - 1; i >= 0; i--) {
            let p = particles[i]; p.x += p.vx; p.y += p.vy; p.life--;
            if (p.life <= 0) particles.splice(i, 1);
        }

        // „Ç´„É°„É©Êõ¥Êñ∞
        camera.x = player.x - canvas.width / 2;
        camera.y = player.y - canvas.height * 0.7;

        draw();
        requestAnimationFrame(update);
        return;
    } else if (gameState === 'charSelect') {
        // No specific update logic needed, just drawing
        draw();
        requestAnimationFrame(update);
        return;
    }
    
    if (gameState === 'home') {
        // Update online count
        if (Date.now() - lastOnlineUpdate > 5000) {
            const h = new Date().getHours();
            const s = getDailySchedule(aiSamples);
            let c = 0;
            aiSamples.forEach(ai => {
                if (s[ai.nameID] && s[ai.nameID][h]) c++;
            });
            currentOnlineCount = c + 1;
            lastOnlineUpdate = Date.now();
        }

        // Spawn new particles
        if (Math.random() < 0.5) {
            spawnHomeParticle();
        }

        // Update home particles
        for (let i = homeParticles.length - 1; i >= 0; i--) {
            const p = homeParticles[i];
            p.x += p.vx;
            p.y += p.vy;
            p.life++;

            // Fade in and out
            if (p.life < p.maxLife / 2) {
                p.alpha = (p.life / (p.maxLife / 2)) * p.maxAlpha;
            } else {
                p.alpha = ((p.maxLife - p.life) / (p.maxLife / 2)) * p.maxAlpha;
            }

            if (p.life >= p.maxLife || p.x < -p.radius || p.x > canvas.width + p.radius || p.y < -p.radius || p.y > canvas.height + p.radius) {
                homeParticles.splice(i, 1);
            }
        }
        camera.x = player.x - canvas.width / 2;
        camera.y = player.y - canvas.height * 0.7;
        draw();
        requestAnimationFrame(update);
        return;
    }
    if (gameState === 'matching') {
        matchingTime -= 1/60;
        
        // Êïµ„ÅÆÂÖ•ÂÆ§Âà§ÂÆö
        if (joinedEnemies.length < 3) {
            for (let i = pendingEnemies.length - 1; i >= 0; i--) {
                if (matchingTime <= pendingEnemies[i].joinTime) {
                    joinedEnemies.push(pendingEnemies[i].ai);
                    pendingEnemies.splice(i, 1);
                }
            }
        }

        // 4‰∫∫ÊèÉ„Å£„Åü„Çâ3ÁßíÂæÖÊ©ü„Å∏Áü≠Á∏Æ
        if (joinedEnemies.length >= 3) {
            if (matchingTime > 3) matchingTime = 3;
        }

        // ÊôÇÈñìÂàá„Çå„ÅßÈñãÂßã
        if (matchingTime <= 0) {
            // Ë∂≥„Çä„Å™„ÅÑÂàÜ„ÇíÊó¢Â≠ò„ÅÆAI„Åã„Çâ„É©„É≥„ÉÄ„É†„Å´Ë£úÂÖÖ (BOTÂªÉÊ≠¢)
            const currentIDs = new Set(joinedEnemies.map(e => e.nameID));
            const availableAIs = aiSamples.filter(ai => !currentIDs.has(ai.nameID));
            
            while (joinedEnemies.length < 3 && availableAIs.length > 0) {
                const r = Math.floor(Math.random() * availableAIs.length);
                joinedEnemies.push(availableAIs[r]);
                availableAIs.splice(r, 1);
            }
            
            // „Éê„ÉÉ„ÇØ„Ç∞„É©„Ç¶„É≥„Éâ„Éû„ÉÉ„ÉÅ
            const otherMatches = Math.floor(Math.max(0, currentOnlineCount - 4) / 4);
            simulateBackgroundMatches(otherMatches);

            startSession(joinedEnemies);
            gameState = 'countdown';
            countdownTime = 3;
        }

        // „Ç≠„É£„É©„Ç≥„É≥Á∑¥Áøí („Éû„ÉÉ„ÉÅ„É≥„Ç∞‰∏≠)
        if (sticks.left.active) player.vx = Math.cos(sticks.left.angle) * (sticks.left.dist/50) * (player.speed || SPEED);
        if (sticks.right.active) {
            player.facing = Math.cos(sticks.right.angle) >= 0 ? 1 : -1;
        } else if (Math.abs(player.vx) > 0.1) {
            player.facing = player.vx > 0 ? 1 : -1;
        }
        applyPhysics(player);
        processBurst(player);
        if (player.y > WORLD_HEIGHT + 100) {
            player.x = 20100; player.y = 700; player.vx = 0; player.vy = 0;
        }
        for (let i = bullets.length - 1; i >= 0; i--) {
            const b = bullets[i]; b.x += b.vx; b.y += b.vy;
            let removed = false;
            platforms.forEach(p => { const hitH = p.type === 1 ? p.h / 2 : p.h; if (p.type < 10 && (p.type === 0 || p.type === 1) && b.x > p.x && b.x < p.x + p.w && b.y > p.y && b.y < p.y + hitH) removed = true; });
            if (removed || b.x < 20000 || b.x > 20000 + WORLD_WIDTH || b.y < 0 || b.y > WORLD_HEIGHT) bullets.splice(i, 1);
        }
        camera.x = player.x - canvas.width / 2;
        camera.y = player.y - canvas.height * 0.7;

        draw();
        requestAnimationFrame(update);
        return;
    }
    if (gameState === 'countdown') {
        countdownTime -= 1/60;
        if (countdownTime <= 0) gameState = 'playing';
        camera.x = player.x - canvas.width / 2;
        camera.y = player.y - canvas.height * 0.7;
        draw();
        requestAnimationFrame(update);
        return;
    }
    if (gameState === 'ranking') {
        draw();
        requestAnimationFrame(update);
        return;
    }
    if (gameState === 'result') {
        draw();
        requestAnimationFrame(update);
        return;
    }

    // --- „Çµ„Éº„ÇØ„É´(„Çπ„Éà„Éº„É†)„ÅÆÊõ¥Êñ∞ ---
    if (gameState === 'playing' || gameState === 'spectating') {
        if (circleStartTime > 0) {
            circleStartTime -= 1/60;
        } else if (circleRadius > 0) {
            // Á¥Ñ2ÂàÜ(120Áßí)„ÅßÂçäÂæÑ0„Å´„Å™„Çã„Çà„ÅÜ„Å´Á∏ÆÂ∞è
            const initialRadius = Math.hypot(WORLD_WIDTH, WORLD_HEIGHT);
            const shrinkSpeedPerSecond = initialRadius / 120;
            circleRadius -= shrinkSpeedPerSecond / 60;
            if (circleRadius < 0) circleRadius = 0;
        }
    }

    // --- „Çπ„Éà„Éº„É†„ÉÄ„É°„Éº„Ç∏Âá¶ÁêÜ ---
    if (gameState === 'playing' && circleStartTime <= 0) {
        [player, ...enemies].forEach(char => {
            if (char.hp <= 0) return;
            const distFromCenter = Math.hypot(char.x - circleCenterX, char.y - circleCenterY);
            if (distFromCenter > circleRadius) {
                // „Çπ„Éà„Éº„É†ÂÜÖ„Å´„ÅÑ„Çã
                char.stormDamageTimer = (char.stormDamageTimer || 0) + 1;
                if (char.stormDamageTimer >= 60) { // 1Áßí„Åî„Å®„Å´„ÉÄ„É°„Éº„Ç∏
                    char.hp -= CIRCLE_DAMAGE_PER_SECOND;
                    char.stormDamageTimer = 0;
                    char.damageTimer = 0; // Ëá™ÁÑ∂ÂõûÂæ©„Çí‰∏≠Êñ≠
                    // „ÉÄ„É°„Éº„Ç∏„Ç®„Éï„Çß„ÇØ„Éà
                    for(let j=0; j<5; j++) {
                        particles.push({ x: char.x, y: char.y, vx: (Math.random()-0.5)*3, vy: (Math.random()-0.5)*3, life: 20, maxLife: 20, color: '#800080', size: Math.random()*5+3 });
                    }
                    if (char.hp <= 0 && char !== player) {
                        killLogs.push({ msg: `${char.name} was lost to the Storm`, life: 180 });
                    }
                }
            } else {
                char.stormDamageTimer = 0; // ÂÆâÂÖ®Âú∞Â∏Ø„Å´„ÅÑ„Çã„Å™„Çâ„Çø„Ç§„Éû„Éº„É™„Çª„ÉÉ„Éà
            }
        });
    }

    // „Éó„É¨„Ç§„É§„ÉºÊìç‰Ωú (spectating‰∏≠„ÅØÁÑ°Âäπ)
    if (gameState === 'playing') {
        if (sticks.left.active) player.vx = Math.cos(sticks.left.angle) * (sticks.left.dist/50) * (player.speed || SPEED);
        
        if (sticks.right.active) {
            player.facing = Math.cos(sticks.right.angle) >= 0 ? 1 : -1;
        } else if (Math.abs(player.vx) > 0.1) {
            player.facing = player.vx > 0 ? 1 : -1;
        }
        applyPhysics(player);
        processBurst(player);

        // „Éó„É¨„Ç§„É§„ÉºËá™ÂãïÂõûÂæ©
        player.damageTimer++;
        if (player.damageTimer > 900 && player.hp < player.maxHp) { // 15Áßí
            const heal = player.maxHp / 12 / 60; // ÊØéÁßí1/12ÂõûÂæ©
            player.hp += heal;
            player.healedAmount += heal;
            if (player.hp > player.maxHp) player.hp = player.maxHp;
            if (Math.random() < 0.1) spawnHealEffect(player.x, player.y);
        }

        // „Éó„É¨„Ç§„É§„ÉºÊ≠ª‰∫°Âà§ÂÆö
        if (player.hp <= 0) {
            if (player.stormDamageTimer > 0) { // „Çπ„Éà„Éº„É†„ÅßÊ≠ª„Çì„Å†Â†¥Âêà
                killLogs.push({ msg: `${player.name} was lost to the Storm`, life: 180 });
            }
            rankings.push(player); // Ê≠ª‰∫°È†Ü„Å´ËøΩÂä†
            gameState = 'spectating';
            spectatingTimer = 3;
            gameResult = 'lose';
            showResultButton = false;
            // Ê≠ª‰∫°„Ç®„Éï„Çß„ÇØ„Éà
            const deathColor = player.charType === 'jack' ? '#b973ff' : (player.charType === 'sky' ? '#ffff00' : '#00d2ff');
            for(let j=0; j<30; j++) {
                particles.push({
                    x: player.x, y: player.y, vx: (Math.random()-0.5)*10, vy: (Math.random()-0.5)*10,
                    life: 40, maxLife: 40, color: deathColor, size: Math.random()*6+3
                });
            }
        }
        // ÂãùÂà©Âà§ÂÆö
        else if (enemies.filter(e => e.hp > 0).length === 0) {
            // Êïµ„ÅåÂÖ®ÊªÖ = „Éó„É¨„Ç§„É§„Éº„ÅÆÂãùÂà©
            // „Åæ„Å†rankings„Å´ÂÖ•„Å£„Å¶„ÅÑ„Å™„ÅÑÊïµ„Åå„ÅÑ„Çå„Å∞ËøΩÂä†ÔºàÂøµ„ÅÆ„Åü„ÇÅÔºâ
            enemies.forEach(e => { if(e.hp <= 0 && !rankings.includes(e)) rankings.push(e); });
            rankings.push(player); // ÊúÄÂæå„Å´Ëá™ÂàÜ„ÇíËøΩÂä†Ôºà1‰ΩçÔºâ
            
            // „É¨„Éº„ÉàÊõ¥Êñ∞ (ÈÄÜÈ†Ü„ÅåÈ†Ü‰Ωç: [1‰Ωç, 2‰Ωç...])
            updateEloRates([...rankings].reverse());
            savePlayerData(); saveAIRates();
            matchEnded = true;

            gameState = 'spectating';
            spectatingTimer = 3;
            gameResult = 'win';
            showResultButton = false;
            // Á¥ôÂêπÈõ™
            for (let i = 0; i < 150; i++) {
                confetti.push({
                    x: player.x + (Math.random()-0.5)*canvas.width,
                    y: player.y - canvas.height/2 - Math.random()*canvas.height,
                    vx: (Math.random() - 0.5) * 5,
                    vy: Math.random() * 5 + 2,
                    color: `hsl(${Math.random() * 360}, 100%, 50%)`,
                    rotation: Math.random() * 360,
                    rotationSpeed: (Math.random() - 0.5) * 10
                });
            }
        }
    }

    if (gameState === 'spectating') {
        spectatingTimer -= 1/60;
        if (spectatingTimer <= 0 && matchEnded) showResultButton = true;
        // Á¥ôÂêπÈõ™Êõ¥Êñ∞
        confetti.forEach(c => {
            c.y += c.vy; c.x += c.vx + Math.sin(c.y/50);
            c.rotation += c.rotationSpeed;
            if (c.y > player.y + canvas.height) c.y = player.y - canvas.height;
        });
    }

    // AI Update
    enemies.forEach(e => {
        updateAI(e);
        applyPhysics(e);
        processBurst(e);
    });
    
    // Ê≠ª‰∫°Âà§ÂÆö (Á∞°Êòì„É™„Çπ„Éù„Éº„É≥)
    if (player.y > WORLD_HEIGHT + 100 && gameState === 'playing') player.hp = 0; // ËêΩ‰∏ãÊ≠ª
    
    // Êïµ„ÅÆÊ≠ª‰∫°„ÉªÂâäÈô§Âá¶ÁêÜ
    for (let i = enemies.length - 1; i >= 0; i--) {
        const e = enemies[i];
        if (e.hp <= 0 || e.y > WORLD_HEIGHT + 100) {
            rankings.push(e);
            // Ê≠ª‰∫°„Ç®„Éï„Çß„ÇØ„Éà
            const deathColor = e.charType === 'jack' ? '#b973ff' : (e.charType === 'sky' ? '#ffff00' : '#00d2ff');
            for(let j=0; j<30; j++) {
                particles.push({
                    x: e.x, y: e.y, vx: (Math.random()-0.5)*10, vy: (Math.random()-0.5)*10,
                    life: 40, maxLife: 40, color: deathColor, size: Math.random()*6+3
                });
            }
            enemies.splice(i, 1);
        }
    }

    // Ë¶≥Êà¶‰∏≠„ÅÆÊ±∫ÁùÄÂà§ÂÆö („É´„Éº„ÉóÂ§ñ„ÅßÂÆâÂÖ®„Å´Âà§ÂÆö)
    if (gameState === 'spectating' && !matchEnded) {
        if (enemies.length <= 1) {
            if (enemies.length === 1) rankings.push(enemies[0]); // Áîü„ÅçÊÆã„Çä„Çí1‰Ωç„Å´ËøΩÂä†
            updateEloRates([...rankings].reverse());
            savePlayerData(); saveAIRates();
            matchEnded = true;
            spectatingTimer = 3;
        }
    }

    // ÊµÆÈÅä„Ç™„Éº„É©„Ç®„Éï„Çß„ÇØ„Éà
    if (Math.random() < 0.5) {
        const auraColor = player.charType === 'jack' 
            ? `rgba(255, 64, 64, ${Math.random()*0.5})`
            : player.charType === 'sky'
            ? `rgba(255, 255, 0, ${Math.random()*0.5})`
            : `rgba(0, 210, 255, ${Math.random()*0.5})`; // Blue aura for Julie
        particles.push({
            x: player.x + (Math.random()-0.5)*60, y: player.y + (Math.random()-0.5)*80,
            vx: (Math.random()-0.5)*0.5, vy: -Math.random()*2,
            life: 40, maxLife: 40, color: auraColor, size: Math.random()*3
        });
    }

    // Âºæ„ÅÆÂà§ÂÆö
    bullets.forEach((b, i) => {
        b.x += b.vx; b.y += b.vy;
        let removed = false;
        platforms.forEach(p => {
            const hitH = p.type === 1 ? p.h / 2 : p.h;
            if (p.type < 10 && b.x > p.x && b.x < p.x + p.w && b.y > p.y && b.y < p.y + hitH) {
                if (p.type === 0 || p.type === 1) removed = true; // „Éñ„É≠„ÉÉ„ÇØ„Å®Âè∞„ÅØÂºæ„ÇíÈÄö„Åï„Å™„ÅÑ
            }
        });
        
        // ÂØæ‰∫∫Âà§ÂÆö
        const targets = [player, ...enemies];
        targets.forEach(t => {
            if (t === b.owner || t.hp <= 0) return;
            if (Math.hypot(b.x - t.x, b.y - t.y) < t.radius) {
                removed = true;
                if (t.hp > 0) {
                    playSound(seHit);
                    const baseDmg = b.damage !== undefined ? b.damage : 10;
                    const damage = baseDmg * (b.owner ? getKillStats(b.owner.kills).atk : 1);
                    t.hp -= damage;
                    if (b.owner === player) player.damageDealt += damage;
                    if (b.owner) {
                        if (b.owner === player) player.damageDealt += damage;
                    }
                    t.damageTimer = 0; // Ë¢´Âºæ„ÅßÂõûÂæ©‰∏≠Êñ≠
                    
                    // AI„ÅåÊîªÊíÉ„ÇíÂΩì„Å¶„ÅüÂ†¥Âêà„ÄÅËøΩÊíÉ„É¢„Éº„Éâ„Å∏
                    if (b.owner !== player && b.owner.hp > 0) {
                        b.owner.chaseTarget = t;
                        b.owner.chaseTimer = 120; // 2ÁßíÈñìËøΩ„ÅÜ
                    }

                    // „Ç≠„É´„É≠„Ç∞
                    if (t.hp <= 0) {
                        killLogs.push({ msg: `${b.owner.name} killed ${t.name}`, life: 180 });
                        // Ê≠ª‰∫°Âá¶ÁêÜ„ÅØ„É°„Ç§„É≥„É´„Éº„Éó„ÅßË°å„ÅÜ„Åü„ÇÅ„Åì„Åì„Åß„ÅØ„Éï„É©„Ç∞ÁÆ°ÁêÜÁ≠â„ÅØ„Åó„Å™„ÅÑ
                        if (b.owner && b.owner.hp > 0) {
                            b.owner.kills++;
                            const stats = getKillStats(b.owner.kills);
                            const oldHp = b.owner.hp;
                            b.owner.maxHp = b.owner.baseMaxHp * stats.hp;
                            b.owner.hp = b.owner.maxHp; // Kill„ÅßÂÖ®ÂõûÂæ©
                            if (b.owner === player) player.healedAmount += (b.owner.hp - oldHp);
                            spawnHealEffect(b.owner.x, b.owner.y);
                        }
                    }

                    // AI„ÅåÊîªÊíÉ„Åï„Çå„ÅüÂ†¥Âêà„ÄÅÊîªÊíÉËÄÖ„ÇíË®òÈå≤„Åó„Å¶ÂèçÊíÉ„É¢„Éº„Éâ„Å∏
                    if (t !== player && b.owner) {
                        t.lastAttacker = b.owner;
                        t.revengeTimer = 300; // 5ÁßíÈñìÂü∑ÁùÄ„Åô„Çã
                    }
                }

                // Hit Effect
                for(let j=0; j<10; j++) {
                    particles.push({
                        x: b.x, y: b.y, vx: (Math.random()-0.5)*10, vy: (Math.random()-0.5)*10,
                        life: 20, maxLife: 20, color: '#ff0000', size: Math.random()*4+2
                    });
                }
            }
        });

        if (removed || b.x < 0 || b.x > WORLD_WIDTH || b.y < 0 || b.y > WORLD_HEIGHT) {
            if (removed) {
                // ÁùÄÂºæ„Ç®„Éï„Çß„ÇØ„Éà
                const effectColor = b.charType === 'jack' ? '#ffaaaa' : (b.charType === 'sky' ? '#fffacd' : '#e0ffff');
                for(let j=0; j<5; j++) { 
                    particles.push({
                        x: b.x, y: b.y, vx: (Math.random()-0.5)*5, vy: (Math.random()-0.5)*5,
                        life: 15, maxLife: 15, color: effectColor, size: Math.random()*3+1
                    });
                }
            }
            bullets.splice(i, 1);
        }
    });

    // „Éë„Éº„ÉÜ„Ç£„ÇØ„É´Êõ¥Êñ∞
    for (let i = particles.length - 1; i >= 0; i--) {
        let p = particles[i];
        p.x += p.vx; p.y += p.vy;
        p.life--;
        if (p.life <= 0) particles.splice(i, 1);
    }

    // „Ç≠„É´„É≠„Ç∞Êõ¥Êñ∞
    for (let i = killLogs.length - 1; i >= 0; i--) {
        killLogs[i].life--;
        if (killLogs[i].life <= 0) killLogs.splice(i, 1);
    }

    if (player.energy < player.maxEnergy) player.energy += 0.01;

    // „Ç´„É°„É©Êõ¥Êñ∞
    if (gameState === 'spectating') {
        // Ë¶≥Êà¶‰∏≠„ÅØ„Ç∏„Éß„Ç§„Çπ„ÉÜ„Ç£„ÉÉ„ÇØ„Åß„Ç´„É°„É©ÁßªÂãï
        if (sticks.left.active) {
            camera.x += Math.cos(sticks.left.angle) * (sticks.left.dist / 50) * 15;
            camera.y += Math.sin(sticks.left.angle) * (sticks.left.dist / 50) * 15;
        }
        // „Ç≠„Éº„Éú„Éº„ÉâÊìç‰Ωú
        if (keys['ArrowLeft'] || keys['KeyA']) camera.x -= 15;
        if (keys['ArrowRight'] || keys['KeyD']) camera.x += 15;
        if (keys['ArrowUp'] || keys['KeyW']) camera.y -= 15;
        if (keys['ArrowDown'] || keys['KeyS']) camera.y += 15;
    } else {
        camera.x = player.x - canvas.width / 2;
        camera.y = player.y - canvas.height * 0.7;
    }

    draw();
    requestAnimationFrame(update);
}

function draw() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    if (gameState === 'loading') {
        ctx.fillStyle = '#1a1a1a';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = '#fff';
        ctx.font = '30px Arial'; ctx.textAlign = 'center';
        ctx.fillText('„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ‰∏≠...', canvas.width/2, canvas.height/2 - 10);
        ctx.font = '20px Arial';
        ctx.fillText(`Now Loading... (${offlineSimCurrentMatch} / ${offlineSimTotalMatches})`, canvas.width/2, canvas.height/2 + 30);
        return;
    }

    ctx.save();
    ctx.translate(-camera.x, -camera.y);

    if (isEditor) {
        // „Ç∞„É™„ÉÉ„ÉâÊèèÁîª
        ctx.strokeStyle = 'rgba(255,255,255,0.15)';
        ctx.lineWidth = 1;
        ctx.beginPath();
        const startX = Math.floor(camera.x / TILE_SIZE) * TILE_SIZE;
        const startY = Math.floor(camera.y / TILE_SIZE) * TILE_SIZE;
        for (let x = startX; x < camera.x + canvas.width; x += TILE_SIZE) {
            ctx.moveTo(x, camera.y); ctx.lineTo(x, camera.y + canvas.height);
        }
        for (let y = startY; y < camera.y + canvas.height; y += TILE_SIZE) {
            ctx.moveTo(camera.x, y); ctx.lineTo(camera.x + canvas.width, y);
        }
        ctx.stroke();
    }

    platforms.forEach(p => {
        if (p.type >= 10) {
            if (isEditor) {
                ctx.fillStyle = p.color || '#ff00ff';
                ctx.globalAlpha = 0.5;
                ctx.fillRect(p.x, p.y, p.w, p.h);
                ctx.globalAlpha = 1.0;
                ctx.fillStyle = '#fff';
                ctx.font = '20px Arial';
                ctx.fillText('S' + (p.type - 9), p.x + 10, p.y + 30);
            }
            return;
        }
        
        let color = p.color;
        if (!color) {
            if (p.type === 0) color = '#8d4433';
            else if (p.type === 1) color = '#2ecc71';
            else color = '#3498db';
        }

        if (p.type === 2) { // Fence (Mesh)
            ctx.save();
            ctx.beginPath(); ctx.rect(p.x, p.y, p.w, p.h); ctx.clip();
            ctx.strokeStyle = color; ctx.lineWidth = 2;
            ctx.beginPath();
            const step = 15;
            for (let i = -p.h; i < p.w; i += step) { ctx.moveTo(p.x + i, p.y + p.h); ctx.lineTo(p.x + i + p.h, p.y); }
            for (let i = -p.h; i < p.w; i += step) { ctx.moveTo(p.x + i, p.y); ctx.lineTo(p.x + i + p.h, p.y + p.h); }
            ctx.stroke();
            ctx.strokeRect(p.x, p.y, p.w, p.h);
            ctx.restore();
        } else if (p.type === 1) { // Platform (Top half)
            ctx.fillStyle = color;
            ctx.fillRect(p.x, p.y, p.w, p.h / 2);
        } else { // Block
            ctx.fillStyle = color;
            ctx.fillRect(p.x, p.y, p.w, p.h);
        }
    });

    // „Éë„Éº„ÉÜ„Ç£„ÇØ„É´ÊèèÁîª
    particles.forEach(p => {
        ctx.save();
        ctx.globalAlpha = p.life / p.maxLife;
        ctx.fillStyle = p.color;
        ctx.beginPath(); ctx.arc(p.x, p.y, p.size, 0, Math.PI*2); ctx.fill();
        if (p.text) {
            ctx.fillStyle = p.color;
            ctx.font = 'bold ' + p.size + 'px Arial';
            ctx.textAlign = 'center';
            ctx.fillText(p.text, p.x, p.y);
        } else {
            ctx.fillStyle = p.color;
            ctx.beginPath(); ctx.arc(p.x, p.y, p.size, 0, Math.PI*2); ctx.fill();
        }
        ctx.restore();
    });

    // Á¥ôÂêπÈõ™ÊèèÁîª
    confetti.forEach(c => {
        ctx.save();
        ctx.translate(c.x, c.y);
        ctx.rotate(c.rotation * Math.PI / 180);
        ctx.fillStyle = c.color;
        ctx.fillRect(-5, -5, 10, 10);
        ctx.restore();
    });

    // ÂºæÈÅì‰∫àÊ∏¨Á∑ö
    if (sticks.right.active) {
        ctx.save();
        ctx.strokeStyle = 'rgba(255, 255, 255, 0.5)';
        ctx.setLineDash([4, 4]);
        ctx.lineWidth = 2;
        ctx.beginPath();
        const floatY = Math.sin(Date.now() / 500) * 10;
        ctx.moveTo(player.x, player.y + floatY);
        let tx = player.x, ty = player.y + floatY;
        let dx = Math.cos(sticks.right.angle) * 10, dy = Math.sin(sticks.right.angle) * 10;
        for (let i = 0; i < 100; i++) { // ÊúÄÂ§ßË∑ùÈõ¢Âà∂Èôê
            tx += dx; ty += dy;
            let hit = platforms.some(p => {
                const hitH = p.type === 1 ? p.h / 2 : p.h;
                return p.type < 10 && (p.type === 0 || p.type === 1) && tx > p.x && tx < p.x + p.w && ty > p.y && ty < p.y + hitH;
            });
            if (hit) break;
        }
        ctx.lineTo(tx, ty);
        ctx.stroke();
        ctx.restore();
    }

    // ÂºæÊèèÁîª („Ç®„Éç„É´„ÇÆ„ÉºÂºæÈ¢®)
    bullets.forEach(b => {
        ctx.save();
        if (b.charType === 'jack') {
            // „Ç∏„É£„ÉÉ„ÇØ„ÅÆÂºæ: Ê•ïÂÜÜÂΩ¢„ÅÆËµ§Á≥ª
            ctx.shadowBlur = 10;
            ctx.shadowColor = '#ff0000';
            ctx.fillStyle = '#ffaaaa';
            ctx.translate(b.x, b.y);
            ctx.rotate(Math.atan2(b.vy, b.vx)); // ÈÄ≤Ë°åÊñπÂêë„Å´ÂõûËª¢
            ctx.scale(1.5, 0.7); // Ê•ïÂÜÜÂΩ¢„Å´„Åô„Çã
            ctx.beginPath();
            ctx.arc(0, 0, 8, 0, Math.PI * 2); // ÂçäÂæÑ8„ÅÆÂÜÜ„ÇíÊ•ïÂÜÜ„Å´„Åô„Çã
            ctx.fill();
        } else if(b.charType === 'sky') {
            // „Çπ„Ç´„Ç§„ÅÆÂºæ: ÂõõËßíÂΩ¢„ÅÆÈªÑËâ≤Á≥ª
            ctx.shadowBlur = 12;
            ctx.shadowColor = '#ffff00';
            ctx.fillStyle = '#fffacd';
            ctx.translate(b.x, b.y);
            ctx.rotate(Math.atan2(b.vy, b.vx)); // ÈÄ≤Ë°åÊñπÂêë„Å´ÂõûËª¢
            ctx.fillRect(-10, -5, 20, 10); // ÂõõËßíÂΩ¢
        } else {
            // „Ç∏„É•„É™„Éº„ÅÆÂºæ (Êó¢Â≠ò)
            ctx.shadowBlur = 10;
            ctx.shadowColor = '#00d2ff';
            ctx.fillStyle = '#e0ffff';
            ctx.beginPath(); ctx.arc(b.x, b.y, 12, 0, Math.PI*2); ctx.fill();
        }
        ctx.restore();
    });

    const floatY = Math.sin(Date.now() / 500) * 10;

    // ÂΩ±„ÅÆÊèèÁîª
    let shadowY = 99999;
    platforms.forEach(p => {
        if (p.type < 10 && player.x >= p.x && player.x <= p.x + p.w) {
            if (p.y >= player.y + player.radius - 20) {
                if (p.y < shadowY) shadowY = p.y;
            }
        }
    });

    ctx.save();
    ctx.translate(player.x, shadowY);
    ctx.scale(1, 0.3);
    const dist = Math.max(0, shadowY - (player.y + player.radius));
    const alpha = Math.max(0, 0.4 * (1 - dist / 400));
    ctx.fillStyle = `rgba(0, 0, 0, ${alpha})`;
    ctx.beginPath(); ctx.arc(0, 0, player.radius * 0.8, 0, Math.PI*2); ctx.fill();
    ctx.restore();

    // „Ç≠„É£„É©„ÇØ„Çø„ÉºÊèèÁîª (ÂÖ±ÈÄöÈñ¢Êï∞Âåñ„Åó„Å¶„ÇÇ„Çà„ÅÑ„Åå„ÄÅ„Åì„Åì„Åß„ÅØ„É´„Éº„Éó„ÅßÂá¶ÁêÜ)
    [player, ...enemies].forEach(char => {
    if (char === player && gameState !== 'playing' && gameResult === 'lose') return; // Ê≠ª‰∫°ÊôÇ„ÅØÊèèÁîª„Åó„Å™„ÅÑ
    ctx.save();
    ctx.translate(char.x, char.y + floatY);
    ctx.scale(char.facing, 1); // Âêë„Åç„Å´Âêà„Çè„Åõ„Å¶ÂèçËª¢
    const cImg = charImages[char.charType || 'julie'];
    
    if (cImg && cImg.complete && cImg.naturalHeight !== 0) {
        const h = char.radius * 2;
        const w = h * (cImg.naturalWidth / cImg.naturalHeight);
        ctx.drawImage(cImg, -w/2, -h/2, w, h);
    } else {
        ctx.fillStyle = char.color;
        ctx.beginPath(); ctx.arc(0, 0, char.radius, 0, Math.PI*2); ctx.fill();
        ctx.fillStyle = '#fff'; ctx.fillRect(-8, -12, 16, 10);
    }
    ctx.restore();

    // ÈäÉ„ÅÆÊèèÁîª
    ctx.save();
    ctx.translate(char.x, char.y + floatY);
    let aimAngle = 0;
    if (char === player) {
        aimAngle = sticks.right.active ? sticks.right.angle : (char.facing === 1 ? 0 : Math.PI);
    } else {
        // AI Aim
        // „Çø„Éº„Ç≤„ÉÉ„Éà„Åå„ÅÑ„Å¶„ÄÅ„Åã„Å§Ë¶ñÁ∑ö„ÅåÈÄö„Å£„Å¶„ÅÑ„Çã„Å™„ÇâÈäÉ„ÇíÂêë„Åë„Çã (Â∞ÑÁ∑ö„ÅåÂ£Å„ÅßÂ∞ë„ÅóÈö†„Çå„Å¶„ÅÑ„Å¶„ÇÇÁãô„ÅÜ)
        if (char.target && checkLineOfSight(char, char.target)) {
            aimAngle = Math.atan2(char.target.y - char.y, char.target.x - char.x);
        } else {
            // Â∞ÑÁ∑ö„ÅåÈÄö„Å£„Å¶„ÅÑ„Å™„ÅÑ„Å®„Åç„ÅØÈÄ≤Ë°åÊñπÂêë(„Åæ„Åü„ÅØÂæÖÊ©üÊñπÂêë)„ÇíÂêë„Åè
            aimAngle = char.facing === 1 ? 0 : Math.PI;
        }
    }
    
    ctx.rotate(aimAngle);
    if (Math.cos(aimAngle) < 0) ctx.scale(1, -1);
    const gImg = gunImages[char.charType || 'julie'];
    if (gImg && gImg.complete && gImg.naturalHeight !== 0) {
        const h = 27;
        const w = h * (gImg.naturalWidth / gImg.naturalHeight);
        ctx.drawImage(gImg, 20, -h/2, w, h);
    } else {
        ctx.fillStyle = '#333';
        ctx.fillRect(10, -4, 24, 8);
    }
    ctx.restore();

    // ÂêçÂâçÊèèÁîª
    ctx.save();
    const currentRate = char.rate !== undefined ? char.rate : 1500;
    ctx.textAlign = 'center';
    
    let nameColor = '#fff';
    let nameShadow = '#000';
    let nameBlur = 4;
    let nameFont = '14px Arial';
    
    if (currentRate >= 2500) { // Absolute (Rainbow)
        nameFont = 'bold 16px Arial';
        nameShadow = 'rgba(255, 255, 255, 1.0)';
        nameBlur = 20;
        const grad = ctx.createLinearGradient(char.x - 30, char.y - 70, char.x + 30, char.y - 50);
        grad.addColorStop(0, '#ff0000'); grad.addColorStop(0.15, '#ff7f00'); grad.addColorStop(0.3, '#ffff00');
        grad.addColorStop(0.45, '#00ff00'); grad.addColorStop(0.6, '#0000ff'); grad.addColorStop(0.75, '#4b0082'); grad.addColorStop(1, '#9400d3');
        nameColor = grad;
    } else if (currentRate >= 2450) { // Cosmic
        nameFont = 'bold 16px Arial'; nameShadow = 'rgba(255, 0, 255, 0.9)'; nameBlur = 18;
        const grad = ctx.createLinearGradient(char.x - 25, char.y - 70, char.x + 25, char.y - 50);
        grad.addColorStop(0, '#ff00cc'); grad.addColorStop(0.5, '#3300ff'); grad.addColorStop(1, '#00ffff');
        nameColor = grad;
    } else if (currentRate >= 2400) { // Inferno
        nameFont = 'bold 16px Arial'; nameShadow = 'rgba(255, 69, 0, 0.9)'; nameBlur = 18;
        const grad = ctx.createLinearGradient(char.x - 25, char.y - 70, char.x + 25, char.y - 50);
        grad.addColorStop(0, '#ff4500'); grad.addColorStop(0.5, '#ff8c00'); grad.addColorStop(1, '#ffd700');
        nameColor = grad;
    } else if (currentRate >= 2350) { // Nature
        nameFont = 'bold 15px Arial'; nameShadow = 'rgba(0, 255, 127, 0.9)'; nameBlur = 16;
        const grad = ctx.createLinearGradient(char.x - 25, char.y - 70, char.x + 25, char.y - 50);
        grad.addColorStop(0, '#00ff7f'); grad.addColorStop(0.5, '#adff2f'); grad.addColorStop(1, '#f0fff0');
        nameColor = grad;
    } else if (currentRate >= 2300) { // Ice
        nameFont = 'bold 15px Arial'; nameShadow = 'rgba(0, 191, 255, 0.9)'; nameBlur = 16;
        const grad = ctx.createLinearGradient(char.x - 25, char.y - 70, char.x + 25, char.y - 50);
        grad.addColorStop(0, '#00bfff'); grad.addColorStop(0.5, '#1e90ff'); grad.addColorStop(1, '#ffffff');
        nameColor = grad;
    } else if (currentRate >= 2250) { // Darkness
        nameFont = 'bold 15px Arial'; nameShadow = 'rgba(255, 0, 0, 0.9)'; nameBlur = 16;
        const grad = ctx.createLinearGradient(char.x - 25, char.y - 70, char.x + 25, char.y - 50);
        grad.addColorStop(0, '#000000'); grad.addColorStop(0.5, '#8b0000'); grad.addColorStop(1, '#ff0000');
        nameColor = grad;
    } else if (currentRate >= 2200) { // Light
        nameFont = 'bold 15px Arial'; nameShadow = 'rgba(255, 215, 0, 0.9)'; nameBlur = 16;
        const grad = ctx.createLinearGradient(char.x - 25, char.y - 70, char.x + 25, char.y - 50);
        grad.addColorStop(0, '#fffacd'); grad.addColorStop(0.5, '#ffd700'); grad.addColorStop(1, '#ffffff');
        nameColor = grad;
    } else if (currentRate >= 2150) { // Cyber
        nameFont = 'bold 15px Arial'; nameShadow = 'rgba(255, 20, 147, 0.9)'; nameBlur = 15;
        const grad = ctx.createLinearGradient(char.x - 25, char.y - 70, char.x + 25, char.y - 50);
        grad.addColorStop(0, '#ff1493'); grad.addColorStop(0.5, '#00ffff'); grad.addColorStop(1, '#ff1493');
        nameColor = grad;
    } else if (currentRate >= 2100) { // Royal
        nameFont = 'bold 15px Arial'; nameShadow = 'rgba(148, 0, 211, 0.9)'; nameBlur = 15;
        const grad = ctx.createLinearGradient(char.x - 25, char.y - 70, char.x + 25, char.y - 50);
        grad.addColorStop(0, '#ffd700'); grad.addColorStop(0.5, '#9400d3'); grad.addColorStop(1, '#ffd700');
        nameColor = grad;
    } else if (currentRate >= 2050) { // Blood
        nameFont = 'bold 15px Arial'; nameShadow = 'rgba(139, 0, 0, 0.9)'; nameBlur = 15;
        const grad = ctx.createLinearGradient(char.x - 25, char.y - 70, char.x + 25, char.y - 50);
        grad.addColorStop(0, '#8b0000'); grad.addColorStop(0.5, '#ff0000'); grad.addColorStop(1, '#000000');
        nameColor = grad;
    } else if (currentRate >= 2000) { // Master
        nameFont = 'bold 15px Arial'; nameShadow = 'rgba(0, 0, 255, 0.9)'; nameBlur = 15;
        const grad = ctx.createLinearGradient(char.x - 25, char.y - 70, char.x + 25, char.y - 50);
        grad.addColorStop(0, '#ff0000'); grad.addColorStop(0.5, '#ffffff'); grad.addColorStop(1, '#0000ff');
        nameColor = grad;
    } else if (currentRate >= 1950) { // Crystal
        nameFont = 'bold 14px Arial'; nameShadow = 'rgba(0, 255, 255, 0.8)'; nameBlur = 14;
        const grad = ctx.createLinearGradient(char.x - 20, char.y - 70, char.x + 20, char.y - 50);
        grad.addColorStop(0, '#00ffff'); grad.addColorStop(1, '#ffffff');
        nameColor = grad;
    } else if (currentRate >= 1900) { // Obsidian
        nameFont = 'bold 14px Arial'; nameShadow = 'rgba(75, 0, 130, 0.8)'; nameBlur = 14;
        const grad = ctx.createLinearGradient(char.x - 20, char.y - 70, char.x + 20, char.y - 50);
        grad.addColorStop(0, '#4b0082'); grad.addColorStop(1, '#000000');
        nameColor = grad;
    } else if (currentRate >= 1850) { // Magma
        nameFont = 'bold 14px Arial'; nameShadow = 'rgba(255, 69, 0, 0.8)'; nameBlur = 14;
        const grad = ctx.createLinearGradient(char.x - 20, char.y - 70, char.x + 20, char.y - 50);
        grad.addColorStop(0, '#ff4500'); grad.addColorStop(1, '#ffff00');
        nameColor = grad;
    } else if (currentRate >= 1800) { // Forest
        nameFont = 'bold 14px Arial'; nameShadow = 'rgba(0, 128, 0, 0.8)'; nameBlur = 14;
        const grad = ctx.createLinearGradient(char.x - 20, char.y - 70, char.x + 20, char.y - 50);
        grad.addColorStop(0, '#006400'); grad.addColorStop(1, '#00ff00');
        nameColor = grad;
    } else if (currentRate >= 1750) { // Ocean
        nameFont = 'bold 14px Arial'; nameShadow = 'rgba(0, 191, 255, 0.8)'; nameBlur = 14;
        const grad = ctx.createLinearGradient(char.x - 20, char.y - 70, char.x + 20, char.y - 50);
        grad.addColorStop(0, '#00bfff'); grad.addColorStop(1, '#e0ffff');
        nameColor = grad;
    } else if (currentRate >= 1700) { // Gold
        nameFont = 'bold 14px Arial'; nameShadow = 'rgba(255, 215, 0, 0.8)'; nameBlur = 12;
        const grad = ctx.createLinearGradient(char.x - 20, char.y - 70, char.x + 20, char.y - 50);
        grad.addColorStop(0, '#ffd700'); grad.addColorStop(0.5, '#ffffff'); grad.addColorStop(1, '#ffd700');
        nameColor = grad;
    } else if (currentRate >= 1650) { // Pink
        nameFont = 'bold 14px Arial'; nameShadow = 'rgba(255, 0, 100, 0.8)'; nameBlur = 12;
        const grad = ctx.createLinearGradient(char.x - 20, char.y - 70, char.x + 20, char.y - 50);
        grad.addColorStop(0, '#fff'); grad.addColorStop(1, '#ff0066');
        nameColor = grad;
    } else if (currentRate >= 1600) { // Purple
        nameFont = 'bold 14px Arial'; nameShadow = 'rgba(138, 43, 226, 0.8)'; nameBlur = 12;
        const grad = ctx.createLinearGradient(char.x - 20, char.y - 70, char.x + 20, char.y - 50);
        grad.addColorStop(0, '#fff'); grad.addColorStop(1, '#8a2be2');
        nameColor = grad;
    } else if (currentRate >= 1550) { // Violet
        nameFont = 'bold 14px Arial'; nameShadow = '#d000ff'; nameBlur = 10;
        nameColor = '#fff';
    } else if (currentRate >= 1500) { // Cyan
        nameFont = 'bold 14px Arial'; nameShadow = '#00ffff'; nameBlur = 10;
        nameColor = '#fff';
    }

    ctx.font = nameFont;
    ctx.shadowColor = nameShadow;
    ctx.shadowBlur = nameBlur;
    ctx.fillStyle = nameColor;
    ctx.fillText(`${char.name}`, char.x, char.y - 60);
    ctx.restore();

    // „Ç≠„É´„Éê„ÉÉ„Ç∏ÊèèÁîª
    if (char.kills > 0) {
        const stats = getKillStats(char.kills);
        const bx = char.x - 35; // ÂêçÂâç„ÅÆÂ∑¶ÂÅ¥„ÅÇ„Åü„Çä
        const by = char.y - 65;
        
        ctx.save();
        ctx.translate(bx, by);
        // „Éó„É¨„Éº„Éà
        ctx.fillStyle = stats.color;
        ctx.strokeStyle = stats.border;
        ctx.lineWidth = 2;
        ctx.beginPath(); ctx.arc(0, 0, 10, 0, Math.PI*2); ctx.fill(); ctx.stroke();
        // ÊñáÂ≠ó
        ctx.fillStyle = '#fff';
        ctx.font = 'bold 12px Arial';
        ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
        ctx.shadowBlur = 0;
        ctx.fillText(stats.label, 0, 1);
        ctx.restore();
    }

    // HP„Ç≤„Éº„Ç∏ÊèèÁîª
    // ÂêçÂâçÊèèÁîª„ÅÆÂΩ±Èüø„ÇíÂèó„Åë„Å™„ÅÑ„Çà„ÅÜ„Å´ÂΩ±„ÇíÂÜçË®≠ÂÆö
    ctx.shadowColor = '#000'; ctx.shadowBlur = 4;
    const hx = char.x - 20, hy = char.y - 50, hw = 40, hh = 6;
    ctx.fillStyle = 'black'; ctx.fillRect(hx, hy, hw, hh);
    // Á∑ëÈÉ®ÂàÜ (Âü∫Á§é‰ΩìÂäõÂàÜ)
    const greenRatio = Math.min(char.hp, char.baseMaxHp) / char.maxHp;
    ctx.fillStyle = '#0f0'; ctx.fillRect(hx, hy, hw * greenRatio, hh);
    // ÈªÑËâ≤ÈÉ®ÂàÜ (Â¢óÂä†ÂàÜ)
    if (char.hp > char.baseMaxHp) {
        const yellowRatio = (char.hp - char.baseMaxHp) / char.maxHp;
        ctx.fillStyle = '#ff0'; ctx.fillRect(hx + hw * greenRatio, hy, hw * yellowRatio, hh);
    }

    // „Ç≤„Éº„Ç∏ÊèèÁîª
    const gx = char.x - 20, gy = char.y - 40, gw = 40, gh = 6;
    ctx.fillStyle = 'black'; ctx.fillRect(gx, gy, gw, gh);
    ctx.fillStyle = char === player ? '#00f' : '#f00'; 
    ctx.fillRect(gx, gy, gw * (char.energy/char.maxEnergy), gh);
    // ÂàÜÂâ≤Á∑ö
    ctx.fillStyle = 'rgba(255,255,255,0.7)';
    for(let i=1; i < char.maxEnergy; i++) ctx.fillRect(gx + (gw/char.maxEnergy)*i, gy, 1, gh);

    });

    ctx.restore();

    // ‰ΩéHPÊôÇ„ÅÆÁîªÈù¢ÂäπÊûú (Ëµ§„ÅèÁÇπÊªÖ)
    if (gameState === 'playing' && player.hp > 0) {
        const hpRatio = player.hp / player.maxHp;
        if (hpRatio < 0.4) {
            const opacity = (0.4 - hpRatio) * 2.0 * (0.8 + Math.sin(Date.now() / 200) * 0.2); // ÁÇπÊªÖ
            const maxDim = Math.max(canvas.width, canvas.height);
            const grad = ctx.createRadialGradient(
                canvas.width/2, canvas.height/2, Math.min(canvas.width, canvas.height) * 0.3,
                canvas.width/2, canvas.height/2, maxDim * 0.8
            );
            grad.addColorStop(0, 'rgba(255, 0, 0, 0)');
            grad.addColorStop(1, `rgba(255, 0, 0, ${Math.min(opacity, 0.8)})`);
            ctx.fillStyle = grad;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
        }
    }

    // „Ç≠„É´„É≠„Ç∞ÊèèÁîª
    ctx.save();
    ctx.textAlign = 'right';
    ctx.font = '16px Arial';
    killLogs.forEach((log, i) => {
        ctx.fillStyle = '#fff'; ctx.shadowColor = '#000'; ctx.shadowBlur = 4;
        ctx.fillText(log.msg, canvas.width - 10, 30 + i * 24);
    });
    ctx.restore();

    // UI („Çπ„ÉÜ„Ç£„ÉÉ„ÇØ)
    if (!isEditor) {
        [sticks.left, sticks.right].forEach(s => {
            if (s.active) {
                ctx.strokeStyle = 'rgba(255,255,255,0.3)';
                ctx.beginPath(); ctx.arc(s.startX, s.startY, 50, 0, Math.PI*2); ctx.stroke();
                ctx.beginPath(); ctx.arc(s.currX, s.currY, 20, 0, Math.PI*2); ctx.stroke();
            }
        });
    }

    // „Ç∏„É£„É≥„Éó„Éú„Çø„É≥ÊèèÁîª
    let jbx = canvas.width - jumpBtn.right, jby = canvas.height - jumpBtn.bottom;
    ctx.fillStyle = 'rgba(255, 255, 255, 0.3)';
    ctx.beginPath(); ctx.arc(jbx, jby, jumpBtn.radius, 0, Math.PI*2); ctx.fill();
    ctx.fillStyle = '#fff';
    ctx.font = '16px Arial'; ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
    ctx.fillText('JUMP', jbx, jby);

    if (gameState === 'home') {
        ctx.fillStyle = '#1a1a1a';
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        // Draw home particles
        homeParticles.forEach(p => {
            ctx.fillStyle = `rgba(255, 255, 255, ${p.alpha})`;
            ctx.beginPath();
            ctx.arc(p.x, p.y, p.radius, 0, Math.PI * 2);
            ctx.fill();
        });

        // „Çø„Ç§„Éà„É´
        ctx.fillStyle = '#fff';
        ctx.font = '40px Arial';
        ctx.textAlign = 'center';
        ctx.fillText('2D Scroll Battle', canvas.width/2, canvas.height/2);

        ctx.fillStyle = '#00d2ff';
        ctx.font = 'bold 20px Arial';
        ctx.fillText(`Online: ${currentOnlineCount}`, canvas.width/2, canvas.height/2 - 65);

        // Top-left player info
        ctx.fillStyle = 'rgba(0,0,0,0.4)';
        ctx.strokeStyle = 'rgba(255,255,255,0.5)';
        ctx.lineWidth = 1;
        ctx.beginPath();
        ctx.roundRect(10, 10, 240, 70, 8);
        ctx.fill();
        ctx.stroke();

        ctx.fillStyle = '#fff';
        ctx.font = 'bold 18px Arial';
        ctx.textAlign = 'left';
        ctx.fillText(`${player.name}`, 25, 40);
        ctx.font = '14px Arial';
        ctx.fillText(`Rate: ${player.rate}`, 25, 60);
        ctx.font = '10px Arial';
        ctx.fillStyle = 'rgba(255,255,255,0.6)';
        ctx.fillText('(Click to change name)', 130, 25);

        // Ranking Button
        const rankBtn = { x: canvas.width - 160, y: 10, w: 150, h: 40 };
        ctx.fillStyle = '#f1c40f'; ctx.fillRect(rankBtn.x, rankBtn.y, rankBtn.w, rankBtn.h);
        ctx.fillStyle = '#000'; ctx.font = 'bold 16px Arial'; ctx.textAlign = 'center';
        ctx.fillText('üèÜ Ranking', rankBtn.x + rankBtn.w/2, rankBtn.y + 25);

        // Play Button
        const playBtn = { x: canvas.width / 2 - 100, y: canvas.height - 120, w: 200, h: 50 };
        ctx.fillStyle = '#2ecc71'; ctx.fillRect(playBtn.x, playBtn.y, playBtn.w, playBtn.h);
        ctx.fillStyle = '#fff'; ctx.font = '24px Arial'; ctx.textAlign = 'center';
        ctx.fillText('PLAY', playBtn.x + playBtn.w / 2, playBtn.y + 33);

        // Character Select Button
        const charBtn = { x: canvas.width / 2 - 100, y: canvas.height - 60, w: 200, h: 40 };
        ctx.fillStyle = '#3498db'; ctx.fillRect(charBtn.x, charBtn.y, charBtn.w, charBtn.h);
        ctx.fillStyle = '#fff'; ctx.font = '18px Arial';
        ctx.fillText('Character Select', charBtn.x + charBtn.w / 2, charBtn.y + 25);

        // Export Button
        const exportBtn = { x: 10, y: canvas.height - 150, w: 150, h: 40 };
        ctx.fillStyle = '#34495e'; ctx.fillRect(exportBtn.x, exportBtn.y, exportBtn.w, exportBtn.h);
        ctx.fillStyle = '#fff'; ctx.font = '16px Arial'; ctx.textAlign = 'center'; ctx.fillText('Export Save', exportBtn.x + exportBtn.w/2, exportBtn.y + 25);

        // Import Button
        const importBtn = { x: 10, y: canvas.height - 100, w: 150, h: 40 };
        ctx.fillStyle = '#34495e'; ctx.fillRect(importBtn.x, importBtn.y, importBtn.w, importBtn.h);
        ctx.fillStyle = '#fff'; ctx.fillText('Import Save', importBtn.x + importBtn.w/2, importBtn.y + 25);

        // Data Reset Button
        const resetBtn = { x: 10, y: canvas.height - 50, w: 150, h: 40 };
        ctx.fillStyle = '#e74c3c';
        ctx.fillRect(resetBtn.x, resetBtn.y, resetBtn.w, resetBtn.h);
        ctx.fillStyle = '#fff'; ctx.font = '18px Arial'; ctx.textAlign = 'center';
        ctx.fillText('„Éá„Éº„Çø„É™„Çª„ÉÉ„Éà', resetBtn.x + resetBtn.w / 2, resetBtn.y + 25);

        // Volume Slider
        const slider = { x: canvas.width - 160, y: canvas.height - 50, w: 150, h: 40 };
        ctx.font = '12px Arial';
        ctx.fillStyle = '#aaa';
        ctx.textAlign = 'right';
        ctx.fillText('BGM', slider.x - 5, slider.y + 25);

        // Bar
        ctx.fillStyle = '#555';
        ctx.fillRect(slider.x, slider.y + 15, slider.w, 10);

        // Knob
        const knobX = slider.x + slider.w * bgmVolume;
        ctx.fillStyle = '#fff';
        ctx.beginPath(); ctx.arc(knobX, slider.y + 20, 8, 0, Math.PI * 2); ctx.fill();

        // Credit
        ctx.font = '12px Arial';
        ctx.fillStyle = '#aaa';
        ctx.textAlign = 'right';
        ctx.fillText('Èü≥Ê•ΩÔºöÈ≠îÁéãÈ≠Ç Êßò', canvas.width - 10, canvas.height - 10);
    } else if (gameState === 'charSelect') {
        ctx.fillStyle = '#1a1a1a';
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        const charData = characterStats[selectedCharInUI];
        const charImg = charImages[selectedCharInUI];

        // Character Image
        if (charImg && charImg.complete && charImg.naturalHeight !== 0) {
            const imgH = 400;
            const imgW = imgH * (charImg.naturalWidth / charImg.naturalHeight);
            ctx.drawImage(charImg, canvas.width / 2 - imgW / 2, 100, imgW, imgH);
        }

        // Character Name
        ctx.fillStyle = '#fff';
        ctx.font = 'bold 40px Arial';
        ctx.textAlign = 'center';
        ctx.fillText(charData.name, canvas.width / 2, 80);

        // Stats
        const statsY = 550;
        ctx.font = '20px Arial';
        ctx.textAlign = 'center';
        ctx.fillText(`HP: ${charData.hp} | Speed: ${charData.speed} | Attack Gauge: ${charData.energy}`, canvas.width / 2, statsY);
        
        ctx.font = '16px Arial';
        ctx.fillStyle = '#ccc';
        ctx.fillText(charData.description, canvas.width / 2, statsY + 40);

        // Navigation Arrows
        ctx.fillStyle = '#fff';
        ctx.font = '80px Arial';
        ctx.fillText('<', 80, canvas.height / 2 + 20);
        ctx.fillText('>', canvas.width - 80, canvas.height / 2 + 20);

        // Select Button
        const selectBtn = { x: canvas.width / 2 - 100, y: canvas.height - 60, w: 200, h: 40 };
        ctx.fillStyle = '#2ecc71'; ctx.fillRect(selectBtn.x, selectBtn.y, selectBtn.w, selectBtn.h);
        ctx.fillStyle = '#fff'; ctx.font = '18px Arial'; ctx.fillText('Select', selectBtn.x + selectBtn.w / 2, selectBtn.y + 25);

        // Back Button
        const backBtn = { x: 20, y: 20, w: 100, h: 40 };
        ctx.fillStyle = '#555'; ctx.fillRect(backBtn.x, backBtn.y, backBtn.w, backBtn.h);
        ctx.fillStyle = '#fff'; ctx.font = '18px Arial'; ctx.fillText('Back', backBtn.x + backBtn.w / 2, backBtn.y + 25);
    } else if (gameState === 'matching') {
        ctx.fillStyle = '#1a1a1a';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = '#fff';
        ctx.font = '30px Arial';
        ctx.textAlign = 'center';
        ctx.fillText('„Éû„ÉÉ„ÉÅ„É≥„Ç∞‰∏≠...', canvas.width/2, canvas.height/2 - 20);
        ctx.font = '24px Arial';
        ctx.fillText(`Players Found: ${joinedEnemies.length + 1}/4`, canvas.width/2, canvas.height/2 + 20);

        // ÂèÇÂä†ËÄÖ„É™„Çπ„ÉàË°®Á§∫
        ctx.font = '18px Arial';
        ctx.textAlign = 'left';
        const listX = canvas.width/2 - 100;
        let listY = canvas.height/2 + 60;
        ctx.fillText(`1. ${player.name} (R:${player.rate})`, listX, listY);
        joinedEnemies.forEach((e, i) => {
            const r = aiRates[e.nameID] || 1500;
            ctx.fillText(`${i+2}. ${e.name} (R:${r})`, listX, listY + (i+1)*25);
        });
    } else if (gameState === 'countdown') {
        ctx.fillStyle = 'rgba(0,0,0,0.3)';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = '#fff';
        ctx.font = '80px Arial';
        ctx.textAlign = 'center';
        const count = Math.ceil(countdownTime);
        ctx.fillText(count > 0 ? count : 'GO!', canvas.width/2, canvas.height/2);
    } else if (gameState === 'spectating') {
        if (!matchEnded) {
            ctx.fillStyle = '#fff';
            ctx.font = '40px Arial'; ctx.textAlign = 'center';
            ctx.fillText('Spectating...', canvas.width/2, canvas.height/2 - 50);
            ctx.font = '20px Arial';
            ctx.fillText(`Remaining Enemies: ${enemies.length}`, canvas.width/2, canvas.height/2);
        } else {
            if (gameResult === 'win') {
                ctx.fillStyle = '#ffd700';
                ctx.font = '60px Arial'; ctx.textAlign = 'center';
                ctx.fillText('VICTORY!', canvas.width/2, canvas.height/2 - 50);
            } else {
                ctx.fillStyle = '#ff0000';
                ctx.font = '60px Arial'; ctx.textAlign = 'center';
                ctx.fillText('DEFEAT', canvas.width/2, canvas.height/2 - 50);
            }
            if (showResultButton) {
                ctx.fillStyle = '#3498db';
                ctx.fillRect(canvas.width/2 - 100, canvas.height/2 + 75, 200, 50);
                ctx.fillStyle = '#fff'; ctx.font = '20px Arial';
                ctx.fillText('View Results', canvas.width/2, canvas.height/2 + 105);
            }
        }
    } else if (gameState === 'ranking') {
        ctx.fillStyle = '#1a1a1a';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        
        ctx.fillStyle = '#fff';
        ctx.font = 'bold 30px Arial'; ctx.textAlign = 'center';
        ctx.fillText('üèÜ Global Ranking', canvas.width/2, 60);

        // Âπ≥Âùá„É¨„Éº„ÉàË®àÁÆó
        const totalRate = rankingData.reduce((sum, r) => sum + r.rate, 0);
        const avgRate = Math.floor(totalRate / rankingData.length);
        ctx.font = '16px Arial';
        ctx.fillStyle = '#aaa';
        ctx.fillText(`Average Rate: ${avgRate}`, canvas.width/2, 85);

        // Ë°®Á§∫Áî®„É™„Çπ„Éà‰ΩúÊàê (‰∏ä‰Ωç12‰Ωç + Ëá™ÂàÜ)
        let displayList = [];
        for (let i = 0; i < rankingData.length; i++) {
            if (i < 12) {
                displayList.push({ ...rankingData[i], rank: i + 1 });
            } else if (rankingData[i].isPlayer) {
                displayList.push({ ...rankingData[i], rank: i + 1 });
                break;
            }
        }

        // „Çπ„ÇØ„É≠„Éº„É´È†òÂüüË®àÁÆó
        const listTop = 110;
        const listBottom = canvas.height - 100;
        const listHeight = listBottom - listTop;
        const lineHeight = 35;
        const contentHeight = displayList.length * lineHeight;

        // „Çπ„ÇØ„É≠„Éº„É´Âà∂Èôê
        const maxScroll = Math.max(0, contentHeight - listHeight);
        if (rankingScrollY > maxScroll) rankingScrollY = maxScroll;
        if (rankingScrollY < 0) rankingScrollY = 0;

        ctx.save();
        ctx.beginPath();
        ctx.rect(0, listTop, canvas.width, listHeight);
        ctx.clip();

        ctx.font = '20px Arial'; ctx.textAlign = 'left';
        const startY = listTop + 30 - rankingScrollY;
        
        // Ë°®Á§∫ÁØÑÂõ≤ÂÜÖ„ÅÆË¶ÅÁ¥†„Å†„ÅëÊèèÁîª
        const startIndex = Math.floor(rankingScrollY / lineHeight);
        const endIndex = Math.min(displayList.length, startIndex + Math.ceil(listHeight / lineHeight) + 1);

        for (let i = startIndex; i < endIndex; i++) {
            const r = displayList[i];
            const y = startY + i * lineHeight;
            
            ctx.save();
            let rankColor = '#fff';
            let rankShadow = 'transparent';
            let rankBlur = 0;
            let rankFont = '20px Arial';

            // „Ç∞„É©„Éá„Éº„Ç∑„Éß„É≥Â∫ßÊ®ô (Ë°åÂÖ®‰Ωì)
            const gx1 = canvas.width/2 - 180;
            const gy1 = y - 20;
            const gx2 = canvas.width/2 + 150;
            const gy2 = y;

            if (r.rate >= 2500) { // Absolute
                rankFont = 'bold 20px Arial'; rankShadow = 'rgba(255, 255, 255, 1.0)'; rankBlur = 20;
                const grad = ctx.createLinearGradient(gx1, gy1, gx2, gy2);
                grad.addColorStop(0, '#ff0000'); grad.addColorStop(0.15, '#ff7f00'); grad.addColorStop(0.3, '#ffff00');
                grad.addColorStop(0.45, '#00ff00'); grad.addColorStop(0.6, '#0000ff'); grad.addColorStop(0.75, '#4b0082'); grad.addColorStop(1, '#9400d3');
                rankColor = grad;
            } else if (r.rate >= 2450) { // Cosmic
                rankFont = 'bold 20px Arial'; rankShadow = 'rgba(255, 0, 255, 0.9)'; rankBlur = 18;
                const grad = ctx.createLinearGradient(gx1, gy1, gx2, gy2);
                grad.addColorStop(0, '#ff00cc'); grad.addColorStop(0.5, '#3300ff'); grad.addColorStop(1, '#00ffff');
                rankColor = grad;
            } else if (r.rate >= 2400) { // Inferno
                rankFont = 'bold 20px Arial'; rankShadow = 'rgba(255, 69, 0, 0.9)'; rankBlur = 18;
                const grad = ctx.createLinearGradient(gx1, gy1, gx2, gy2);
                grad.addColorStop(0, '#ff4500'); grad.addColorStop(0.5, '#ff8c00'); grad.addColorStop(1, '#ffd700');
                rankColor = grad;
            } else if (r.rate >= 2350) { // Nature
                rankFont = 'bold 20px Arial'; rankShadow = 'rgba(0, 255, 127, 0.9)'; rankBlur = 16;
                const grad = ctx.createLinearGradient(gx1, gy1, gx2, gy2);
                grad.addColorStop(0, '#00ff7f'); grad.addColorStop(0.5, '#adff2f'); grad.addColorStop(1, '#f0fff0');
                rankColor = grad;
            } else if (r.rate >= 2300) { // Ice
                rankFont = 'bold 20px Arial'; rankShadow = 'rgba(0, 191, 255, 0.9)'; rankBlur = 16;
                const grad = ctx.createLinearGradient(gx1, gy1, gx2, gy2);
                grad.addColorStop(0, '#00bfff'); grad.addColorStop(0.5, '#1e90ff'); grad.addColorStop(1, '#ffffff');
                rankColor = grad;
            } else if (r.rate >= 2250) { // Darkness
                rankFont = 'bold 20px Arial'; rankShadow = 'rgba(255, 0, 0, 0.9)'; rankBlur = 16;
                const grad = ctx.createLinearGradient(gx1, gy1, gx2, gy2);
                grad.addColorStop(0, '#000000'); grad.addColorStop(0.5, '#8b0000'); grad.addColorStop(1, '#ff0000');
                rankColor = grad;
            } else if (r.rate >= 2200) { // Light
                rankFont = 'bold 20px Arial'; rankShadow = 'rgba(255, 215, 0, 0.9)'; rankBlur = 16;
                const grad = ctx.createLinearGradient(gx1, gy1, gx2, gy2);
                grad.addColorStop(0, '#fffacd'); grad.addColorStop(0.5, '#ffd700'); grad.addColorStop(1, '#ffffff');
                rankColor = grad;
            } else if (r.rate >= 2150) { // Cyber
                rankFont = 'bold 20px Arial'; rankShadow = 'rgba(255, 20, 147, 0.9)'; rankBlur = 15;
                const grad = ctx.createLinearGradient(gx1, gy1, gx2, gy2);
                grad.addColorStop(0, '#ff1493'); grad.addColorStop(0.5, '#00ffff'); grad.addColorStop(1, '#ff1493');
                rankColor = grad;
            } else if (r.rate >= 2100) { // Royal
                rankFont = 'bold 20px Arial'; rankShadow = 'rgba(148, 0, 211, 0.9)'; rankBlur = 15;
                const grad = ctx.createLinearGradient(gx1, gy1, gx2, gy2);
                grad.addColorStop(0, '#ffd700'); grad.addColorStop(0.5, '#9400d3'); grad.addColorStop(1, '#ffd700');
                rankColor = grad;
            } else if (r.rate >= 2050) { // Blood
                rankFont = 'bold 20px Arial'; rankShadow = 'rgba(139, 0, 0, 0.9)'; rankBlur = 15;
                const grad = ctx.createLinearGradient(gx1, gy1, gx2, gy2);
                grad.addColorStop(0, '#8b0000'); grad.addColorStop(0.5, '#ff0000'); grad.addColorStop(1, '#000000');
                rankColor = grad;
            } else if (r.rate >= 2000) { // Master
                rankFont = 'bold 20px Arial'; rankShadow = 'rgba(0, 0, 255, 0.9)'; rankBlur = 15;
                const grad = ctx.createLinearGradient(gx1, gy1, gx2, gy2);
                grad.addColorStop(0, '#ff0000'); grad.addColorStop(0.5, '#ffffff'); grad.addColorStop(1, '#0000ff');
                rankColor = grad;
            } else if (r.rate >= 1950) { // Crystal
                rankFont = 'bold 20px Arial'; rankShadow = 'rgba(0, 255, 255, 0.8)'; rankBlur = 14;
                const grad = ctx.createLinearGradient(gx1, gy1, gx2, gy2);
                grad.addColorStop(0, '#00ffff'); grad.addColorStop(1, '#ffffff');
                rankColor = grad;
            } else if (r.rate >= 1900) { // Obsidian
                rankFont = 'bold 20px Arial'; rankShadow = 'rgba(75, 0, 130, 0.8)'; rankBlur = 14;
                const grad = ctx.createLinearGradient(gx1, gy1, gx2, gy2);
                grad.addColorStop(0, '#4b0082'); grad.addColorStop(1, '#000000');
                rankColor = grad;
            } else if (r.rate >= 1850) { // Magma
                rankFont = 'bold 20px Arial'; rankShadow = 'rgba(255, 69, 0, 0.8)'; rankBlur = 14;
                const grad = ctx.createLinearGradient(gx1, gy1, gx2, gy2);
                grad.addColorStop(0, '#ff4500'); grad.addColorStop(1, '#ffff00');
                rankColor = grad;
            } else if (r.rate >= 1800) { // Forest
                rankFont = 'bold 20px Arial'; rankShadow = 'rgba(0, 128, 0, 0.8)'; rankBlur = 14;
                const grad = ctx.createLinearGradient(gx1, gy1, gx2, gy2);
                grad.addColorStop(0, '#006400'); grad.addColorStop(1, '#00ff00');
                rankColor = grad;
            } else if (r.rate >= 1750) { // Ocean
                rankFont = 'bold 20px Arial'; rankShadow = 'rgba(0, 191, 255, 0.8)'; rankBlur = 14;
                const grad = ctx.createLinearGradient(gx1, gy1, gx2, gy2);
                grad.addColorStop(0, '#00bfff'); grad.addColorStop(1, '#e0ffff');
                rankColor = grad;
            } else if (r.rate >= 1700) { // Gold
                rankFont = 'bold 20px Arial'; rankShadow = 'rgba(255, 215, 0, 0.8)'; rankBlur = 12;
                const grad = ctx.createLinearGradient(gx1, gy1, gx2, gy2);
                grad.addColorStop(0, '#ffd700'); grad.addColorStop(0.5, '#ffffff'); grad.addColorStop(1, '#ffd700');
                rankColor = grad;
            } else if (r.rate >= 1650) { // Pink
                rankFont = 'bold 20px Arial'; rankShadow = 'rgba(255, 0, 100, 0.8)'; rankBlur = 12;
                const grad = ctx.createLinearGradient(gx1, gy1, gx2, gy2);
                grad.addColorStop(0, '#fff'); grad.addColorStop(1, '#ff0066');
                rankColor = grad;
            } else if (r.rate >= 1600) { // Purple
                rankFont = 'bold 20px Arial'; rankShadow = 'rgba(138, 43, 226, 0.8)'; rankBlur = 12;
                const grad = ctx.createLinearGradient(gx1, gy1, gx2, gy2);
                grad.addColorStop(0, '#fff'); grad.addColorStop(1, '#8a2be2');
                rankColor = grad;
            } else if (r.rate >= 1550) { // Violet
                rankFont = 'bold 20px Arial'; rankShadow = '#d000ff'; rankBlur = 10;
                rankColor = '#fff';
            } else if (r.rate >= 1500) { // Cyan
                rankFont = 'bold 20px Arial'; rankShadow = '#00ffff'; rankBlur = 10;
                rankColor = '#fff';
            } else {
                if (r.isPlayer) rankColor = '#00d2ff';
                else if (r.rank===1) rankColor = '#ffd700';
                else if (r.rank===2) rankColor = '#c0c0c0';
                else if (r.rank===3) rankColor = '#cd7f32';
            }

            ctx.fillStyle = rankColor;
            ctx.shadowColor = rankShadow;
            ctx.shadowBlur = rankBlur;
            ctx.font = rankFont;
            
            ctx.fillText(`${r.rank}. ${r.name}`, canvas.width/2 - 150, y);
            ctx.textAlign = 'right';
            ctx.fillText(`Rate: ${r.rate}`, canvas.width/2 + 150, y);
            ctx.textAlign = 'left';
            ctx.restore();
        }
        ctx.restore();

        const closeBtn = { x: canvas.width/2 - 50, y: canvas.height - 80, w: 100, h: 40 };
        ctx.fillStyle = '#555'; ctx.fillRect(closeBtn.x, closeBtn.y, closeBtn.w, closeBtn.h);
        ctx.fillStyle = '#fff'; ctx.textAlign = 'center'; ctx.fillText('Close', closeBtn.x + closeBtn.w/2, closeBtn.y + 27);
    } else if (gameState === 'result') {
        ctx.fillStyle = 'rgba(0,0,0,0.8)';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = '#fff';
        ctx.font = '40px Arial'; ctx.textAlign = 'center';
        ctx.fillText('Result', canvas.width/2, canvas.height/2 - 120);
        
        ctx.font = '24px Arial'; ctx.textAlign = 'left';
        const bx = canvas.width/2 - 100;
        ctx.fillText(`Damage Dealt: ${Math.floor(player.damageDealt)}`, bx, canvas.height/2 - 50);
        ctx.fillText(`Healed: ${Math.floor(player.healedAmount)}`, bx, canvas.height/2);
        ctx.fillText(`Kills: ${player.kills}`, bx, canvas.height/2 + 50);
        ctx.fillText(`Rate: ${player.rate}`, bx, canvas.height/2 + 100);

        ctx.fillStyle = '#e74c3c'; ctx.fillRect(canvas.width/2 - 100, canvas.height/2 + 125, 200, 50);
        ctx.fillStyle = '#fff'; ctx.textAlign = 'center'; ctx.fillText('Back to Home', canvas.width/2, canvas.height/2 + 155);
    }
}

update();
</script>
</body>
</html>
